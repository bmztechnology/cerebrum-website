<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>core.training_manager &mdash; Cerebrum Forex Documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=9edc463e" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />


    <link rel="shortcut icon" href="../../_static/icon.ico" />
    <script src="../../_static/jquery.js?v=5d32c60e"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
    <script src="../../_static/documentation_options.js?v=8d563738"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
</head>

<body class="wy-body-for-nav">
    <div class="wy-grid-for-nav">
        <nav data-toggle="wy-nav-shift" class="wy-nav-side">
            <div class="wy-side-scroll">
                <div class="wy-side-nav-search" style="background: #1e293b">



                    <a href="/" class="icon icon-home">
                        Cerebrum Forex
                        <img src="../../_static/icon.ico" class="logo" alt="Logo" />
                    </a>
                    <div role="search">
                        <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
                            <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
                            <input type="hidden" name="check_keywords" value="yes" />
                            <input type="hidden" name="area" value="default" />
                        </form>
                    </div>
                </div>
                <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
                    <p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
                    <ul>
                        <li class="toctree-l1"><a class="reference internal"
                                href="../../installation.html">Installation</a>
                            <ul>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../installation.html#prerequisites">Prerequisites</a></li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../installation.html#installation-via-setup">Installation via Setup</a>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../installation.html#developer-installation">Developer Installation</a>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../installation.html#metatrader-5-configuration">MetaTrader 5
                                        Configuration</a></li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../installation.html#verifying-the-installation">Verifying the
                                        Installation</a></li>
                            </ul>
                        </li>
                        <li class="toctree-l1"><a class="reference internal" href="../../quickstart.html">Quick
                                Start</a>
                            <ul>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../quickstart.html#step-1-connect-to-mt5">Step 1: Connect to MT5</a>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../quickstart.html#step-2-data-extraction">Step 2: Data Extraction</a>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../quickstart.html#step-3-model-training">Step 3: Model Training</a>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../quickstart.html#step-4-predictions">Step 4: Predictions</a></li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../quickstart.html#signal-interpretation">Signal Interpretation</a>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../quickstart.html#next-steps">Next Steps</a></li>
                            </ul>
                        </li>
                        <li class="toctree-l1"><a class="reference internal" href="../../user_manual.html">Manuel
                                Fonctionnel - Cerebrum FX AI</a>
                            <ul>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../user_manual.html#table-des-matieres">Table des matières</a></li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../user_manual.html#dashboard">Dashboard</a>
                                    <ul>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../user_manual.html#sous-onglets-dashboard">Sous-onglets
                                                Dashboard</a></li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../user_manual.html#section-mt5-account-info">Section MT5
                                                Account Info</a></li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../user_manual.html#boutons-d-action">Boutons d’action</a></li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../user_manual.html#open-positions">Open Positions</a></li>
                                    </ul>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../user_manual.html#onglet-prediction">Onglet Prediction</a>
                                    <ul>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../user_manual.html#live-operations">Live Operations</a></li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../user_manual.html#signal">Signal</a></li>
                                    </ul>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../user_manual.html#ea-manager">EA Manager</a>
                                    <ul>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../user_manual.html#onglet-order">Onglet Order</a></li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../user_manual.html#onglet-position">Onglet Position</a></li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../user_manual.html#onglet-risk">Onglet Risk</a></li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../user_manual.html#onglet-prop-firm">Onglet Prop Firm</a></li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../user_manual.html#onglet-trailing">Onglet Trailing</a></li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../user_manual.html#onglet-ea-logs">Onglet EA Logs</a></li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../user_manual.html#onglet-ea-analytics">Onglet EA
                                                Analytics</a></li>
                                    </ul>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../user_manual.html#dashboard-sous-onglets">Dashboard -
                                        Sous-onglets</a>
                                    <ul>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../user_manual.html#onglet-calendar">Onglet Calendar</a></li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../user_manual.html#onglet-signals-chart">Onglet
                                                Signals-Chart</a></li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../user_manual.html#onglet-trading">Onglet Trading</a></li>
                                    </ul>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../user_manual.html#extraction">Extraction</a>
                                    <ul>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../user_manual.html#ohlc-files-tab">OHLC Files Tab</a></li>
                                    </ul>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../user_manual.html#indicators">Indicators</a>
                                    <ul>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../user_manual.html#categories">Catégories</a></li>
                                    </ul>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../user_manual.html#training">Training</a>
                                    <ul>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../user_manual.html#training-pipeline">Training Pipeline</a>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../user_manual.html#boutons">Boutons</a></li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../user_manual.html#model-status">Model Status</a></li>
                                    </ul>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../user_manual.html#settings">Settings</a>
                                    <ul>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../user_manual.html#onglet-general">Onglet General</a></li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../user_manual.html#onglet-data-paths">Onglet Data Paths</a>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../user_manual.html#onglet-ai-signals">Onglet AI Signals</a>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../user_manual.html#onglet-logic-tuning">Onglet Logic
                                                Tuning</a></li>
                                    </ul>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../user_manual.html#raccourcis-et-bonnes-pratiques">Raccourcis et
                                        bonnes pratiques</a>
                                    <ul>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../user_manual.html#workflow-recommande">Workflow
                                                recommandé</a></li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../user_manual.html#tips-prop-firm">Tips Prop Firm</a></li>
                                    </ul>
                                </li>
                            </ul>
                        </li>
                    </ul>
                    <p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
                    <ul>
                        <li class="toctree-l1"><a class="reference internal" href="../../api/core.html">Core Module
                                Reference</a>
                            <ul>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../api/core.html#module-core.mt5_connector">MT5 Connector</a>
                                    <ul>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.mt5_connector.MT5Connector"><code
                                                    class="docutils literal notranslate"><span class="pre">MT5Connector</span></code></a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.mt5_connector.MT5Connector.add_callback"><code
                                                            class="docutils literal notranslate"><span class="pre">MT5Connector.add_callback()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.mt5_connector.MT5Connector.close_all_positions"><code
                                                            class="docutils literal notranslate"><span class="pre">MT5Connector.close_all_positions()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.mt5_connector.MT5Connector.connect"><code
                                                            class="docutils literal notranslate"><span class="pre">MT5Connector.connect()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.mt5_connector.MT5Connector.check_health"><code
                                                            class="docutils literal notranslate"><span class="pre">MT5Connector.check_health()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.mt5_connector.MT5Connector.disconnect"><code
                                                            class="docutils literal notranslate"><span class="pre">MT5Connector.disconnect()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.mt5_connector.MT5Connector.test_connection"><code
                                                            class="docutils literal notranslate"><span class="pre">MT5Connector.test_connection()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.mt5_connector.MT5Connector.preload_history"><code
                                                            class="docutils literal notranslate"><span class="pre">MT5Connector.preload_history()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.mt5_connector.MT5Connector.get_terminal_data_path"><code
                                                            class="docutils literal notranslate"><span class="pre">MT5Connector.get_terminal_data_path()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.mt5_connector.MT5Connector.get_current_server_time"><code
                                                            class="docutils literal notranslate"><span class="pre">MT5Connector.get_current_server_time()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.mt5_connector.MT5Connector.get_server_time"><code
                                                            class="docutils literal notranslate"><span class="pre">MT5Connector.get_server_time()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.mt5_connector.MT5Connector.get_time_offset"><code
                                                            class="docutils literal notranslate"><span class="pre">MT5Connector.get_time_offset()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.mt5_connector.MT5Connector.get_account_info"><code
                                                            class="docutils literal notranslate"><span class="pre">MT5Connector.get_account_info()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.mt5_connector.MT5Connector.get_market_status"><code
                                                            class="docutils literal notranslate"><span class="pre">MT5Connector.get_market_status()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.mt5_connector.MT5Connector.get_ohlc_path"><code
                                                            class="docutils literal notranslate"><span class="pre">MT5Connector.get_ohlc_path()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.mt5_connector.MT5Connector.extract_ohlc"><code
                                                            class="docutils literal notranslate"><span class="pre">MT5Connector.extract_ohlc()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.mt5_connector.MT5Connector.update_all_ohlc"><code
                                                            class="docutils literal notranslate"><span class="pre">MT5Connector.update_all_ohlc()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.mt5_connector.MT5Connector.get_buffer"><code
                                                            class="docutils literal notranslate"><span class="pre">MT5Connector.get_buffer()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.mt5_connector.MT5Connector.get_latest_candles"><code
                                                            class="docutils literal notranslate"><span class="pre">MT5Connector.get_latest_candles()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.mt5_connector.MT5Connector.load_ohlc"><code
                                                            class="docutils literal notranslate"><span class="pre">MT5Connector.load_ohlc()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.mt5_connector.MT5Connector.load_ohlc_buffer"><code
                                                            class="docutils literal notranslate"><span class="pre">MT5Connector.load_ohlc_buffer()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.mt5_connector.MT5Connector.get_ohlc_status"><code
                                                            class="docutils literal notranslate"><span class="pre">MT5Connector.get_ohlc_status()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.mt5_connector.MT5Connector.extract_all"><code
                                                            class="docutils literal notranslate"><span class="pre">MT5Connector.extract_all()</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.mt5_connector.get_mt5_connector"><code
                                                    class="docutils literal notranslate"><span class="pre">get_mt5_connector()</span></code></a>
                                        </li>
                                    </ul>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../api/core.html#module-core.prediction_engine">Prediction Engine</a>
                                    <ul>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.prediction_engine.PredictionEngine"><code
                                                    class="docutils literal notranslate"><span class="pre">PredictionEngine</span></code></a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.prediction_engine.PredictionEngine.add_callback"><code
                                                            class="docutils literal notranslate"><span class="pre">PredictionEngine.add_callback()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.prediction_engine.PredictionEngine.remove_callback"><code
                                                            class="docutils literal notranslate"><span class="pre">PredictionEngine.remove_callback()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.prediction_engine.PredictionEngine.get_signal_path"><code
                                                            class="docutils literal notranslate"><span class="pre">PredictionEngine.get_signal_path()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.prediction_engine.PredictionEngine.get_enabled_models"><code
                                                            class="docutils literal notranslate"><span class="pre">PredictionEngine.get_enabled_models()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.prediction_engine.PredictionEngine.predict_timeframe"><code
                                                            class="docutils literal notranslate"><span class="pre">PredictionEngine.predict_timeframe()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.prediction_engine.PredictionEngine.load_signal"><code
                                                            class="docutils literal notranslate"><span class="pre">PredictionEngine.load_signal()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.prediction_engine.PredictionEngine.reset_engine"><code
                                                            class="docutils literal notranslate"><span class="pre">PredictionEngine.reset_engine()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.prediction_engine.PredictionEngine.predict_all"><code
                                                            class="docutils literal notranslate"><span class="pre">PredictionEngine.predict_all()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.prediction_engine.PredictionEngine.get_prediction_status"><code
                                                            class="docutils literal notranslate"><span class="pre">PredictionEngine.get_prediction_status()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.prediction_engine.PredictionEngine.get_combined_signal"><code
                                                            class="docutils literal notranslate"><span class="pre">PredictionEngine.get_combined_signal()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.prediction_engine.PredictionEngine.get_congress_history"><code
                                                            class="docutils literal notranslate"><span class="pre">PredictionEngine.get_congress_history()</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                    </ul>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../api/core.html#module-core.training_manager">Training Manager</a>
                                    <ul>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.training_manager.TrainingLogBridge"><code
                                                    class="docutils literal notranslate"><span class="pre">TrainingLogBridge</span></code></a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.training_manager.TrainingLogBridge.emit"><code
                                                            class="docutils literal notranslate"><span class="pre">TrainingLogBridge.emit()</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.training_manager.RecoveryRequired"><code
                                                    class="docutils literal notranslate"><span class="pre">RecoveryRequired</span></code></a>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.training_manager.TrainingManager"><code
                                                    class="docutils literal notranslate"><span class="pre">TrainingManager</span></code></a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.training_manager.TrainingManager.add_callback"><code
                                                            class="docutils literal notranslate"><span class="pre">TrainingManager.add_callback()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.training_manager.TrainingManager.get_model"><code
                                                            class="docutils literal notranslate"><span class="pre">TrainingManager.get_model()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.training_manager.TrainingManager.get_normalizer"><code
                                                            class="docutils literal notranslate"><span class="pre">TrainingManager.get_normalizer()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.training_manager.TrainingManager.get_training_status"><code
                                                            class="docutils literal notranslate"><span class="pre">TrainingManager.get_training_status()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.training_manager.TrainingManager.should_train_incremental"><code
                                                            class="docutils literal notranslate"><span class="pre">TrainingManager.should_train_incremental()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.training_manager.TrainingManager.prepare_training_data"><code
                                                            class="docutils literal notranslate"><span class="pre">TrainingManager.prepare_training_data()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.training_manager.TrainingManager.train_timeframe"><code
                                                            class="docutils literal notranslate"><span class="pre">TrainingManager.train_timeframe()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.training_manager.TrainingManager.train_all"><code
                                                            class="docutils literal notranslate"><span class="pre">TrainingManager.train_all()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.training_manager.TrainingManager.train_with_drift_check"><code
                                                            class="docutils literal notranslate"><span class="pre">TrainingManager.train_with_drift_check()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.training_manager.TrainingManager.start_scheduled_training"><code
                                                            class="docutils literal notranslate"><span class="pre">TrainingManager.start_scheduled_training()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.training_manager.TrainingManager.stop_scheduled_training"><code
                                                            class="docutils literal notranslate"><span class="pre">TrainingManager.stop_scheduled_training()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.training_manager.TrainingManager.load_all_models"><code
                                                            class="docutils literal notranslate"><span class="pre">TrainingManager.load_all_models()</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                    </ul>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../api/core.html#module-core.feature_engine">Feature Engine</a>
                                    <ul>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.feature_engine.FeatureEngine"><code
                                                    class="docutils literal notranslate"><span class="pre">FeatureEngine</span></code></a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.feature_engine.FeatureEngine.calculate_all_features"><code
                                                            class="docutils literal notranslate"><span class="pre">FeatureEngine.calculate_all_features()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.feature_engine.FeatureEngine.get_feature_columns"><code
                                                            class="docutils literal notranslate"><span class="pre">FeatureEngine.get_feature_columns()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.feature_engine.FeatureEngine.select_best_features"><code
                                                            class="docutils literal notranslate"><span class="pre">FeatureEngine.select_best_features()</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                    </ul>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../api/core.html#module-core.app_controller">App Controller</a>
                                    <ul>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.app_controller.AppController"><code
                                                    class="docutils literal notranslate"><span class="pre">AppController</span></code></a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.app_controller.AppController.mt5"><code
                                                            class="docutils literal notranslate"><span class="pre">AppController.mt5</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.app_controller.AppController.training_manager"><code
                                                            class="docutils literal notranslate"><span class="pre">AppController.training_manager</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.app_controller.AppController.prediction_engine"><code
                                                            class="docutils literal notranslate"><span class="pre">AppController.prediction_engine</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.app_controller.AppController.scheduler"><code
                                                            class="docutils literal notranslate"><span class="pre">AppController.scheduler</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.app_controller.AppController.start"><code
                                                            class="docutils literal notranslate"><span class="pre">AppController.start()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.app_controller.AppController.stop"><code
                                                            class="docutils literal notranslate"><span class="pre">AppController.stop()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.app_controller.AppController.extract_all"><code
                                                            class="docutils literal notranslate"><span class="pre">AppController.extract_all()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.app_controller.AppController.predict_manual"><code
                                                            class="docutils literal notranslate"><span class="pre">AppController.predict_manual()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.app_controller.AppController.train_all"><code
                                                            class="docutils literal notranslate"><span class="pre">AppController.train_all()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.app_controller.AppController.predict_all"><code
                                                            class="docutils literal notranslate"><span class="pre">AppController.predict_all()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.app_controller.AppController.get_signal"><code
                                                            class="docutils literal notranslate"><span class="pre">AppController.get_signal()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.app_controller.AppController.get_combined_signal"><code
                                                            class="docutils literal notranslate"><span class="pre">AppController.get_combined_signal()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.app_controller.AppController.get_ohlc_status"><code
                                                            class="docutils literal notranslate"><span class="pre">AppController.get_ohlc_status()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.app_controller.AppController.get_training_status"><code
                                                            class="docutils literal notranslate"><span class="pre">AppController.get_training_status()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.app_controller.AppController.get_model"><code
                                                            class="docutils literal notranslate"><span class="pre">AppController.get_model()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.app_controller.AppController.get_settings"><code
                                                            class="docutils literal notranslate"><span class="pre">AppController.get_settings()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.app_controller.AppController.get_cached_account_info"><code
                                                            class="docutils literal notranslate"><span class="pre">AppController.get_cached_account_info()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.app_controller.AppController.save_settings"><code
                                                            class="docutils literal notranslate"><span class="pre">AppController.save_settings()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.app_controller.AppController.get_congress_config"><code
                                                            class="docutils literal notranslate"><span class="pre">AppController.get_congress_config()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.app_controller.AppController.save_congress_config"><code
                                                            class="docutils literal notranslate"><span class="pre">AppController.save_congress_config()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.app_controller.AppController.update_scheduler_config"><code
                                                            class="docutils literal notranslate"><span class="pre">AppController.update_scheduler_config()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.app_controller.AppController.sync_ea_config"><code
                                                            class="docutils literal notranslate"><span class="pre">AppController.sync_ea_config()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.app_controller.AppController.log_training_event"><code
                                                            class="docutils literal notranslate"><span class="pre">AppController.log_training_event()</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                    </ul>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../api/core.html#module-core.noble_kpi">Noble KPI</a>
                                    <ul>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#noble-safe-range-kpi-core-module">Noble Safe
                                                Range KPI - Core Module</a></li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.noble_kpi.MarketRegime"><code
                                                    class="docutils literal notranslate"><span class="pre">MarketRegime</span></code></a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.noble_kpi.MarketRegime.NORMAL"><code
                                                            class="docutils literal notranslate"><span class="pre">MarketRegime.NORMAL</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.noble_kpi.MarketRegime.LOW_VOL"><code
                                                            class="docutils literal notranslate"><span class="pre">MarketRegime.LOW_VOL</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.noble_kpi.MarketRegime.HIGH_VOL"><code
                                                            class="docutils literal notranslate"><span class="pre">MarketRegime.HIGH_VOL</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.noble_kpi.MarketRegime.CRISIS"><code
                                                            class="docutils literal notranslate"><span class="pre">MarketRegime.CRISIS</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.noble_kpi.calculate_atr_series"><code
                                                    class="docutils literal notranslate"><span class="pre">calculate_atr_series()</span></code></a>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.noble_kpi.detect_regime_series"><code
                                                    class="docutils literal notranslate"><span class="pre">detect_regime_series()</span></code></a>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.noble_kpi.calculate_atr"><code
                                                    class="docutils literal notranslate"><span class="pre">calculate_atr()</span></code></a>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.noble_kpi.detect_regime"><code
                                                    class="docutils literal notranslate"><span class="pre">detect_regime()</span></code></a>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.noble_kpi.noble_safe_range"><code
                                                    class="docutils literal notranslate"><span class="pre">noble_safe_range()</span></code></a>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.noble_kpi.calculate_position"><code
                                                    class="docutils literal notranslate"><span class="pre">calculate_position()</span></code></a>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.noble_kpi.get_recommendation"><code
                                                    class="docutils literal notranslate"><span class="pre">get_recommendation()</span></code></a>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.noble_kpi.analyze_timeframe"><code
                                                    class="docutils literal notranslate"><span class="pre">analyze_timeframe()</span></code></a>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.noble_kpi.validate_kpi"><code
                                                    class="docutils literal notranslate"><span class="pre">validate_kpi()</span></code></a>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.noble_kpi.calculate_noble_bias"><code
                                                    class="docutils literal notranslate"><span class="pre">calculate_noble_bias()</span></code></a>
                                        </li>
                                    </ul>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../api/core.html#module-core.congress_engine">Congress Engine</a>
                                    <ul>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.congress_engine.AladdinPersona"><code
                                                    class="docutils literal notranslate"><span class="pre">AladdinPersona</span></code></a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.AladdinPersona.QUANT"><code
                                                            class="docutils literal notranslate"><span class="pre">AladdinPersona.QUANT</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.AladdinPersona.ARCHIVIST"><code
                                                            class="docutils literal notranslate"><span class="pre">AladdinPersona.ARCHIVIST</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.AladdinPersona.FUTURIST"><code
                                                            class="docutils literal notranslate"><span class="pre">AladdinPersona.FUTURIST</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.AladdinPersona.GUARDIAN"><code
                                                            class="docutils literal notranslate"><span class="pre">AladdinPersona.GUARDIAN</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.AladdinPersona.LEADER"><code
                                                            class="docutils literal notranslate"><span class="pre">AladdinPersona.LEADER</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.AladdinPersona.SENTINEL"><code
                                                            class="docutils literal notranslate"><span class="pre">AladdinPersona.SENTINEL</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.congress_engine.ModelPrediction"><code
                                                    class="docutils literal notranslate"><span class="pre">ModelPrediction</span></code></a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.ModelPrediction.model_name"><code
                                                            class="docutils literal notranslate"><span class="pre">ModelPrediction.model_name</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.ModelPrediction.model_role"><code
                                                            class="docutils literal notranslate"><span class="pre">ModelPrediction.model_role</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.ModelPrediction.score"><code
                                                            class="docutils literal notranslate"><span class="pre">ModelPrediction.score</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.ModelPrediction.confidence"><code
                                                            class="docutils literal notranslate"><span class="pre">ModelPrediction.confidence</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.ModelPrediction.regime"><code
                                                            class="docutils literal notranslate"><span class="pre">ModelPrediction.regime</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.ModelPrediction.timeframe"><code
                                                            class="docutils literal notranslate"><span class="pre">ModelPrediction.timeframe</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.ModelPrediction.timestamp"><code
                                                            class="docutils literal notranslate"><span class="pre">ModelPrediction.timestamp</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.congress_engine.CongressDecision"><code
                                                    class="docutils literal notranslate"><span class="pre">CongressDecision</span></code></a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressDecision.final_signal"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressDecision.final_signal</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressDecision.final_score"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressDecision.final_score</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressDecision.final_confidence"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressDecision.final_confidence</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressDecision.detected_regime"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressDecision.detected_regime</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressDecision.certainty_boost"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressDecision.certainty_boost</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressDecision.flux_boost"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressDecision.flux_boost</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressDecision.trend_certainty"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressDecision.trend_certainty</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressDecision.duration_tf5"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressDecision.duration_tf5</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressDecision.threshold"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressDecision.threshold</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressDecision.model_predictions"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressDecision.model_predictions</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressDecision.flux_details"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressDecision.flux_details</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressDecision.weights_applied"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressDecision.weights_applied</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressDecision.timestamp"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressDecision.timestamp</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressDecision.override_type"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressDecision.override_type</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressDecision.to_dict"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressDecision.to_dict()</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.congress_engine.CongressEngine"><code
                                                    class="docutils literal notranslate"><span class="pre">CongressEngine</span></code></a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressEngine.CONGRESS_WEIGHTS"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressEngine.CONGRESS_WEIGHTS</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressEngine.DEFAULT_WEIGHTS"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressEngine.DEFAULT_WEIGHTS</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressEngine.BASE_THRESHOLD"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressEngine.BASE_THRESHOLD</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressEngine.LAMBDA"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressEngine.LAMBDA</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressEngine.KPI_GAMMA"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressEngine.KPI_GAMMA</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressEngine.CERTAINTY_BONUS"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressEngine.CERTAINTY_BONUS</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressEngine.__init__"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressEngine.__init__()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressEngine.detect_market_regime"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressEngine.detect_market_regime()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressEngine.calculate_adaptive_threshold"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressEngine.calculate_adaptive_threshold()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressEngine.get_weights"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressEngine.get_weights()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressEngine.aggregate"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressEngine.aggregate()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressEngine.get_decision_history"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressEngine.get_decision_history()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressEngine.simple_aggregate"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressEngine.simple_aggregate()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressEngine.make_decision_batch"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressEngine.make_decision_batch()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressEngine.aggregate_with_regime"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressEngine.aggregate_with_regime()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressEngine.full_aggregate"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressEngine.full_aggregate()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressEngine.save_prediction_json"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressEngine.save_prediction_json()</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.congress_engine.get_congress_engine"><code
                                                    class="docutils literal notranslate"><span class="pre">get_congress_engine()</span></code></a>
                                        </li>
                                    </ul>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../api/core.html#module-core.model_scorer">Model Scorer</a>
                                    <ul>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.model_scorer.PredictionOutcome"><code
                                                    class="docutils literal notranslate"><span class="pre">PredictionOutcome</span></code></a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.model_scorer.PredictionOutcome.model_name"><code
                                                            class="docutils literal notranslate"><span class="pre">PredictionOutcome.model_name</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.model_scorer.PredictionOutcome.timeframe"><code
                                                            class="docutils literal notranslate"><span class="pre">PredictionOutcome.timeframe</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.model_scorer.PredictionOutcome.predicted_signal"><code
                                                            class="docutils literal notranslate"><span class="pre">PredictionOutcome.predicted_signal</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.model_scorer.PredictionOutcome.actual_outcome"><code
                                                            class="docutils literal notranslate"><span class="pre">PredictionOutcome.actual_outcome</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.model_scorer.PredictionOutcome.confidence"><code
                                                            class="docutils literal notranslate"><span class="pre">PredictionOutcome.confidence</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.model_scorer.PredictionOutcome.timestamp"><code
                                                            class="docutils literal notranslate"><span class="pre">PredictionOutcome.timestamp</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.model_scorer.ModelScorer"><code
                                                    class="docutils literal notranslate"><span class="pre">ModelScorer</span></code></a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.model_scorer.ModelScorer.HISTORY_SIZE"><code
                                                            class="docutils literal notranslate"><span class="pre">ModelScorer.HISTORY_SIZE</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.model_scorer.ModelScorer.MIN_SAMPLES"><code
                                                            class="docutils literal notranslate"><span class="pre">ModelScorer.MIN_SAMPLES</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.model_scorer.ModelScorer.DYNAMIC_WEIGHT"><code
                                                            class="docutils literal notranslate"><span class="pre">ModelScorer.DYNAMIC_WEIGHT</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.model_scorer.ModelScorer.EMA_ALPHA"><code
                                                            class="docutils literal notranslate"><span class="pre">ModelScorer.EMA_ALPHA</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.model_scorer.ModelScorer.record_outcome"><code
                                                            class="docutils literal notranslate"><span class="pre">ModelScorer.record_outcome()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.model_scorer.ModelScorer.get_dynamic_weights"><code
                                                            class="docutils literal notranslate"><span class="pre">ModelScorer.get_dynamic_weights()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.model_scorer.ModelScorer.get_model_stats"><code
                                                            class="docutils literal notranslate"><span class="pre">ModelScorer.get_model_stats()</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.model_scorer.get_model_scorer"><code
                                                    class="docutils literal notranslate"><span class="pre">get_model_scorer()</span></code></a>
                                        </li>
                                    </ul>
                                </li>
                            </ul>
                        </li>
                        <li class="toctree-l1"><a class="reference internal" href="../../api/models.html">Models
                                Reference</a>
                            <ul>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../api/models.html#module-models.xgboost_model">XGBoost Model</a>
                                    <ul>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/models.html#models.xgboost_model.XGBoostModel"><code
                                                    class="docutils literal notranslate"><span class="pre">XGBoostModel</span></code></a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/models.html#models.xgboost_model.XGBoostModel.name"><code
                                                            class="docutils literal notranslate"><span class="pre">XGBoostModel.name</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/models.html#models.xgboost_model.XGBoostModel.train"><code
                                                            class="docutils literal notranslate"><span class="pre">XGBoostModel.train()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/models.html#models.xgboost_model.XGBoostModel.predict"><code
                                                            class="docutils literal notranslate"><span class="pre">XGBoostModel.predict()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/models.html#models.xgboost_model.XGBoostModel.load"><code
                                                            class="docutils literal notranslate"><span class="pre">XGBoostModel.load()</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                    </ul>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../api/models.html#module-models.lightgbm_model">LightGBM Model</a>
                                    <ul>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/models.html#models.lightgbm_model.LightGBMModel"><code
                                                    class="docutils literal notranslate"><span class="pre">LightGBMModel</span></code></a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/models.html#models.lightgbm_model.LightGBMModel.name"><code
                                                            class="docutils literal notranslate"><span class="pre">LightGBMModel.name</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/models.html#models.lightgbm_model.LightGBMModel.train"><code
                                                            class="docutils literal notranslate"><span class="pre">LightGBMModel.train()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/models.html#models.lightgbm_model.LightGBMModel.predict"><code
                                                            class="docutils literal notranslate"><span class="pre">LightGBMModel.predict()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/models.html#models.lightgbm_model.LightGBMModel.load"><code
                                                            class="docutils literal notranslate"><span class="pre">LightGBMModel.load()</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                    </ul>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../api/models.html#module-models.randomforest_model">RandomForest
                                        Model</a>
                                    <ul>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/models.html#models.randomforest_model.RandomForestModel"><code
                                                    class="docutils literal notranslate"><span class="pre">RandomForestModel</span></code></a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/models.html#models.randomforest_model.RandomForestModel.name"><code
                                                            class="docutils literal notranslate"><span class="pre">RandomForestModel.name</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/models.html#models.randomforest_model.RandomForestModel.train"><code
                                                            class="docutils literal notranslate"><span class="pre">RandomForestModel.train()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/models.html#models.randomforest_model.RandomForestModel.predict"><code
                                                            class="docutils literal notranslate"><span class="pre">RandomForestModel.predict()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/models.html#models.randomforest_model.RandomForestModel.load"><code
                                                            class="docutils literal notranslate"><span class="pre">RandomForestModel.load()</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                    </ul>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../api/models.html#module-models.stacking_model">Stacking Model</a>
                                    <ul>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/models.html#models.stacking_model.StackingModel"><code
                                                    class="docutils literal notranslate"><span class="pre">StackingModel</span></code></a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/models.html#models.stacking_model.StackingModel.name"><code
                                                            class="docutils literal notranslate"><span class="pre">StackingModel.name</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/models.html#models.stacking_model.StackingModel.train"><code
                                                            class="docutils literal notranslate"><span class="pre">StackingModel.train()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/models.html#models.stacking_model.StackingModel.predict"><code
                                                            class="docutils literal notranslate"><span class="pre">StackingModel.predict()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/models.html#models.stacking_model.StackingModel.load"><code
                                                            class="docutils literal notranslate"><span class="pre">StackingModel.load()</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                    </ul>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../api/models.html#module-models.meta_model">Meta Model</a>
                                    <ul>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/models.html#models.meta_model.MetaModel"><code
                                                    class="docutils literal notranslate"><span class="pre">MetaModel</span></code></a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/models.html#models.meta_model.MetaModel.prepare_meta_features"><code
                                                            class="docutils literal notranslate"><span class="pre">MetaModel.prepare_meta_features()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/models.html#models.meta_model.MetaModel.train"><code
                                                            class="docutils literal notranslate"><span class="pre">MetaModel.train()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/models.html#models.meta_model.MetaModel.predict_viability"><code
                                                            class="docutils literal notranslate"><span class="pre">MetaModel.predict_viability()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/models.html#models.meta_model.MetaModel.save"><code
                                                            class="docutils literal notranslate"><span class="pre">MetaModel.save()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/models.html#models.meta_model.MetaModel.load"><code
                                                            class="docutils literal notranslate"><span class="pre">MetaModel.load()</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                    </ul>
                                </li>
                            </ul>
                        </li>
                        <li class="toctree-l1"><a class="reference internal" href="../../api/gui.html">GUI Reference</a>
                            <ul>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../api/gui.html#module-gui.main_window">Main Window</a>
                                    <ul>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/gui.html#gui.main_window.MainWindow"><code
                                                    class="docutils literal notranslate"><span class="pre">MainWindow</span></code></a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/gui.html#gui.main_window.MainWindow.status_changed"><code
                                                            class="docutils literal notranslate"><span class="pre">MainWindow.status_changed</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/gui.html#gui.main_window.MainWindow.update_signal_display"><code
                                                            class="docutils literal notranslate"><span class="pre">MainWindow.update_signal_display()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/gui.html#gui.main_window.MainWindow.closeEvent"><code
                                                            class="docutils literal notranslate"><span class="pre">MainWindow.closeEvent()</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                    </ul>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../api/gui.html#panels">Panels</a>
                                    <ul>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/gui.html#module-gui.panels.dashboard_panel">Dashboard
                                                Panel</a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/gui.html#gui.panels.dashboard_panel.PredictionWorker"><code
                                                            class="docutils literal notranslate"><span class="pre">PredictionWorker</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/gui.html#gui.panels.dashboard_panel.DashboardPanel"><code
                                                            class="docutils literal notranslate"><span class="pre">DashboardPanel</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/gui.html#module-gui.panels.extraction_panel">Extraction
                                                Panel</a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/gui.html#gui.panels.extraction_panel.ExtractionPanel"><code
                                                            class="docutils literal notranslate"><span class="pre">ExtractionPanel</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/gui.html#module-gui.panels.training_panel">Training
                                                Panel</a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/gui.html#gui.panels.training_panel.TrainingSignals"><code
                                                            class="docutils literal notranslate"><span class="pre">TrainingSignals</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/gui.html#gui.panels.training_panel.PhaseCard"><code
                                                            class="docutils literal notranslate"><span class="pre">PhaseCard</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/gui.html#gui.panels.training_panel.TrainingPanel"><code
                                                            class="docutils literal notranslate"><span class="pre">TrainingPanel</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/gui.html#gui.panels.training_panel.SchedulerDialog"><code
                                                            class="docutils literal notranslate"><span class="pre">SchedulerDialog</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/gui.html#module-gui.panels.prediction_panel">Prediction
                                                Panel</a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/gui.html#gui.panels.prediction_panel.PredictionPanel"><code
                                                            class="docutils literal notranslate"><span class="pre">PredictionPanel</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/gui.html#module-gui.panels.settings_panel">Settings
                                                Panel</a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/gui.html#gui.panels.settings_panel.SettingsPanel"><code
                                                            class="docutils literal notranslate"><span class="pre">SettingsPanel</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                    </ul>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../api/gui.html#workers">Workers</a>
                                    <ul>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/gui.html#module-gui.workers.prediction_worker">Prediction
                                                Worker</a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/gui.html#gui.workers.prediction_worker.PredictionWorker"><code
                                                            class="docutils literal notranslate"><span class="pre">PredictionWorker</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                    </ul>
                                </li>
                            </ul>
                        </li>
                    </ul>
                    <p class="caption" role="heading"><span class="caption-text">Resources</span></p>
                    <ul>
                        <li class="toctree-l1"><a class="reference internal" href="../../changelog.html">Changelog</a>
                            <ul>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../changelog.html#version-1-0-0-january-2026">Version 1.0.0 (January
                                        2026)</a>
                                    <ul>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../changelog.html#new-features">New Features</a></li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../changelog.html#improvements">Improvements</a></li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../changelog.html#bug-fixes">Bug Fixes</a></li>
                                    </ul>
                                </li>
                            </ul>
                        </li>
                        <li class="toctree-l1"><a class="reference internal"
                                href="../../contributing.html">Contributing</a>
                            <ul>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../contributing.html#how-to-contribute">How to Contribute</a></li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../contributing.html#code-style">Code Style</a></li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../contributing.html#reporting-bugs">Reporting Bugs</a></li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../contributing.html#contact">Contact</a></li>
                            </ul>
                        </li>
                        <li class="toctree-l1"><a class="reference internal" href="../../sphinx_tech.html">Sphinx
                                Documentation System</a>
                            <ul>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../sphinx_tech.html#sphinx-engine">⚙️ Sphinx Engine</a></li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../sphinx_tech.html#parsing">🔍 Parsing</a></li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../sphinx_tech.html#reference-resolution">🔗 Reference Resolution</a>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../sphinx_tech.html#tree-generation-rtd-theme">🌳 Tree Generation (RTD
                                        Theme)</a></li>
                            </ul>
                        </li>
                    </ul>

                </div>
            </div>
        </nav>

        <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
            <nav class="wy-nav-top" aria-label="Mobile navigation menu" style="background: #1e293b">
                <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
                <a href="../../index.html">Cerebrum Forex</a>
            </nav>

            <div class="wy-nav-content">
                <div class="rst-content">
                    <div role="navigation" aria-label="Page navigation">
                        <ul class="wy-breadcrumbs">
                            <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
                            <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
                            <li class="breadcrumb-item active">core.training_manager</li>
                            <li class="wy-breadcrumbs-aside">
                            </li>
                        </ul>
                        <hr />
                    </div>
                    <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
                        <div itemprop="articleBody">

                            <h1>Source code for core.training_manager</h1>
                            <div class="highlight">
                                <pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Cerebrum Forex - Training Manager V2</span>
<span class="sd">Orchestrates model training with KPI-based labeling, walk-forward validation,</span>
<span class="sd">and Congress Engine integration.</span>

<span class="sd">Key features:</span>
<span class="sd">- KPI-based labeling (Noble Safe Range)</span>
<span class="sd">- Quantile feature normalization</span>
<span class="sd">- Walk-forward cross-validation</span>
<span class="sd">- Weighted loss (NEUTRAL penalized)</span>
<span class="sd">- Drift detection for conditional retraining</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">threading</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">config.settings</span><span class="w"> </span><span class="kn">import</span> <span class="n">TIMEFRAMES</span><span class="p">,</span> <span class="n">MODELS_DIR</span><span class="p">,</span> <span class="n">TIMEFRAME_NAMES</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">core.mt5_connector</span><span class="w"> </span><span class="kn">import</span> <span class="n">MT5Connector</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">core.feature_engine</span><span class="w"> </span><span class="kn">import</span> <span class="n">FeatureEngine</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">core.labeling_engine</span><span class="w"> </span><span class="kn">import</span> <span class="n">LabelingEngine</span><span class="p">,</span> <span class="n">get_labeling_engine</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">core.feature_normalizer</span><span class="w"> </span><span class="kn">import</span> <span class="n">FeatureNormalizer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">core.walk_forward</span><span class="w"> </span><span class="kn">import</span> <span class="n">WalkForwardValidator</span><span class="p">,</span> <span class="n">get_walk_forward_validator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">core.drift_detector</span><span class="w"> </span><span class="kn">import</span> <span class="n">DriftDetector</span><span class="p">,</span> <span class="n">get_drift_detector</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">database</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_database</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">models.xgboost_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">XGBoostModel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">models.lightgbm_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">LightGBMModel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">models.randomforest_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">RandomForestModel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">models.catboost_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">CatBoostModel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">models.stacking_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">StackingModel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">models.meta_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">MetaModel</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">core.regime_detector</span><span class="w"> </span><span class="kn">import</span> <span class="n">RegimeDetector</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">core.audit_cache</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_audit_cache</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">core.debug_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_debug_manager</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">core.model_validator</span><span class="w"> </span><span class="kn">import</span> <span class="n">ModelValidator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">core.sentinel</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_sentinel</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># --- GLOBAL RANDOM SEED FOR REPRODUCIBILITY ---</span>
<span class="n">RANDOM_SEED</span> <span class="o">=</span> <span class="mi">42</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">RANDOM_SEED</span><span class="p">)</span>

<div class="viewcode-block" id="TrainingLogBridge">
<a class="viewcode-back" href="../../api/core.html#core.training_manager.TrainingLogBridge">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TrainingLogBridge</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Handler</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Bridge for standard logging -&gt; Training Manager UI callbacks&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tm_callback</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tm_callback</span> <span class="o">=</span> <span class="n">tm_callback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">))</span>

<div class="viewcode-block" id="TrainingLogBridge.emit">
<a class="viewcode-back" href="../../api/core.html#core.training_manager.TrainingLogBridge.emit">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">emit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">tm_callback</span><span class="p">:</span> <span class="k">return</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
        <span class="n">level</span> <span class="o">=</span> <span class="s2">&quot;info&quot;</span>
        <span class="k">if</span> <span class="n">record</span><span class="o">.</span><span class="n">levelno</span> <span class="o">&gt;=</span> <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">:</span> <span class="n">level</span> <span class="o">=</span> <span class="s2">&quot;error&quot;</span>
        <span class="k">elif</span> <span class="n">record</span><span class="o">.</span><span class="n">levelno</span> <span class="o">&gt;=</span> <span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">:</span> <span class="n">level</span> <span class="o">=</span> <span class="s2">&quot;warning&quot;</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tm_callback</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;level&quot;</span><span class="p">:</span> <span class="n">level</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">msg</span><span class="p">})</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span></div>
</div>


<div class="viewcode-block" id="RecoveryRequired">
<a class="viewcode-back" href="../../api/core.html#core.training_manager.RecoveryRequired">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">RecoveryRequired</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Internal signal to restart timeframe training in Global mode&quot;&quot;&quot;</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="TrainingManager">
<a class="viewcode-back" href="../../api/core.html#core.training_manager.TrainingManager">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TrainingManager</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Manages training of all models across all timeframes.</span>
<span class="sd">    </span>
<span class="sd">    V2 features:</span>
<span class="sd">    - KPI-based labeling using Noble Safe Range</span>
<span class="sd">    - Walk-forward validation (no shuffle)</span>
<span class="sd">    - Quantile normalization for features</span>
<span class="sd">    - Weighted loss penalizing NEUTRAL</span>
<span class="sd">    - Drift detection for conditional retraining</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mt5_connector</span><span class="p">:</span> <span class="n">MT5Connector</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mt5</span> <span class="o">=</span> <span class="n">mt5_connector</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_engine</span> <span class="o">=</span> <span class="n">FeatureEngine</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labeling_engine</span> <span class="o">=</span> <span class="n">get_labeling_engine</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drift_detector</span> <span class="o">=</span> <span class="n">get_drift_detector</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validator</span> <span class="o">=</span> <span class="n">ModelValidator</span><span class="p">(</span><span class="n">min_accuracy</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="c1"># Feature normalizers per timeframe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">normalizers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">FeatureNormalizer</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="c1"># Training state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_training</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_training_tf</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">training_thread</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_training</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
        
        <span class="c1"># LRU Model Cache (Timeframe based)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loaded_tfs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_loaded_tfs</span> <span class="o">=</span> <span class="mi">2</span> <span class="c1"># Standard</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
        
        <span class="c1"># Callbacks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_callbacks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Logging bridge</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_handler</span> <span class="o">=</span> <span class="n">TrainingLogBridge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_notify</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_handler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
        <span class="c1"># Filter to only catch relevant modules or just everything during training</span>
        <span class="c1"># We&#39;ll attach it to the parent logger or specific ones</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bridge_active</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="c1"># Initialize models for each timeframe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_models</span><span class="p">()</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_init_models</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize models for all timeframes&quot;&quot;&quot;</span>
        <span class="n">MODELS_DIR</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">tf_name</span> <span class="ow">in</span> <span class="n">TIMEFRAME_NAMES</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">tf_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;xgboost&#39;</span><span class="p">:</span> <span class="n">XGBoostModel</span><span class="p">(</span><span class="n">tf_name</span><span class="p">,</span> <span class="n">MODELS_DIR</span><span class="p">),</span>
                <span class="s1">&#39;lightgbm&#39;</span><span class="p">:</span> <span class="n">LightGBMModel</span><span class="p">(</span><span class="n">tf_name</span><span class="p">,</span> <span class="n">MODELS_DIR</span><span class="p">),</span>
                <span class="s1">&#39;randomforest&#39;</span><span class="p">:</span> <span class="n">RandomForestModel</span><span class="p">(</span><span class="n">tf_name</span><span class="p">,</span> <span class="n">MODELS_DIR</span><span class="p">),</span>
                <span class="s1">&#39;catboost&#39;</span><span class="p">:</span> <span class="n">CatBoostModel</span><span class="p">(</span><span class="n">tf_name</span><span class="p">,</span> <span class="n">MODELS_DIR</span><span class="p">),</span>
                <span class="s1">&#39;stacking&#39;</span><span class="p">:</span> <span class="n">StackingModel</span><span class="p">(</span><span class="n">tf_name</span><span class="p">,</span> <span class="n">MODELS_DIR</span><span class="p">),</span>
            <span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">normalizers</span><span class="p">[</span><span class="n">tf_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">FeatureNormalizer</span><span class="p">()</span>
    
<div class="viewcode-block" id="TrainingManager.add_callback">
<a class="viewcode-back" href="../../api/core.html#core.training_manager.TrainingManager.add_callback">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add callback for training status updates&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_callbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span></div>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">_notify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Notify all callbacks&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_callbacks</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">callback</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># Don&#39;t use logger here if bridge is active to avoid recursion</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bridge_active</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Callback error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_enable_log_bridge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">enabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Attach/Detach log bridge to global logging&quot;&quot;&quot;</span>
        <span class="n">root_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">enabled</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bridge_active</span><span class="p">:</span>
            <span class="n">root_logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_handler</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bridge_active</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;📡 Live Log Bridge: ACTIVE&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">enabled</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bridge_active</span><span class="p">:</span>
            <span class="n">root_logger</span><span class="o">.</span><span class="n">removeHandler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_handler</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bridge_active</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;📡 Live Log Bridge: DEACTIVATED&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_and_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">accuracy</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">is_incremental</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validates model and logs appropriate English messages.</span>
<span class="sd">        Returns True if RECOVERY (Global Retrain) is required.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="n">timeframe</span><span class="p">,</span> <span class="n">model_type</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">model</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
        
        <span class="c1"># Accuracy is passed as parameter. Validator checks file existence/size too.</span>
        <span class="c1"># However, validator checks file existence/size too.</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">model_path</span>
        <span class="n">healthy</span><span class="p">,</span> <span class="n">reason</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validator</span><span class="o">.</span><span class="n">is_healthy</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">accuracy</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">healthy</span><span class="p">:</span>
            <span class="c1"># ONLY block on Integrity/File issues now. Accuracy is &quot;libre&quot;.</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;⚠️ Integrity issue detected: </span><span class="si">{</span><span class="n">reason</span><span class="si">}</span><span class="s2">. Rebuilding via Global training...&quot;</span>
            
            <span class="k">if</span> <span class="n">is_incremental</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">model_type</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_notify</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;level&quot;</span><span class="p">:</span> <span class="s2">&quot;warning&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">})</span>
                <span class="k">return</span> <span class="kc">True</span> <span class="c1"># Trigger Recovery for integrity</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># NOTE: We do NOT call Sentinel here to avoid infinite loop.</span>
                <span class="c1"># The caller (train_timeframe) will handle the failure gracefully.</span>
                <span class="n">fail_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;⚠️ </span><span class="si">{</span><span class="n">model_type</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> integrity check failed. Continuing with fresh training...&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">fail_msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_notify</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;level&quot;</span><span class="p">:</span> <span class="s2">&quot;warning&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">fail_msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">})</span>
                <span class="c1"># Just delete the bad model file if it exists</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span> <span class="n">path</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span> <span class="k">pass</span>
                <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># Continue training, don&#39;t loop</span>

        
        <span class="c1"># Healthy (Accuracy is always healthy now since min=0.0)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">model_type</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> Validation: OK (Accuracy: </span><span class="si">{</span><span class="n">accuracy</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_incremental</span><span class="p">:</span>
            <span class="n">success_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;✅ Model Ready: </span><span class="si">{</span><span class="n">model_type</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> accuracy reported as </span><span class="si">{</span><span class="n">accuracy</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_notify</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;level&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">success_msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">})</span>
            
        <span class="k">return</span> <span class="kc">False</span>

    
<div class="viewcode-block" id="TrainingManager.get_model">
<a class="viewcode-back" href="../../api/core.html#core.training_manager.TrainingManager.get_model">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a specific model with LRU loading/unloading logic.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">config.settings</span><span class="w"> </span><span class="kn">import</span> <span class="n">default_settings</span>
        
        <span class="c1"># Determine max loaded TFs based on profile</span>
        <span class="n">profile</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">default_settings</span><span class="p">,</span> <span class="s2">&quot;performance_profile&quot;</span><span class="p">,</span> <span class="s2">&quot;BALANCED&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">profile</span> <span class="o">==</span> <span class="s2">&quot;ECO&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_loaded_tfs</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">profile</span> <span class="o">==</span> <span class="s2">&quot;PRO&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_loaded_tfs</span> <span class="o">=</span> <span class="mi">6</span>
        <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_loaded_tfs</span> <span class="o">=</span> <span class="mi">2</span>
        
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="c1"># Check if this timeframe is already considered &quot;active&quot;</span>
            <span class="k">if</span> <span class="n">timeframe</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loaded_tfs</span><span class="p">:</span>
                <span class="c1"># Move to end of LRU (Most Recent)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_loaded_tfs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">timeframe</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_loaded_tfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">timeframe</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># New timeframe requested</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_loaded_tfs</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_loaded_tfs</span><span class="p">:</span>
                    <span class="c1"># Evict least recently used timeframe</span>
                    <span class="n">old_tf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loaded_tfs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;LRU EVICTION: Unloading </span><span class="si">{</span><span class="n">old_tf</span><span class="si">}</span><span class="s2"> models to save RAM (Profile: </span><span class="si">{</span><span class="n">profile</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">m_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">old_tf</span><span class="p">,</span> <span class="p">{}):</span>
                        <span class="n">m_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">old_tf</span><span class="p">][</span><span class="n">m_name</span><span class="p">]</span>
                        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m_obj</span><span class="p">,</span> <span class="s1">&#39;unload&#39;</span><span class="p">):</span>
                            <span class="n">m_obj</span><span class="o">.</span><span class="n">unload</span><span class="p">()</span>
                
                <span class="c1"># Add current to LRU</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_loaded_tfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">timeframe</span><span class="p">)</span>
                
            <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeframe</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">model_type</span><span class="p">)</span>
            
            <span class="c1"># Auto-load if needed (PredictionEngine also does this, but keeping it here for safety)</span>
            <span class="k">if</span> <span class="n">model</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">model</span><span class="o">.</span><span class="n">is_trained</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">model_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
            
            <span class="k">return</span> <span class="n">model</span></div>

    
<div class="viewcode-block" id="TrainingManager.get_normalizer">
<a class="viewcode-back" href="../../api/core.html#core.training_manager.TrainingManager.get_normalizer">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_normalizer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FeatureNormalizer</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get feature normalizer for a timeframe.</span>
<span class="sd">        Auto-loads from disk if not already in memory/fitted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">normalizer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalizers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeframe</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">normalizer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">normalizer</span> <span class="o">=</span> <span class="n">FeatureNormalizer</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">normalizers</span><span class="p">[</span><span class="n">timeframe</span><span class="p">]</span> <span class="o">=</span> <span class="n">normalizer</span>
            
        <span class="c1"># If not fitted, try to load from disk</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">normalizer</span><span class="o">.</span><span class="n">is_fitted</span><span class="p">:</span>
            <span class="n">norm_path</span> <span class="o">=</span> <span class="n">MODELS_DIR</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;normalizer_</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">.pkl&quot;</span>
            <span class="k">if</span> <span class="n">norm_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">normalizer</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">norm_path</span><span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] Auto-loaded normalizer from disk&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] Failed to load existing normalizer&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                 <span class="c1"># It&#39;s expected if never trained, but bad for prediction</span>
                 <span class="k">pass</span>
                 
        <span class="k">return</span> <span class="n">normalizer</span></div>

    
<div class="viewcode-block" id="TrainingManager.get_training_status">
<a class="viewcode-back" href="../../api/core.html#core.training_manager.TrainingManager.get_training_status">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_training_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get training status for a timeframe&quot;&quot;&quot;</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">get_database</span><span class="p">()</span>
        <span class="n">models_info</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="k">for</span> <span class="n">model_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;xgboost&#39;</span><span class="p">,</span> <span class="s1">&#39;lightgbm&#39;</span><span class="p">,</span> <span class="s1">&#39;randomforest&#39;</span><span class="p">,</span> <span class="s1">&#39;catboost&#39;</span><span class="p">,</span> <span class="s1">&#39;stacking&#39;</span><span class="p">]:</span>
            <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="n">timeframe</span><span class="p">,</span> <span class="n">model_type</span><span class="p">)</span>
            <span class="n">last_training</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_last_training</span><span class="p">(</span><span class="n">timeframe</span><span class="p">,</span> <span class="n">model_type</span><span class="p">)</span>
            
            <span class="n">models_info</span><span class="p">[</span><span class="n">model_type</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;is_trained&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">is_trained</span> <span class="k">if</span> <span class="n">model</span> <span class="k">else</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">accuracy</span> <span class="k">if</span> <span class="n">model</span> <span class="k">else</span> <span class="mf">0.0</span>
            <span class="p">}</span>
            
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;models&#39;</span><span class="p">:</span> <span class="n">models_info</span><span class="p">,</span>
            <span class="s1">&#39;is_training&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_training_tf</span> <span class="o">==</span> <span class="n">timeframe</span><span class="p">,</span>
        <span class="p">}</span></div>

    
<div class="viewcode-block" id="TrainingManager.should_train_incremental">
<a class="viewcode-back" href="../../api/core.html#core.training_manager.TrainingManager.should_train_incremental">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">should_train_incremental</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine if training should be incremental.</span>
<span class="sd">        </span>
<span class="sd">        Checks if models have been trained recently (within 6 hours).</span>
<span class="sd">        If so, returns (True, last_training_date) to train only on new data.</span>
<span class="sd">        Otherwise returns (False, None) for full training.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            Tuple of (is_incremental, train_from_date)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">get_database</span><span class="p">()</span>
        
        <span class="c1"># Check last training for any model</span>
        <span class="n">last_dates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">model_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;xgboost&#39;</span><span class="p">,</span> <span class="s1">&#39;lightgbm&#39;</span><span class="p">,</span> <span class="s1">&#39;randomforest&#39;</span><span class="p">,</span> <span class="s1">&#39;catboost&#39;</span><span class="p">,</span> <span class="s1">&#39;stacking&#39;</span><span class="p">]:</span>
            <span class="n">last_training</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_last_training</span><span class="p">(</span><span class="n">timeframe</span><span class="p">,</span> <span class="n">model_type</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">last_training</span> <span class="ow">and</span> <span class="n">last_training</span><span class="o">.</span><span class="n">completed_at</span><span class="p">:</span>
                <span class="n">completed</span> <span class="o">=</span> <span class="n">last_training</span><span class="o">.</span><span class="n">completed_at</span>
                <span class="c1"># Handle string dates from SQLite</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">completed</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">completed</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">completed</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span> <span class="s1">&#39;+00:00&#39;</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">completed</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">completed</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S.</span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                            <span class="n">completed</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">completed</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
                <span class="c1"># Remove timezone info for comparison with naive datetime</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">completed</span><span class="p">,</span> <span class="s1">&#39;replace&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">completed</span><span class="o">.</span><span class="n">tzinfo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">completed</span> <span class="o">=</span> <span class="n">completed</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
                <span class="n">last_dates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">completed</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">last_dates</span><span class="p">:</span>
            <span class="c1"># No previous training - do global training</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span>
        
        <span class="c1"># Use oldest last training date</span>
        <span class="n">oldest_training</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">last_dates</span><span class="p">)</span>
        
        <span class="c1"># If trained within last 6 hours, do incremental</span>
        <span class="c1"># We relax this check slightly to allow manual incremental triggers</span>
        <span class="c1"># But generally, incremental implies we have a baseline.</span>
        <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">oldest_training</span></div>

    
<div class="viewcode-block" id="TrainingManager.prepare_training_data">
<a class="viewcode-back" href="../../api/core.html#core.training_manager.TrainingManager.prepare_training_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">prepare_training_data</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">timeframe</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
        <span class="n">from_date</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">use_kpi_labels</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepare features and labels for training.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;─── DATA PREPARATION SECTION: </span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2"> ───&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_notify</span><span class="p">(</span><span class="s2">&quot;phase_update&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;phase&quot;</span><span class="p">:</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;active&quot;</span><span class="p">,</span> <span class="s2">&quot;detail&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Loading </span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">})</span>
        
        <span class="c1"># Load OHLC data</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] Loading OHLC from disk...&quot;</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mt5</span><span class="o">.</span><span class="n">load_ohlc</span><span class="p">(</span><span class="n">timeframe</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] Failed to load OHLC: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] df is None after load&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] df shape: </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># --- GENERAL STALENESS CHECK ---</span>
        <span class="c1"># Ensure data is fresh regardless of incremental settings</span>
        <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Ensure time column is datetime</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">is_datetime64_any_dtype</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]):</span>
                    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">])</span>
                
                <span class="n">last_local_date</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
                
                <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">last_local_date</span><span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] Last date is NaT! skipping staleness check.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Calculate stale threshold based on timeframe</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">config.settings</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_timeframe_by_name</span>
                    <span class="n">tf_conf</span> <span class="o">=</span> <span class="n">get_timeframe_by_name</span><span class="p">(</span><span class="n">timeframe</span><span class="p">)</span>
                    <span class="n">minutes_per_candle</span> <span class="o">=</span> <span class="n">tf_conf</span><span class="o">.</span><span class="n">minutes</span> <span class="k">if</span> <span class="n">tf_conf</span> <span class="k">else</span> <span class="mi">60</span>
                    
                    <span class="n">is_stale</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">age</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">last_local_date</span>
                    
                    <span class="k">if</span> <span class="n">age</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">3600</span><span class="p">:</span>  <span class="c1"># Older than 24h</span>
                        <span class="n">is_stale</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">elif</span> <span class="n">age</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">minutes_per_candle</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">5</span><span class="p">):</span>  <span class="c1"># Missing &gt; 5 candles</span>
                        <span class="n">is_stale</span> <span class="o">=</span> <span class="kc">True</span>
                    
                    <span class="k">if</span> <span class="n">is_stale</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] Data appears stale (Last: </span><span class="si">{</span><span class="n">last_local_date</span><span class="si">}</span><span class="s2">, Now: </span><span class="si">{</span><span class="n">now</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_notify</span><span class="p">(</span><span class="s2">&quot;phase_update&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;phase&quot;</span><span class="p">:</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;warning&quot;</span><span class="p">,</span> <span class="s2">&quot;detail&quot;</span><span class="p">:</span> <span class="s2">&quot;Stale Data&quot;</span><span class="p">})</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Staleness check error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># SMART UPDATE CHECK (Incremental specifics):</span>
        <span class="k">if</span> <span class="n">from_date</span> <span class="ow">and</span> <span class="n">df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
             <span class="k">pass</span> 

        <span class="c1"># HISTORICAL DATA CHECK:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">config.settings</span><span class="w"> </span><span class="kn">import</span> <span class="n">default_settings</span>
        <span class="n">req_start_year</span> <span class="o">=</span> <span class="n">default_settings</span><span class="o">.</span><span class="n">extract_from_year</span>
        <span class="n">req_start_date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="n">req_start_year</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">first_date</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">first_date</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">req_start_date</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">30</span><span class="p">)):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] History starts at </span><span class="si">{</span><span class="n">first_date</span><span class="si">}</span><span class="s2">, expected </span><span class="si">{</span><span class="n">req_start_date</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] No OHLC data found&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_notify</span><span class="p">(</span><span class="s2">&quot;phase_update&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;phase&quot;</span><span class="p">:</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;detail&quot;</span><span class="p">:</span> <span class="s2">&quot;No Data&quot;</span><span class="p">})</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[],</span> <span class="kc">None</span>
        
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] Loaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2"> OHLC candles (from </span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_notify</span><span class="p">(</span><span class="s2">&quot;phase_update&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;phase&quot;</span><span class="p">:</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;complete&quot;</span><span class="p">,</span> <span class="s2">&quot;detail&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">})</span>

        
        <span class="c1"># Store incremental filter date (will apply AFTER feature calculation)</span>
        <span class="n">incremental_from_date</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">from_date</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">from_date</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">incremental_from_date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">from_date</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">incremental_from_date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">from_date</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] Incremental training mode: will filter samples from </span><span class="si">{</span><span class="n">incremental_from_date</span><span class="si">}</span><span class="s2"> after feature calculation&quot;</span><span class="p">)</span>
        
        <span class="c1"># CHECK TOTAL DATA SUFFICIENCY (before filtering for incremental)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] Not enough historical data for indicators: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2"> (need 200+)&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[],</span> <span class="kc">None</span>
        
        <span class="c1"># Reset index for proper alignment</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="c1"># CREATE LABELS on FULL dataset (before dropna)</span>
        <span class="k">if</span> <span class="n">use_kpi_labels</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_notify</span><span class="p">(</span><span class="s2">&quot;phase_update&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;phase&quot;</span><span class="p">:</span> <span class="s2">&quot;labels&quot;</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;active&quot;</span><span class="p">,</span> <span class="s2">&quot;detail&quot;</span><span class="p">:</span> <span class="s2">&quot;Labeling...&quot;</span><span class="p">})</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] Creating KPI-based labels using Noble Safe Range...&quot;</span><span class="p">)</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labeling_engine</span><span class="o">.</span><span class="n">create_labels</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">)</span>
            
            <span class="c1"># Label stats</span>
            <span class="n">buy</span><span class="p">,</span> <span class="n">sell</span><span class="p">,</span> <span class="n">neutral</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">labels</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">labels</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">labels</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_notify</span><span class="p">(</span><span class="s2">&quot;phase_update&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;phase&quot;</span><span class="p">:</span> <span class="s2">&quot;labels&quot;</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;complete&quot;</span><span class="p">,</span> <span class="s2">&quot;detail&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;B:</span><span class="si">{</span><span class="n">buy</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">XGBoostModel</span><span class="p">(</span><span class="n">timeframe</span><span class="p">,</span> <span class="n">MODELS_DIR</span><span class="p">)</span><span class="o">.</span><span class="n">prepare_labels</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        
        <span class="c1"># Store original indices for alignment</span>
        <span class="n">original_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        
        <span class="c1"># Calculate features on FULL data (includes dropna which removes some rows)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] Calculating features (all indicators + Noble KPI)...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_notify</span><span class="p">(</span><span class="s2">&quot;phase_update&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;phase&quot;</span><span class="p">:</span> <span class="s2">&quot;features&quot;</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;active&quot;</span><span class="p">,</span> <span class="s2">&quot;detail&quot;</span><span class="p">:</span> <span class="s2">&quot;Calculating...&quot;</span><span class="p">})</span>
        
        <span class="k">def</span><span class="w"> </span><span class="nf">progress_log</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">_notify</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;level&quot;</span><span class="p">:</span> <span class="s2">&quot;info&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">msg</span><span class="p">})</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Calculate features (bypass 5000 row limit for training)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_engine</span><span class="o">.</span><span class="n">calculate_all_features</span><span class="p">(</span>
                <span class="n">df</span><span class="p">,</span> 
                <span class="n">timeframe</span><span class="o">=</span><span class="n">timeframe</span><span class="p">,</span> 
                <span class="n">progress_callback</span><span class="o">=</span><span class="n">progress_log</span><span class="p">,</span>
                <span class="n">is_training</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] Feature calculation failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Triggering FE-200 Recovery...&quot;</span><span class="p">)</span>
            <span class="c1"># Index FE-200: Feature Cache Recovery</span>
            <span class="n">get_sentinel</span><span class="p">(</span><span class="n">tm</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">repair</span><span class="p">(</span><span class="s2">&quot;FE-200&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;timeframe&quot;</span><span class="p">:</span> <span class="n">timeframe</span><span class="p">})</span>
            <span class="c1"># One last try after cache wipe</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_engine</span><span class="o">.</span><span class="n">calculate_all_features</span><span class="p">(</span>
                <span class="n">df</span><span class="p">,</span> 
                <span class="n">timeframe</span><span class="o">=</span><span class="n">timeframe</span><span class="p">,</span> 
                <span class="n">progress_callback</span><span class="o">=</span><span class="n">progress_log</span><span class="p">,</span>
                <span class="n">is_training</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
        
        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] No features calculated&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[],</span> <span class="kc">None</span>
        
        <span class="c1"># Get valid indices after dropna</span>
        <span class="n">valid_indices</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">original_len</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>
        
        <span class="c1"># Get feature columns</span>
        <span class="c1"># Get feature columns</span>
        <span class="n">exclude</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">,</span> <span class="s1">&#39;low&#39;</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="s1">&#39;volume&#39;</span><span class="p">]</span>
        <span class="n">all_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">]</span>
        
        <span class="c1"># --- USER CONFIG FILTERING ---</span>
        <span class="c1"># Respect the &quot;Enabled&quot; checkboxes in the UI</span>
        <span class="k">try</span><span class="p">:</span>
             <span class="n">db</span> <span class="o">=</span> <span class="n">get_database</span><span class="p">()</span>
             <span class="n">enabled_features</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_enabled_indicators</span><span class="p">()</span>
             
             <span class="c1"># Fallback if list is empty (user disabled everything by mistake)</span>
             <span class="k">if</span> <span class="ow">not</span> <span class="n">enabled_features</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">enabled_features</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                 <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] User disabled almost all indicators. Using ALL defaults for safety.&quot;</span><span class="p">)</span>
                 <span class="n">feature_cols</span> <span class="o">=</span> <span class="n">all_cols</span>
             <span class="k">else</span><span class="p">:</span>
                 <span class="c1"># Filter: Keep only enabled features (and special columns like lags which might not be in the list)</span>
                 <span class="c1"># Note: Lags usually named &#39;close_lag_1&#39; etc. might not be in the default list.</span>
                 <span class="c1"># We should be permissive: If it&#39;s in the list, check status. If NOT in list (new feature), keep it or drop it?</span>
                 <span class="c1"># Safer strategy: Filter ONLY those that explicitly appear in the config table.</span>
                 
                 <span class="n">feature_cols</span> <span class="o">=</span> <span class="p">[]</span>
                 <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">all_cols</span><span class="p">:</span>
                     <span class="c1"># Check exact match first</span>
                     <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">enabled_features</span><span class="p">:</span>
                         <span class="n">feature_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
                     <span class="c1"># Check if it&#39;s a lag/custom feature NOT in the DB config (Keep them to avoid breaking custom logic)</span>
                     <span class="c1"># Or check if it&#39;s explicitly DISABLED (would need a get_disabled_indicators)</span>
                     <span class="c1"># Simplified: If the DB returns a list of &quot;Enabled&quot;, we assume anything NOT in the DB is either custom or unknown.</span>
                     <span class="c1"># Let&#39;s trust the DB list covers the main indicators shown in UI.</span>
                     <span class="c1"># If a feature is NOT in the DB at all (e.g. lag), we KEEP it to be safe.</span>
                     <span class="k">else</span><span class="p">:</span>
                          <span class="c1"># Check if it exists in the ALL indicators list (to see if it was possible to disable it)</span>
                          <span class="c1"># This is expensive. Let&#39;s just assume if it starts with &#39;return&#39; or &#39;lag&#39; it&#39;s internal.</span>
                          <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="n">col</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;lag&#39;</span><span class="p">,</span> <span class="s1">&#39;return&#39;</span><span class="p">,</span> <span class="s1">&#39;candle&#39;</span><span class="p">,</span> <span class="s1">&#39;volatility&#39;</span><span class="p">]):</span> 
                                <span class="n">feature_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> 
                          <span class="c1"># Else, it might be an indicator that is disabled.</span>
                          <span class="c1"># Wait, db.init_default_indicators() populates everything.</span>
                          <span class="c1"># So if &#39;rsi&#39; is not in enabled_features, it means it is Disabled.</span>
                 
                 <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] Applied User Filter: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">feature_cols</span><span class="p">)</span><span class="si">}</span><span class="s2"> features enabled (out of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">all_cols</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
             <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to apply indicator config: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
             <span class="n">feature_cols</span> <span class="o">=</span> <span class="n">all_cols</span>
        
        <span class="c1"># --- DATA LEAKAGE FIX: Do NOT normalize here ---</span>
        <span class="c1"># We return raw features, splitting and normalization happens in train_timeframe</span>
        
        <span class="c1"># Get X from raw features</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">feature_cols</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        
        <span class="c1"># Align labels with valid indices (after dropna)</span>
        <span class="c1"># FIX: Use precise index-based alignment. FeatureEngine now preserves indices.</span>
        <span class="c1"># This handles cases where rows are dropped in the middle (not just head).</span>
        
        <span class="c1"># Ensure labels are numpy array</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
        
        <span class="c1"># Filter labels using the valid indices from the feature dataframe</span>
        <span class="k">try</span><span class="p">:</span>
             <span class="n">y</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
             <span class="c1"># Fallback if indices are out of bounds (should not happen if df was reset before)</span>
             <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] Index alignment failed. Fallback to tail slicing (RISKY).&quot;</span><span class="p">)</span>
             <span class="n">y</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">):]</span>
        

        <span class="c1"># --- FEATURE SELECTION (Agile Mode) ---</span>
        <span class="c1"># REMOVED from here to avoid DATA LEAKAGE.</span>
        <span class="c1"># Feature selection must be done on X_train ONLY inside train_timeframe.</span>
        
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] Generated </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">feature_cols</span><span class="p">)</span><span class="si">}</span><span class="s2"> features for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="si">}</span><span class="s2"> samples (RAW)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_notify</span><span class="p">(</span><span class="s2">&quot;phase_update&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;phase&quot;</span><span class="p">:</span> <span class="s2">&quot;features&quot;</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;complete&quot;</span><span class="p">,</span> <span class="s2">&quot;detail&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">feature_cols</span><span class="p">)</span><span class="si">}</span><span class="s2"> feats&quot;</span><span class="p">})</span>
        
        <span class="c1"># Remove rows with NaN/Inf in features</span>
        <span class="n">valid_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># Keep df in sync for time filter</span>
        
        <span class="c1"># --- WINSORIZATION (Outlier Treatment) ---</span>
        <span class="c1"># User Feedback: &quot;Pas de Winsorization/Clip Outliers&quot;</span>
        <span class="c1"># We clip at 0.1/99.9 percentile to remove extreme noise while keeping signal.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">lower</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="mf">0.1</span><span class="p">)</span>
                    <span class="n">upper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="mf">99.9</span><span class="p">)</span>
                    <span class="n">X</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span> <span class="k">continue</span>
        
        <span class="c1"># Replace remaining Infs (if any) with 0</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">nan</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">posinf</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">neginf</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] CRITICAL: X/y size mismatch: X=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="si">}</span><span class="s2">, y=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">min_len</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:</span><span class="n">min_len</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[:</span><span class="n">min_len</span><span class="p">]</span>
        
        <span class="c1"># APPLY INCREMENTAL FILTER (after all features are ready)</span>
        <span class="k">if</span> <span class="n">incremental_from_date</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">time_col</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">time_col</span> <span class="o">&gt;=</span> <span class="n">incremental_from_date</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">mask</span><span class="o">.</span><span class="n">values</span><span class="p">]</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="s1">&#39;values&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">X</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">mask</span><span class="o">.</span><span class="n">values</span><span class="p">]</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="s1">&#39;values&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">y</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] Incremental training: sliced to </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="si">}</span><span class="s2"> samples from </span><span class="si">{</span><span class="n">incremental_from_date</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="c1"># Check for class diversity</span>
            <span class="n">unique_classes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_classes</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Incremental slice contains too few classes (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_classes</span><span class="p">)</span><span class="si">}</span><span class="s2">). Skipping incremental training.&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[],</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] Not enough new samples for incremental training: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="si">}</span><span class="s2"> (need 10+)&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[],</span> <span class="kc">None</span>

        <span class="c1"># --- FINAL RAM OPTIMIZATION ---</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] 🧹 Data preparation complete. Features: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">feature_cols</span><span class="p">)</span><span class="si">}</span><span class="s2">, Samples: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_notify</span><span class="p">(</span><span class="s2">&quot;phase_update&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;phase&quot;</span><span class="p">:</span> <span class="s2">&quot;features&quot;</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;complete&quot;</span><span class="p">,</span> <span class="s2">&quot;detail&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">feature_cols</span><span class="p">)</span><span class="si">}</span><span class="s2"> feats&quot;</span><span class="p">})</span>
        
        <span class="k">return</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">feature_cols</span><span class="p">,</span> <span class="n">df</span></div>

    
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_filter_history_by_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Enforce strict historical data limits for TurboTrain efficiency:</span>
<span class="sd">        1m -&gt; User defined (default 6 months)</span>
<span class="sd">        5m -&gt; 1 year</span>
<span class="sd">        15m -&gt; 3 years</span>
<span class="sd">        Others -&gt; 5 years</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">config.settings</span><span class="w"> </span><span class="kn">import</span> <span class="n">default_settings</span>
            <span class="n">cutoff_months</span> <span class="o">=</span> <span class="mi">60</span> <span class="c1"># Default 5 years</span>
            <span class="k">if</span> <span class="n">timeframe</span> <span class="o">==</span> <span class="s1">&#39;1m&#39;</span><span class="p">:</span> <span class="n">cutoff_months</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">default_settings</span><span class="p">,</span> <span class="s1">&#39;history_1m_months&#39;</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">timeframe</span> <span class="o">==</span> <span class="s1">&#39;5m&#39;</span><span class="p">:</span> <span class="n">cutoff_months</span> <span class="o">=</span> <span class="mi">12</span>
            <span class="k">elif</span> <span class="n">timeframe</span> <span class="o">==</span> <span class="s1">&#39;15m&#39;</span><span class="p">:</span> <span class="n">cutoff_months</span> <span class="o">=</span> <span class="mi">36</span>
            
            <span class="n">cutoff_date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="n">cutoff_months</span><span class="p">)</span>
            
            <span class="c1"># Check if index is datetime</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">cutoff_date</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">cutoff_date</span><span class="p">]</span>
            <span class="k">elif</span> <span class="s1">&#39;time&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="c1"># If time column exists ensure it matches</span>
                <span class="c1"># But typically we expect the DF passed here to be the one we can slice</span>
                <span class="k">pass</span>
                
            <span class="k">return</span> <span class="n">df</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;History filter failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">df</span>

<div class="viewcode-block" id="TrainingManager.train_timeframe">
<a class="viewcode-back" href="../../api/core.html#core.training_manager.TrainingManager.train_timeframe">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">train_timeframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">force_global</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">precomputed_data</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">_recovery_depth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">use_walk_forward</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Train all models for a single timeframe. (Automatic Recovery with depth limit)</span>
<span class="sd">        Accepts optional precomputed_data to support Hybrid Parallel flow.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            use_walk_forward: If True, run Walk-Forward CV before normal training to log fold metrics.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># RECURSION PROTECTION: Max 1 retry to prevent infinite loops</span>
        <span class="n">MAX_RECOVERY_DEPTH</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">_recovery_depth</span> <span class="o">&gt;</span> <span class="n">MAX_RECOVERY_DEPTH</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] Max recovery depth reached. Aborting training.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Max recovery depth exceeded&quot;</span><span class="p">}</span>
        
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;════════════════════════════════════════════════════════════&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   TRAINING CYCLE START: </span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;════════════════════════════════════════════════════════════&quot;</span><span class="p">)</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">get_database</span><span class="p">()</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="c1"># RECOVERY WRAPPER</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_training_tf</span> <span class="o">=</span> <span class="n">timeframe</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_notify</span><span class="p">(</span><span class="s2">&quot;training_start&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;timeframe&quot;</span><span class="p">:</span> <span class="n">timeframe</span><span class="p">})</span>
            
            <span class="c1"># Check if models actually exist</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">config.settings</span><span class="w"> </span><span class="kn">import</span> <span class="n">MODELS_DIR</span>
            <span class="n">model_types</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;xgboost&quot;</span><span class="p">,</span> <span class="s2">&quot;lightgbm&quot;</span><span class="p">,</span> <span class="s2">&quot;randomforest&quot;</span><span class="p">,</span> <span class="s2">&quot;catboost&quot;</span><span class="p">,</span> <span class="s2">&quot;stacking&quot;</span><span class="p">]</span>
            <span class="n">models_exist</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span>
                <span class="p">(</span><span class="n">MODELS_DIR</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mt</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">.pkl&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> 
                <span class="k">for</span> <span class="n">mt</span> <span class="ow">in</span> <span class="n">model_types</span>
            <span class="p">)</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">models_exist</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force_global</span><span class="p">:</span>
                 <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] Models missing -&gt; Forcing Global Training&quot;</span><span class="p">)</span>
                 <span class="n">force_global</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># Determine training mode</span>
            <span class="k">if</span> <span class="n">force_global</span><span class="p">:</span>
                <span class="n">is_incremental</span><span class="p">,</span> <span class="n">from_date</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">is_incremental</span><span class="p">,</span> <span class="n">from_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">should_train_incremental</span><span class="p">(</span><span class="n">timeframe</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">_notify</span><span class="p">(</span><span class="s2">&quot;training_mode&quot;</span><span class="p">,</span> <span class="p">{</span>
                <span class="s2">&quot;timeframe&quot;</span><span class="p">:</span> <span class="n">timeframe</span><span class="p">,</span> <span class="s2">&quot;is_incremental&quot;</span><span class="p">:</span> <span class="n">is_incremental</span><span class="p">,</span> <span class="s2">&quot;from_date&quot;</span><span class="p">:</span> <span class="n">from_date</span><span class="p">,</span>
            <span class="p">})</span>
            
            <span class="c1"># Prepare data (RAW)</span>
            <span class="k">if</span> <span class="n">precomputed_data</span><span class="p">:</span>
                <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sample_count</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">,</span> <span class="n">df</span> <span class="o">=</span> <span class="n">precomputed_data</span>
                <span class="n">from_date</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Not needed as data is already sliced</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_notify</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;level&quot;</span><span class="p">:</span> <span class="s2">&quot;info&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] 📥 Preparing training data...&quot;</span><span class="p">})</span>
                <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sample_count</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">,</span> <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_training_data</span><span class="p">(</span>
                    <span class="n">timeframe</span><span class="p">,</span> <span class="n">from_date</span><span class="p">,</span> <span class="n">use_kpi_labels</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
            
            <span class="k">if</span> <span class="n">X</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">is_incremental</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] Incremental slice insufficient. Falling back to GLOBAL...&quot;</span><span class="p">)</span>
                    <span class="n">is_incremental</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">from_date</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sample_count</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">,</span> <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_training_data</span><span class="p">(</span><span class="n">timeframe</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">use_kpi_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">X</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] Training cycle skipped.&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_notify</span><span class="p">(</span><span class="s2">&quot;phase_update&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;phase&quot;</span><span class="p">:</span> <span class="s2">&quot;train_xgb&quot;</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;complete&quot;</span><span class="p">,</span> <span class="s2">&quot;detail&quot;</span><span class="p">:</span> <span class="s2">&quot;Up to date&quot;</span><span class="p">})</span>
                    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;skipped&quot;</span><span class="p">}</span>
            
            <span class="c1"># --- OPTIONAL: WALK-FORWARD CROSS-VALIDATION ---</span>
            <span class="k">if</span> <span class="n">use_walk_forward</span> <span class="ow">and</span> <span class="n">df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] 🔄 Running Walk-Forward Cross-Validation...&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_notify</span><span class="p">(</span><span class="s2">&quot;phase_update&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;phase&quot;</span><span class="p">:</span> <span class="s2">&quot;wf_cv&quot;</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;active&quot;</span><span class="p">,</span> <span class="s2">&quot;detail&quot;</span><span class="p">:</span> <span class="s2">&quot;WF-CV...&quot;</span><span class="p">})</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">core.walk_forward</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_walk_forward_validator</span>
                    <span class="n">wf_validator</span> <span class="o">=</span> <span class="n">get_walk_forward_validator</span><span class="p">(</span><span class="n">train_months</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">val_months</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    
                    <span class="n">wf_results</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">train_idx</span><span class="p">,</span> <span class="n">val_idx</span><span class="p">,</span> <span class="n">fold_info</span> <span class="ow">in</span> <span class="n">wf_validator</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">):</span>
                        <span class="n">X_train_fold</span><span class="p">,</span> <span class="n">y_train_fold</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">train_idx</span><span class="p">]</span>
                        <span class="n">X_val_fold</span><span class="p">,</span> <span class="n">y_val_fold</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">val_idx</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">val_idx</span><span class="p">]</span>
                        
                        <span class="c1"># Quick evaluation with XGBoost only (fastest)</span>
                        <span class="kn">from</span><span class="w"> </span><span class="nn">models.xgboost_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">XGBoostModel</span>
                        <span class="kn">from</span><span class="w"> </span><span class="nn">config.settings</span><span class="w"> </span><span class="kn">import</span> <span class="n">MODELS_DIR</span>
                        <span class="n">fold_model</span> <span class="o">=</span> <span class="n">XGBoostModel</span><span class="p">(</span><span class="n">timeframe</span><span class="p">,</span> <span class="n">MODELS_DIR</span><span class="p">)</span>
                        <span class="n">fold_acc</span> <span class="o">=</span> <span class="n">fold_model</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">X_train_fold</span><span class="p">,</span> <span class="n">y_train_fold</span><span class="p">,</span> <span class="n">X_val_fold</span><span class="p">,</span> <span class="n">y_val_fold</span><span class="p">)</span>
                        
                        <span class="n">wf_results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                            <span class="s1">&#39;fold&#39;</span><span class="p">:</span> <span class="n">fold_info</span><span class="p">[</span><span class="s1">&#39;fold&#39;</span><span class="p">],</span>
                            <span class="s1">&#39;train_samples&#39;</span><span class="p">:</span> <span class="n">fold_info</span><span class="p">[</span><span class="s1">&#39;train_samples&#39;</span><span class="p">],</span>
                            <span class="s1">&#39;val_samples&#39;</span><span class="p">:</span> <span class="n">fold_info</span><span class="p">[</span><span class="s1">&#39;val_samples&#39;</span><span class="p">],</span>
                            <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="n">fold_acc</span>
                        <span class="p">})</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] WF Fold </span><span class="si">{</span><span class="n">fold_info</span><span class="p">[</span><span class="s1">&#39;fold&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: Accuracy=</span><span class="si">{</span><span class="n">fold_acc</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">wf_results</span><span class="p">:</span>
                        <span class="n">avg_wf_acc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">wf_results</span><span class="p">])</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] ✅ Walk-Forward CV Complete: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">wf_results</span><span class="p">)</span><span class="si">}</span><span class="s2"> folds, Avg=</span><span class="si">{</span><span class="n">avg_wf_acc</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;walk_forward&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;folds&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">wf_results</span><span class="p">),</span> <span class="s1">&#39;avg_accuracy&#39;</span><span class="p">:</span> <span class="n">avg_wf_acc</span><span class="p">,</span> <span class="s1">&#39;details&#39;</span><span class="p">:</span> <span class="n">wf_results</span><span class="p">}</span>
                    
                    <span class="bp">self</span><span class="o">.</span><span class="n">_notify</span><span class="p">(</span><span class="s2">&quot;phase_update&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;phase&quot;</span><span class="p">:</span> <span class="s2">&quot;wf_cv&quot;</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;complete&quot;</span><span class="p">,</span> <span class="s2">&quot;detail&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">avg_wf_acc</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">})</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">wf_err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] Walk-Forward CV failed: </span><span class="si">{</span><span class="n">wf_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_notify</span><span class="p">(</span><span class="s2">&quot;phase_update&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;phase&quot;</span><span class="p">:</span> <span class="s2">&quot;wf_cv&quot;</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;detail&quot;</span><span class="p">:</span> <span class="s2">&quot;Failed&quot;</span><span class="p">})</span>
            
            <span class="c1"># --- DATA SPLIT (3-WAY: Train/Val/Test) ---</span>
            <span class="c1"># 70% Train / 15% Validation / 15% Test (TRUE OUT-OF-SAMPLE HOLDOUT)</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
            <span class="n">train_end</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="mf">0.70</span><span class="p">)</span>
            <span class="n">val_end</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="mf">0.85</span><span class="p">)</span>
            
            <span class="c1"># SPLIT RAW DATA FIRST (Before normalization/selection to prevent leakage)</span>
            <span class="n">X_train_raw</span><span class="p">,</span> <span class="n">y_train</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:</span><span class="n">train_end</span><span class="p">],</span> <span class="n">y</span><span class="p">[:</span><span class="n">train_end</span><span class="p">]</span>
            <span class="n">X_val_raw</span><span class="p">,</span> <span class="n">y_val</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">train_end</span><span class="p">:</span><span class="n">val_end</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">train_end</span><span class="p">:</span><span class="n">val_end</span><span class="p">]</span>
            <span class="n">X_test_raw</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">val_end</span><span class="p">:],</span> <span class="n">y</span><span class="p">[</span><span class="n">val_end</span><span class="p">:]</span>
            
            <span class="c1"># --- LEAK-PROOF FEATURE SELECTION (On X_train only) ---</span>
            <span class="c1"># Select Top 15 features using ONLY training data</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] 🛡️ Running Leak-Proof Feature Selection (Top 15)...&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Convert back to DF for feature engine (needs column names)</span>
                <span class="n">df_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_train_raw</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">feature_names</span><span class="p">)</span>
                <span class="n">selected_cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_engine</span><span class="o">.</span><span class="n">select_best_features</span><span class="p">(</span>
                    <span class="n">df_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">n_features</span><span class="o">=</span><span class="mi">15</span>  <span class="c1"># Slightly more permissive than 10</span>
                <span class="p">)</span>
                
                <span class="k">if</span> <span class="n">selected_cols</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">selected_cols</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
                    <span class="c1"># Filter All Sets to selected columns</span>
                    <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">feature_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">selected_cols</span><span class="p">]</span>
                    <span class="n">X_train</span> <span class="o">=</span> <span class="n">X_train_raw</span><span class="p">[:,</span> <span class="n">indices</span><span class="p">]</span>
                    <span class="n">X_val</span> <span class="o">=</span> <span class="n">X_val_raw</span><span class="p">[:,</span> <span class="n">indices</span><span class="p">]</span>
                    <span class="n">X_test</span> <span class="o">=</span> <span class="n">X_test_raw</span><span class="p">[:,</span> <span class="n">indices</span><span class="p">]</span>
                    <span class="n">feature_names</span> <span class="o">=</span> <span class="n">selected_cols</span> <span class="c1"># Update feature names</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] ✅ Selected </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">feature_names</span><span class="p">)</span><span class="si">}</span><span class="s2"> features: </span><span class="si">{</span><span class="n">feature_names</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">X_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">X_test</span> <span class="o">=</span> <span class="n">X_train_raw</span><span class="p">,</span> <span class="n">X_val_raw</span><span class="p">,</span> <span class="n">X_test_raw</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] Feature selection failed/insufficient. Using all features.&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">fs_err</span><span class="p">:</span>
                 <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] Feature selection error: </span><span class="si">{</span><span class="n">fs_err</span><span class="si">}</span><span class="s2">. Using all features.&quot;</span><span class="p">)</span>
                 <span class="n">X_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">X_test</span> <span class="o">=</span> <span class="n">X_train_raw</span><span class="p">,</span> <span class="n">X_val_raw</span><span class="p">,</span> <span class="n">X_test_raw</span>
            
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] 🔀 3-WAY SPLIT: Train=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span><span class="si">}</span><span class="s2">, Val=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X_val</span><span class="p">)</span><span class="si">}</span><span class="s2">, Test=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="c1"># --- NORMALIZATION (Quantile-based) ---</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] 📊 Fitting normalizer on training data...&quot;</span><span class="p">)</span>
            <span class="n">normalizer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalizers</span><span class="p">[</span><span class="n">timeframe</span><span class="p">]</span>
            
            <span class="c1"># Create temp DataFrame for fit (using training data ONLY to avoid data leakage)</span>
            <span class="n">X_train_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">feature_names</span><span class="p">)</span>
            <span class="n">normalizer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_df</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">)</span>
            
            <span class="c1"># Transform all sets using the normalizer fitted on training data</span>
            <span class="n">X_train</span> <span class="o">=</span> <span class="n">normalizer</span><span class="o">.</span><span class="n">transform_array</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">)</span>
            <span class="n">X_val</span> <span class="o">=</span> <span class="n">normalizer</span><span class="o">.</span><span class="n">transform_array</span><span class="p">(</span><span class="n">X_val</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">)</span>
            <span class="n">X_test</span> <span class="o">=</span> <span class="n">normalizer</span><span class="o">.</span><span class="n">transform_array</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">)</span>
            
            <span class="c1"># Save normalizer for inference</span>
            <span class="n">norm_path</span> <span class="o">=</span> <span class="n">MODELS_DIR</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;normalizer_</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">.pkl&quot;</span>
            <span class="n">normalizer</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">norm_path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_notify</span><span class="p">(</span><span class="s2">&quot;phase_update&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;phase&quot;</span><span class="p">:</span> <span class="s2">&quot;normalize&quot;</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;complete&quot;</span><span class="p">,</span> <span class="s2">&quot;detail&quot;</span><span class="p">:</span> <span class="s2">&quot;Fitted&quot;</span><span class="p">})</span>
            
            <span class="c1"># --- CLASS WEIGHTS (Balanced based on distribution) ---</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.utils.class_weight</span><span class="w"> </span><span class="kn">import</span> <span class="n">compute_class_weight</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">unique_classes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span>
                <span class="n">weights</span> <span class="o">=</span> <span class="n">compute_class_weight</span><span class="p">(</span><span class="s1">&#39;balanced&#39;</span><span class="p">,</span> <span class="n">classes</span><span class="o">=</span><span class="n">unique_classes</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y_train</span><span class="p">)</span>
                <span class="n">class_weight_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">unique_classes</span><span class="p">,</span> <span class="n">weights</span><span class="p">))</span>
                <span class="c1"># Reduce NEUTRAL (class 1) weight further to discourage trivial predictions</span>
                <span class="k">if</span> <span class="mi">1</span> <span class="ow">in</span> <span class="n">class_weight_dict</span><span class="p">:</span>
                    <span class="n">class_weight_dict</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*=</span> <span class="mf">0.3</span>  <span class="c1"># Penalize NEUTRAL predictions</span>
                <span class="n">class_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">class_weight_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">y_train</span><span class="p">])</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] Class weights: </span><span class="si">{</span><span class="n">class_weight_dict</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">cw_err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] Class weight computation failed: </span><span class="si">{</span><span class="n">cw_err</span><span class="si">}</span><span class="s2">. Using uniform weights.&quot;</span><span class="p">)</span>
                <span class="n">class_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">))</span>
            
            <span class="c1"># --- TEMPORAL SAMPLE WEIGHTS (Decay) ---</span>
            <span class="c1"># Give more weight to recent data (linear decay from 1.0 to 0.5)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Create a time decay factor</span>
                <span class="n">sample_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span>
                <span class="c1"># Linear increase from 0.5 (oldest) to 1.0 (newest)</span>
                <span class="n">time_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">sample_count</span><span class="p">)</span>
                
                <span class="c1"># Combine class weights and time weights</span>
                <span class="c1"># class_weights is already an array of size sample_count (mapped from y)</span>
                <span class="n">combined_weights</span> <span class="o">=</span> <span class="n">class_weights</span> <span class="o">*</span> <span class="n">time_weights</span>
                
                <span class="c1"># Normalize to keep sum roughly same (optional, but good for stability)</span>
                <span class="n">combined_weights</span> <span class="o">=</span> <span class="n">combined_weights</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">combined_weights</span><span class="p">)</span> <span class="o">/</span> <span class="n">combined_weights</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
                
                <span class="n">class_weights</span> <span class="o">=</span> <span class="n">combined_weights</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] ⏳ Applied Temporal Sample Weighting (Old=0.5x -&gt; New=1.0x)&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">tw_err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] Temporal weighting failed: </span><span class="si">{</span><span class="n">tw_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="c1"># --- PHASE 2: MODEL TRAINING ---</span>
            <span class="k">for</span> <span class="n">model_type</span> <span class="ow">in</span> <span class="n">model_types</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stop_training</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span> <span class="k">break</span>
                
                <span class="c1"># --- UNIFIED LOGIC FOR ALL MODELS (Trees + Stacking) ---</span>
                <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="n">timeframe</span><span class="p">,</span> <span class="n">model_type</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">model</span><span class="p">:</span> <span class="k">continue</span>
                
                <span class="c1"># Assign feature names to the model for future alignment</span>
                <span class="n">model</span><span class="o">.</span><span class="n">feature_names</span> <span class="o">=</span> <span class="n">feature_names</span>
                
                <span class="n">log_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">log_training_start</span><span class="p">(</span><span class="n">timeframe</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">is_incremental</span><span class="p">)</span>
                <span class="n">phase_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;train_</span><span class="si">{</span><span class="s1">&#39;xgb&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">model_type</span><span class="o">==</span><span class="s1">&#39;xgboost&#39;</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;lgb&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">model_type</span><span class="o">==</span><span class="s1">&#39;lightgbm&#39;</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;rf&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">model_type</span><span class="o">==</span><span class="s1">&#39;randomforest&#39;</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;cat&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">model_type</span><span class="o">==</span><span class="s1">&#39;catboost&#39;</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;stk&#39;</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_notify</span><span class="p">(</span><span class="s2">&quot;phase_update&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;phase&quot;</span><span class="p">:</span> <span class="n">phase_key</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;active&quot;</span><span class="p">,</span> <span class="s2">&quot;detail&quot;</span><span class="p">:</span> <span class="s2">&quot;Training...&quot;</span><span class="p">})</span>
                
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">acc</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">,</span> <span class="n">class_weights</span><span class="p">)</span>
                    
                    <span class="c1"># --- OUT-OF-SAMPLE EVALUATION (TRUE HOLDOUT) ---</span>
                    <span class="n">test_acc</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># FIX: usage of internal model for raw class prediction</span>
                        <span class="c1"># The wrapper&#39;s .predict() returns (Signal, Confidence), we need classes [0, 1, 2]</span>
                        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;model&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;predict&#39;</span><span class="p">):</span>
                            <span class="n">test_preds</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># Fallback if internal model not accessible (should not happen with our wrappers)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] Cannot access internal model for </span><span class="si">{</span><span class="n">model_type</span><span class="si">}</span><span class="s2">. Skipping test eval.&quot;</span><span class="p">)</span>
                            <span class="n">test_preds</span> <span class="o">=</span> <span class="kc">None</span>

                        <span class="k">if</span> <span class="n">test_preds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="c1"># Handle case where predict returns probabilities instead of classes</span>
                            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">test_preds</span><span class="p">,</span> <span class="s1">&#39;ndim&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">test_preds</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                                <span class="n">test_preds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">test_preds</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                            <span class="n">test_acc</span> <span class="o">=</span> <span class="nb">float</span><span class="p">((</span><span class="n">test_preds</span> <span class="o">==</span> <span class="n">y_test</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] 📊 </span><span class="si">{</span><span class="n">model_type</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> OUT-OF-SAMPLE Accuracy: </span><span class="si">{</span><span class="n">test_acc</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="n">results</span><span class="p">[</span><span class="n">model_type</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;accuracy&quot;</span><span class="p">:</span> <span class="n">acc</span><span class="p">,</span> <span class="s2">&quot;test_accuracy&quot;</span><span class="p">:</span> <span class="n">test_acc</span><span class="p">,</span> <span class="s2">&quot;is_incremental&quot;</span><span class="p">:</span> <span class="n">is_incremental</span><span class="p">}</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">results</span><span class="p">[</span><span class="n">model_type</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;accuracy&quot;</span><span class="p">:</span> <span class="n">acc</span><span class="p">,</span> <span class="s2">&quot;is_incremental&quot;</span><span class="p">:</span> <span class="n">is_incremental</span><span class="p">}</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">eval_err</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] Test evaluation failed: </span><span class="si">{</span><span class="n">eval_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">results</span><span class="p">[</span><span class="n">model_type</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;accuracy&quot;</span><span class="p">:</span> <span class="n">acc</span><span class="p">,</span> <span class="s2">&quot;is_incremental&quot;</span><span class="p">:</span> <span class="n">is_incremental</span><span class="p">}</span>
                    
                    <span class="c1"># Log to database WITH test_accuracy</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">log_training_complete</span><span class="p">(</span><span class="n">log_id</span><span class="p">,</span> <span class="n">sample_count</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="n">test_acc</span><span class="p">)</span>
                        
                    <span class="bp">self</span><span class="o">.</span><span class="n">_notify</span><span class="p">(</span><span class="s2">&quot;phase_update&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;phase&quot;</span><span class="p">:</span> <span class="n">phase_key</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;complete&quot;</span><span class="p">,</span> <span class="s2">&quot;detail&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">acc</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">})</span>
                <span class="k">except</span> <span class="n">RecoveryRequired</span><span class="p">:</span> <span class="k">raise</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">model_type</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> Failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_notify</span><span class="p">(</span><span class="s2">&quot;phase_update&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;phase&quot;</span><span class="p">:</span> <span class="n">phase_key</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;detail&quot;</span><span class="p">:</span> <span class="s2">&quot;Failed&quot;</span><span class="p">})</span>

            <span class="k">return</span> <span class="n">results</span>
            
        <span class="k">except</span> <span class="n">RecoveryRequired</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] Recovery Triggered: Restarting in GLOBAL mode (depth=</span><span class="si">{</span><span class="n">_recovery_depth</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">)...&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_timeframe</span><span class="p">(</span><span class="n">timeframe</span><span class="p">,</span> <span class="n">force_global</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">_recovery_depth</span><span class="o">=</span><span class="n">_recovery_depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Training failed for </span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_training_tf</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_notify</span><span class="p">(</span><span class="s2">&quot;training_complete&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;timeframe&quot;</span><span class="p">:</span> <span class="n">timeframe</span><span class="p">,</span> <span class="s2">&quot;results&quot;</span><span class="p">:</span> <span class="n">results</span><span class="p">})</span></div>


<div class="viewcode-block" id="TrainingManager.train_all">
<a class="viewcode-back" href="../../api/core.html#core.training_manager.TrainingManager.train_all">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">train_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_global</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        HyperSafe Training (V4): Sequential, Memory-Safe Batch Training.</span>
<span class="sd">        </span>
<span class="sd">        Refactored to avoid OOM (Out of Memory) crashes by processing timeframes</span>
<span class="sd">        one-by-one and releasing memory immediately after each cycle.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">gc</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">config.settings</span><span class="w"> </span><span class="kn">import</span> <span class="n">TIMEFRAME_NAMES</span>
        
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🚀 [HyperSafe V4] STARTING RAM-OPTIMIZED TRAINING (ForceGlobal=</span><span class="si">{</span><span class="n">force_global</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_enable_log_bridge</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tf</span> <span class="ow">in</span> <span class="n">TIMEFRAME_NAMES</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stop_training</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span> 
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⏹ Training interrupted by user at timeframe </span><span class="si">{</span><span class="n">tf</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">break</span>
                
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🧵 [HyperSafe] Processing Timeframe: </span><span class="si">{</span><span class="n">tf</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Execute training for this timeframe</span>
                    <span class="c1"># DATA PREPARATION and MODEL FITTING happen inside sequential train_timeframe</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_timeframe</span><span class="p">(</span><span class="n">tf</span><span class="p">,</span> <span class="n">force_global</span><span class="p">)</span>
                    <span class="n">results</span><span class="p">[</span><span class="n">tf</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span>
                    
                    <span class="c1"># LOG SUCCESS</span>
                    <span class="k">if</span> <span class="s2">&quot;error&quot;</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ [</span><span class="si">{</span><span class="n">tf</span><span class="si">}</span><span class="s2">] Training resulted in error: </span><span class="si">{</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ [</span><span class="si">{</span><span class="n">tf</span><span class="si">}</span><span class="s2">] Training completed successfully.&quot;</span><span class="p">)</span>

                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ [HyperSafe] Timeframe </span><span class="si">{</span><span class="n">tf</span><span class="si">}</span><span class="s2"> Failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">results</span><span class="p">[</span><span class="n">tf</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="c1"># CRITICAL: Force garbage collection after EACH timeframe to free RAM</span>
                    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span> <span class="c1"># Give OS time to breathe</span>

            <span class="c1"># --- RESULTS ASSEMBLY ---</span>
            <span class="n">total_success</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">tf</span> <span class="ow">in</span> <span class="n">results</span> <span class="k">if</span> <span class="s2">&quot;error&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">results</span><span class="p">[</span><span class="n">tf</span><span class="p">]</span> <span class="ow">and</span> <span class="n">results</span><span class="p">[</span><span class="n">tf</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;skipped&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🏁 [HyperSafe V4] COMPLETED. Success: </span><span class="si">{</span><span class="n">total_success</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">TIMEFRAME_NAMES</span><span class="p">)</span><span class="si">}</span><span class="s2"> timeframes.&quot;</span><span class="p">)</span>
            
            <span class="c1"># Cleanup features (delete temporary cache if configured)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cleanup_features</span><span class="p">()</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">global_err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ [HyperSafe] Global training loop failed: </span><span class="si">{</span><span class="n">global_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_enable_log_bridge</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
            
        <span class="k">return</span> <span class="n">results</span></div>

    
<div class="viewcode-block" id="TrainingManager.train_with_drift_check">
<a class="viewcode-back" href="../../api/core.html#core.training_manager.TrainingManager.train_with_drift_check">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">train_with_drift_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Train only if drift is detected.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            timeframe: Timeframe to check and potentially train</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Dict with drift status and training results</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get current features for drift check</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mt5</span><span class="o">.</span><span class="n">load_ohlc</span><span class="p">(</span><span class="n">timeframe</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;No data for drift check&quot;</span><span class="p">}</span>
        
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_engine</span><span class="o">.</span><span class="n">calculate_all_features</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">=</span><span class="n">timeframe</span><span class="p">)</span>
        <span class="n">exclude</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">,</span> <span class="s1">&#39;low&#39;</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="s1">&#39;volume&#39;</span><span class="p">]</span>
        <span class="n">feature_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">]</span>
        
        <span class="c1"># Check for drift</span>
        <span class="n">drift_report</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drift_detector</span><span class="o">.</span><span class="n">detect_drift</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">feature_cols</span><span class="p">])</span>
        
        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;drift_detected&quot;</span><span class="p">:</span> <span class="n">drift_report</span><span class="o">.</span><span class="n">drift_detected</span><span class="p">,</span>
            <span class="s2">&quot;should_retrain&quot;</span><span class="p">:</span> <span class="n">drift_report</span><span class="o">.</span><span class="n">should_retrain</span><span class="p">,</span>
            <span class="s2">&quot;psi_score&quot;</span><span class="p">:</span> <span class="n">drift_report</span><span class="o">.</span><span class="n">psi_score</span><span class="p">,</span>
            <span class="s2">&quot;reasons&quot;</span><span class="p">:</span> <span class="n">drift_report</span><span class="o">.</span><span class="n">reasons</span><span class="p">,</span>
        <span class="p">}</span>
        
        <span class="k">if</span> <span class="n">drift_report</span><span class="o">.</span><span class="n">should_retrain</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] Drift detected, triggering retraining: </span><span class="si">{</span><span class="n">drift_report</span><span class="o">.</span><span class="n">reasons</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;training_results&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_timeframe</span><span class="p">(</span><span class="n">timeframe</span><span class="p">,</span> <span class="n">force_global</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] No significant drift detected, skipping retraining&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">result</span></div>

    
<div class="viewcode-block" id="TrainingManager.start_scheduled_training">
<a class="viewcode-back" href="../../api/core.html#core.training_manager.TrainingManager.start_scheduled_training">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">start_scheduled_training</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interval_hours</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">12</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Start scheduled training in background thread&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_thread</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_thread</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Training already running&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_training</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        
        <span class="k">def</span><span class="w"> </span><span class="nf">training_loop</span><span class="p">():</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stop_training</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">is_training</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_notify</span><span class="p">(</span><span class="s2">&quot;scheduled_training_start&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;interval_hours&quot;</span><span class="p">:</span> <span class="n">interval_hours</span><span class="p">})</span>
                
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">train_all</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Scheduled training failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">is_training</span> <span class="o">=</span> <span class="kc">False</span>
                
                <span class="c1"># Wait for next interval</span>
                <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">interval_hours</span> <span class="o">*</span> <span class="mi">3600</span><span class="p">):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stop_training</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                        <span class="k">break</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">training_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">training_loop</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">training_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Started scheduled training every </span><span class="si">{</span><span class="n">interval_hours</span><span class="si">}</span><span class="s2"> hours&quot;</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="TrainingManager.stop_scheduled_training">
<a class="viewcode-back" href="../../api/core.html#core.training_manager.TrainingManager.stop_scheduled_training">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">stop_scheduled_training</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Stop scheduled training&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_training</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_training</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Stopped scheduled training&quot;</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="TrainingManager.load_all_models">
<a class="viewcode-back" href="../../api/core.html#core.training_manager.TrainingManager.load_all_models">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_all_models</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load all saved models from disk&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">tf_name</span> <span class="ow">in</span> <span class="n">TIMEFRAME_NAMES</span><span class="p">:</span>
            <span class="c1"># Load normalizer</span>
            <span class="n">normalizer_path</span> <span class="o">=</span> <span class="n">MODELS_DIR</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;normalizer_</span><span class="si">{</span><span class="n">tf_name</span><span class="si">}</span><span class="s2">.pkl&quot;</span>
            <span class="k">if</span> <span class="n">normalizer_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">normalizers</span><span class="p">[</span><span class="n">tf_name</span><span class="p">]</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">normalizer_path</span><span class="p">)</span>
            
            <span class="c1"># Load models</span>
            <span class="k">for</span> <span class="n">model_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;xgboost&#39;</span><span class="p">,</span> <span class="s1">&#39;lightgbm&#39;</span><span class="p">,</span> <span class="s1">&#39;randomforest&#39;</span><span class="p">,</span> <span class="s1">&#39;stacking&#39;</span><span class="p">]:</span>
                <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="n">tf_name</span><span class="p">,</span> <span class="n">model_type</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">model</span><span class="p">:</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">load</span><span class="p">()</span></div>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">_cleanup_features</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clean up temporary feature parquet files after training to free disk space&quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">config.settings</span><span class="w"> </span><span class="kn">import</span> <span class="n">FEATURES_DIR</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">FEATURES_DIR</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="k">return</span>
            
            <span class="c1"># Count files before cleanup</span>
            <span class="n">parquet_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">FEATURES_DIR</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.parquet&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">parquet_files</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[Cleanup] No feature files to clean up&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            
            <span class="n">total_size_mb</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_size</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">parquet_files</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span>
            <span class="n">file_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">parquet_files</span><span class="p">)</span>
            
            <span class="c1"># Delete all parquet files</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">parquet_files</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🧹 [Cleanup] Deleted </span><span class="si">{</span><span class="n">file_count</span><span class="si">}</span><span class="s2"> feature files (</span><span class="si">{</span><span class="n">total_size_mb</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> MB freed)&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Cleanup] Failed to clean features: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

</pre>
                            </div>

                        </div>
                    </div>
                    <footer>

                        <hr />

                        <div role="contentinfo">
                            <p>&#169; Copyright 2026, BMZ Business, LLC.</p>
                        </div>

                        Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
                        <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
                        provided by <a href="https://readthedocs.org">Read the Docs</a>.


                    </footer>
                </div>
            </div>
        </section>
    </div>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>

</html>