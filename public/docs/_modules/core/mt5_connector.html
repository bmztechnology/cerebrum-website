<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>core.mt5_connector &mdash; Cerebrum Forex Documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=9edc463e" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />


    <link rel="shortcut icon" href="../../_static/icon.ico" />
    <script src="../../_static/jquery.js?v=5d32c60e"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
    <script src="../../_static/documentation_options.js?v=8d563738"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
</head>

<body class="wy-body-for-nav">
    <div class="wy-grid-for-nav">
        <nav data-toggle="wy-nav-shift" class="wy-nav-side">
            <div class="wy-side-scroll">
                <div class="wy-side-nav-search" style="background: #1e293b">



                    <a href="/" class="icon icon-home">
                        Cerebrum Forex
                        <img src="../../_static/icon.ico" class="logo" alt="Logo" />
                    </a>
                    <div role="search">
                        <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
                            <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
                            <input type="hidden" name="check_keywords" value="yes" />
                            <input type="hidden" name="area" value="default" />
                        </form>
                    </div>
                </div>
                <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
                    <p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
                    <ul>
                        <li class="toctree-l1"><a class="reference internal"
                                href="../../installation.html">Installation</a>
                            <ul>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../installation.html#prerequisites">Prerequisites</a></li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../installation.html#installation-via-setup">Installation via Setup</a>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../installation.html#developer-installation">Developer Installation</a>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../installation.html#metatrader-5-configuration">MetaTrader 5
                                        Configuration</a></li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../installation.html#verifying-the-installation">Verifying the
                                        Installation</a></li>
                            </ul>
                        </li>
                        <li class="toctree-l1"><a class="reference internal" href="../../quickstart.html">Quick
                                Start</a>
                            <ul>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../quickstart.html#step-1-connect-to-mt5">Step 1: Connect to MT5</a>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../quickstart.html#step-2-data-extraction">Step 2: Data Extraction</a>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../quickstart.html#step-3-model-training">Step 3: Model Training</a>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../quickstart.html#step-4-predictions">Step 4: Predictions</a></li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../quickstart.html#signal-interpretation">Signal Interpretation</a>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../quickstart.html#next-steps">Next Steps</a></li>
                            </ul>
                        </li>
                        <li class="toctree-l1"><a class="reference internal" href="../../user_manual.html">Manuel
                                Fonctionnel - Cerebrum FX AI</a>
                            <ul>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../user_manual.html#table-des-matieres">Table des matières</a></li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../user_manual.html#dashboard">Dashboard</a>
                                    <ul>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../user_manual.html#sous-onglets-dashboard">Sous-onglets
                                                Dashboard</a></li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../user_manual.html#section-mt5-account-info">Section MT5
                                                Account Info</a></li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../user_manual.html#boutons-d-action">Boutons d’action</a></li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../user_manual.html#open-positions">Open Positions</a></li>
                                    </ul>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../user_manual.html#onglet-prediction">Onglet Prediction</a>
                                    <ul>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../user_manual.html#live-operations">Live Operations</a></li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../user_manual.html#signal">Signal</a></li>
                                    </ul>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../user_manual.html#ea-manager">EA Manager</a>
                                    <ul>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../user_manual.html#onglet-order">Onglet Order</a></li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../user_manual.html#onglet-position">Onglet Position</a></li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../user_manual.html#onglet-risk">Onglet Risk</a></li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../user_manual.html#onglet-prop-firm">Onglet Prop Firm</a></li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../user_manual.html#onglet-trailing">Onglet Trailing</a></li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../user_manual.html#onglet-ea-logs">Onglet EA Logs</a></li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../user_manual.html#onglet-ea-analytics">Onglet EA
                                                Analytics</a></li>
                                    </ul>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../user_manual.html#dashboard-sous-onglets">Dashboard -
                                        Sous-onglets</a>
                                    <ul>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../user_manual.html#onglet-calendar">Onglet Calendar</a></li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../user_manual.html#onglet-signals-chart">Onglet
                                                Signals-Chart</a></li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../user_manual.html#onglet-trading">Onglet Trading</a></li>
                                    </ul>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../user_manual.html#extraction">Extraction</a>
                                    <ul>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../user_manual.html#ohlc-files-tab">OHLC Files Tab</a></li>
                                    </ul>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../user_manual.html#indicators">Indicators</a>
                                    <ul>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../user_manual.html#categories">Catégories</a></li>
                                    </ul>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../user_manual.html#training">Training</a>
                                    <ul>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../user_manual.html#training-pipeline">Training Pipeline</a>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../user_manual.html#boutons">Boutons</a></li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../user_manual.html#model-status">Model Status</a></li>
                                    </ul>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../user_manual.html#settings">Settings</a>
                                    <ul>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../user_manual.html#onglet-general">Onglet General</a></li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../user_manual.html#onglet-data-paths">Onglet Data Paths</a>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../user_manual.html#onglet-ai-signals">Onglet AI Signals</a>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../user_manual.html#onglet-logic-tuning">Onglet Logic
                                                Tuning</a></li>
                                    </ul>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../user_manual.html#raccourcis-et-bonnes-pratiques">Raccourcis et
                                        bonnes pratiques</a>
                                    <ul>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../user_manual.html#workflow-recommande">Workflow
                                                recommandé</a></li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../user_manual.html#tips-prop-firm">Tips Prop Firm</a></li>
                                    </ul>
                                </li>
                            </ul>
                        </li>
                    </ul>
                    <p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
                    <ul>
                        <li class="toctree-l1"><a class="reference internal" href="../../api/core.html">Core Module
                                Reference</a>
                            <ul>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../api/core.html#module-core.mt5_connector">MT5 Connector</a>
                                    <ul>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.mt5_connector.MT5Connector"><code
                                                    class="docutils literal notranslate"><span class="pre">MT5Connector</span></code></a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.mt5_connector.MT5Connector.add_callback"><code
                                                            class="docutils literal notranslate"><span class="pre">MT5Connector.add_callback()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.mt5_connector.MT5Connector.close_all_positions"><code
                                                            class="docutils literal notranslate"><span class="pre">MT5Connector.close_all_positions()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.mt5_connector.MT5Connector.connect"><code
                                                            class="docutils literal notranslate"><span class="pre">MT5Connector.connect()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.mt5_connector.MT5Connector.check_health"><code
                                                            class="docutils literal notranslate"><span class="pre">MT5Connector.check_health()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.mt5_connector.MT5Connector.disconnect"><code
                                                            class="docutils literal notranslate"><span class="pre">MT5Connector.disconnect()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.mt5_connector.MT5Connector.test_connection"><code
                                                            class="docutils literal notranslate"><span class="pre">MT5Connector.test_connection()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.mt5_connector.MT5Connector.preload_history"><code
                                                            class="docutils literal notranslate"><span class="pre">MT5Connector.preload_history()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.mt5_connector.MT5Connector.get_terminal_data_path"><code
                                                            class="docutils literal notranslate"><span class="pre">MT5Connector.get_terminal_data_path()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.mt5_connector.MT5Connector.get_current_server_time"><code
                                                            class="docutils literal notranslate"><span class="pre">MT5Connector.get_current_server_time()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.mt5_connector.MT5Connector.get_server_time"><code
                                                            class="docutils literal notranslate"><span class="pre">MT5Connector.get_server_time()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.mt5_connector.MT5Connector.get_time_offset"><code
                                                            class="docutils literal notranslate"><span class="pre">MT5Connector.get_time_offset()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.mt5_connector.MT5Connector.get_account_info"><code
                                                            class="docutils literal notranslate"><span class="pre">MT5Connector.get_account_info()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.mt5_connector.MT5Connector.get_market_status"><code
                                                            class="docutils literal notranslate"><span class="pre">MT5Connector.get_market_status()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.mt5_connector.MT5Connector.get_ohlc_path"><code
                                                            class="docutils literal notranslate"><span class="pre">MT5Connector.get_ohlc_path()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.mt5_connector.MT5Connector.extract_ohlc"><code
                                                            class="docutils literal notranslate"><span class="pre">MT5Connector.extract_ohlc()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.mt5_connector.MT5Connector.update_all_ohlc"><code
                                                            class="docutils literal notranslate"><span class="pre">MT5Connector.update_all_ohlc()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.mt5_connector.MT5Connector.get_buffer"><code
                                                            class="docutils literal notranslate"><span class="pre">MT5Connector.get_buffer()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.mt5_connector.MT5Connector.get_latest_candles"><code
                                                            class="docutils literal notranslate"><span class="pre">MT5Connector.get_latest_candles()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.mt5_connector.MT5Connector.load_ohlc"><code
                                                            class="docutils literal notranslate"><span class="pre">MT5Connector.load_ohlc()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.mt5_connector.MT5Connector.load_ohlc_buffer"><code
                                                            class="docutils literal notranslate"><span class="pre">MT5Connector.load_ohlc_buffer()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.mt5_connector.MT5Connector.get_ohlc_status"><code
                                                            class="docutils literal notranslate"><span class="pre">MT5Connector.get_ohlc_status()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.mt5_connector.MT5Connector.extract_all"><code
                                                            class="docutils literal notranslate"><span class="pre">MT5Connector.extract_all()</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.mt5_connector.get_mt5_connector"><code
                                                    class="docutils literal notranslate"><span class="pre">get_mt5_connector()</span></code></a>
                                        </li>
                                    </ul>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../api/core.html#module-core.prediction_engine">Prediction Engine</a>
                                    <ul>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.prediction_engine.PredictionEngine"><code
                                                    class="docutils literal notranslate"><span class="pre">PredictionEngine</span></code></a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.prediction_engine.PredictionEngine.add_callback"><code
                                                            class="docutils literal notranslate"><span class="pre">PredictionEngine.add_callback()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.prediction_engine.PredictionEngine.remove_callback"><code
                                                            class="docutils literal notranslate"><span class="pre">PredictionEngine.remove_callback()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.prediction_engine.PredictionEngine.get_signal_path"><code
                                                            class="docutils literal notranslate"><span class="pre">PredictionEngine.get_signal_path()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.prediction_engine.PredictionEngine.get_enabled_models"><code
                                                            class="docutils literal notranslate"><span class="pre">PredictionEngine.get_enabled_models()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.prediction_engine.PredictionEngine.predict_timeframe"><code
                                                            class="docutils literal notranslate"><span class="pre">PredictionEngine.predict_timeframe()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.prediction_engine.PredictionEngine.load_signal"><code
                                                            class="docutils literal notranslate"><span class="pre">PredictionEngine.load_signal()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.prediction_engine.PredictionEngine.reset_engine"><code
                                                            class="docutils literal notranslate"><span class="pre">PredictionEngine.reset_engine()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.prediction_engine.PredictionEngine.predict_all"><code
                                                            class="docutils literal notranslate"><span class="pre">PredictionEngine.predict_all()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.prediction_engine.PredictionEngine.get_prediction_status"><code
                                                            class="docutils literal notranslate"><span class="pre">PredictionEngine.get_prediction_status()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.prediction_engine.PredictionEngine.get_combined_signal"><code
                                                            class="docutils literal notranslate"><span class="pre">PredictionEngine.get_combined_signal()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.prediction_engine.PredictionEngine.get_congress_history"><code
                                                            class="docutils literal notranslate"><span class="pre">PredictionEngine.get_congress_history()</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                    </ul>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../api/core.html#module-core.training_manager">Training Manager</a>
                                    <ul>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.training_manager.TrainingLogBridge"><code
                                                    class="docutils literal notranslate"><span class="pre">TrainingLogBridge</span></code></a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.training_manager.TrainingLogBridge.emit"><code
                                                            class="docutils literal notranslate"><span class="pre">TrainingLogBridge.emit()</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.training_manager.RecoveryRequired"><code
                                                    class="docutils literal notranslate"><span class="pre">RecoveryRequired</span></code></a>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.training_manager.TrainingManager"><code
                                                    class="docutils literal notranslate"><span class="pre">TrainingManager</span></code></a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.training_manager.TrainingManager.add_callback"><code
                                                            class="docutils literal notranslate"><span class="pre">TrainingManager.add_callback()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.training_manager.TrainingManager.get_model"><code
                                                            class="docutils literal notranslate"><span class="pre">TrainingManager.get_model()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.training_manager.TrainingManager.get_normalizer"><code
                                                            class="docutils literal notranslate"><span class="pre">TrainingManager.get_normalizer()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.training_manager.TrainingManager.get_training_status"><code
                                                            class="docutils literal notranslate"><span class="pre">TrainingManager.get_training_status()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.training_manager.TrainingManager.should_train_incremental"><code
                                                            class="docutils literal notranslate"><span class="pre">TrainingManager.should_train_incremental()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.training_manager.TrainingManager.prepare_training_data"><code
                                                            class="docutils literal notranslate"><span class="pre">TrainingManager.prepare_training_data()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.training_manager.TrainingManager.train_timeframe"><code
                                                            class="docutils literal notranslate"><span class="pre">TrainingManager.train_timeframe()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.training_manager.TrainingManager.train_all"><code
                                                            class="docutils literal notranslate"><span class="pre">TrainingManager.train_all()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.training_manager.TrainingManager.train_with_drift_check"><code
                                                            class="docutils literal notranslate"><span class="pre">TrainingManager.train_with_drift_check()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.training_manager.TrainingManager.start_scheduled_training"><code
                                                            class="docutils literal notranslate"><span class="pre">TrainingManager.start_scheduled_training()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.training_manager.TrainingManager.stop_scheduled_training"><code
                                                            class="docutils literal notranslate"><span class="pre">TrainingManager.stop_scheduled_training()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.training_manager.TrainingManager.load_all_models"><code
                                                            class="docutils literal notranslate"><span class="pre">TrainingManager.load_all_models()</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                    </ul>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../api/core.html#module-core.feature_engine">Feature Engine</a>
                                    <ul>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.feature_engine.FeatureEngine"><code
                                                    class="docutils literal notranslate"><span class="pre">FeatureEngine</span></code></a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.feature_engine.FeatureEngine.calculate_all_features"><code
                                                            class="docutils literal notranslate"><span class="pre">FeatureEngine.calculate_all_features()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.feature_engine.FeatureEngine.get_feature_columns"><code
                                                            class="docutils literal notranslate"><span class="pre">FeatureEngine.get_feature_columns()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.feature_engine.FeatureEngine.select_best_features"><code
                                                            class="docutils literal notranslate"><span class="pre">FeatureEngine.select_best_features()</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                    </ul>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../api/core.html#module-core.app_controller">App Controller</a>
                                    <ul>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.app_controller.AppController"><code
                                                    class="docutils literal notranslate"><span class="pre">AppController</span></code></a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.app_controller.AppController.mt5"><code
                                                            class="docutils literal notranslate"><span class="pre">AppController.mt5</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.app_controller.AppController.training_manager"><code
                                                            class="docutils literal notranslate"><span class="pre">AppController.training_manager</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.app_controller.AppController.prediction_engine"><code
                                                            class="docutils literal notranslate"><span class="pre">AppController.prediction_engine</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.app_controller.AppController.scheduler"><code
                                                            class="docutils literal notranslate"><span class="pre">AppController.scheduler</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.app_controller.AppController.start"><code
                                                            class="docutils literal notranslate"><span class="pre">AppController.start()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.app_controller.AppController.stop"><code
                                                            class="docutils literal notranslate"><span class="pre">AppController.stop()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.app_controller.AppController.extract_all"><code
                                                            class="docutils literal notranslate"><span class="pre">AppController.extract_all()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.app_controller.AppController.predict_manual"><code
                                                            class="docutils literal notranslate"><span class="pre">AppController.predict_manual()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.app_controller.AppController.train_all"><code
                                                            class="docutils literal notranslate"><span class="pre">AppController.train_all()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.app_controller.AppController.predict_all"><code
                                                            class="docutils literal notranslate"><span class="pre">AppController.predict_all()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.app_controller.AppController.get_signal"><code
                                                            class="docutils literal notranslate"><span class="pre">AppController.get_signal()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.app_controller.AppController.get_combined_signal"><code
                                                            class="docutils literal notranslate"><span class="pre">AppController.get_combined_signal()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.app_controller.AppController.get_ohlc_status"><code
                                                            class="docutils literal notranslate"><span class="pre">AppController.get_ohlc_status()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.app_controller.AppController.get_training_status"><code
                                                            class="docutils literal notranslate"><span class="pre">AppController.get_training_status()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.app_controller.AppController.get_model"><code
                                                            class="docutils literal notranslate"><span class="pre">AppController.get_model()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.app_controller.AppController.get_settings"><code
                                                            class="docutils literal notranslate"><span class="pre">AppController.get_settings()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.app_controller.AppController.get_cached_account_info"><code
                                                            class="docutils literal notranslate"><span class="pre">AppController.get_cached_account_info()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.app_controller.AppController.save_settings"><code
                                                            class="docutils literal notranslate"><span class="pre">AppController.save_settings()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.app_controller.AppController.get_congress_config"><code
                                                            class="docutils literal notranslate"><span class="pre">AppController.get_congress_config()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.app_controller.AppController.save_congress_config"><code
                                                            class="docutils literal notranslate"><span class="pre">AppController.save_congress_config()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.app_controller.AppController.update_scheduler_config"><code
                                                            class="docutils literal notranslate"><span class="pre">AppController.update_scheduler_config()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.app_controller.AppController.sync_ea_config"><code
                                                            class="docutils literal notranslate"><span class="pre">AppController.sync_ea_config()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.app_controller.AppController.log_training_event"><code
                                                            class="docutils literal notranslate"><span class="pre">AppController.log_training_event()</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                    </ul>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../api/core.html#module-core.noble_kpi">Noble KPI</a>
                                    <ul>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#noble-safe-range-kpi-core-module">Noble Safe
                                                Range KPI - Core Module</a></li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.noble_kpi.MarketRegime"><code
                                                    class="docutils literal notranslate"><span class="pre">MarketRegime</span></code></a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.noble_kpi.MarketRegime.NORMAL"><code
                                                            class="docutils literal notranslate"><span class="pre">MarketRegime.NORMAL</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.noble_kpi.MarketRegime.LOW_VOL"><code
                                                            class="docutils literal notranslate"><span class="pre">MarketRegime.LOW_VOL</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.noble_kpi.MarketRegime.HIGH_VOL"><code
                                                            class="docutils literal notranslate"><span class="pre">MarketRegime.HIGH_VOL</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.noble_kpi.MarketRegime.CRISIS"><code
                                                            class="docutils literal notranslate"><span class="pre">MarketRegime.CRISIS</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.noble_kpi.calculate_atr_series"><code
                                                    class="docutils literal notranslate"><span class="pre">calculate_atr_series()</span></code></a>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.noble_kpi.detect_regime_series"><code
                                                    class="docutils literal notranslate"><span class="pre">detect_regime_series()</span></code></a>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.noble_kpi.calculate_atr"><code
                                                    class="docutils literal notranslate"><span class="pre">calculate_atr()</span></code></a>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.noble_kpi.detect_regime"><code
                                                    class="docutils literal notranslate"><span class="pre">detect_regime()</span></code></a>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.noble_kpi.noble_safe_range"><code
                                                    class="docutils literal notranslate"><span class="pre">noble_safe_range()</span></code></a>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.noble_kpi.calculate_position"><code
                                                    class="docutils literal notranslate"><span class="pre">calculate_position()</span></code></a>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.noble_kpi.get_recommendation"><code
                                                    class="docutils literal notranslate"><span class="pre">get_recommendation()</span></code></a>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.noble_kpi.analyze_timeframe"><code
                                                    class="docutils literal notranslate"><span class="pre">analyze_timeframe()</span></code></a>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.noble_kpi.validate_kpi"><code
                                                    class="docutils literal notranslate"><span class="pre">validate_kpi()</span></code></a>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.noble_kpi.calculate_noble_bias"><code
                                                    class="docutils literal notranslate"><span class="pre">calculate_noble_bias()</span></code></a>
                                        </li>
                                    </ul>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../api/core.html#module-core.congress_engine">Congress Engine</a>
                                    <ul>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.congress_engine.AladdinPersona"><code
                                                    class="docutils literal notranslate"><span class="pre">AladdinPersona</span></code></a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.AladdinPersona.QUANT"><code
                                                            class="docutils literal notranslate"><span class="pre">AladdinPersona.QUANT</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.AladdinPersona.ARCHIVIST"><code
                                                            class="docutils literal notranslate"><span class="pre">AladdinPersona.ARCHIVIST</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.AladdinPersona.FUTURIST"><code
                                                            class="docutils literal notranslate"><span class="pre">AladdinPersona.FUTURIST</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.AladdinPersona.GUARDIAN"><code
                                                            class="docutils literal notranslate"><span class="pre">AladdinPersona.GUARDIAN</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.AladdinPersona.LEADER"><code
                                                            class="docutils literal notranslate"><span class="pre">AladdinPersona.LEADER</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.AladdinPersona.SENTINEL"><code
                                                            class="docutils literal notranslate"><span class="pre">AladdinPersona.SENTINEL</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.congress_engine.ModelPrediction"><code
                                                    class="docutils literal notranslate"><span class="pre">ModelPrediction</span></code></a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.ModelPrediction.model_name"><code
                                                            class="docutils literal notranslate"><span class="pre">ModelPrediction.model_name</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.ModelPrediction.model_role"><code
                                                            class="docutils literal notranslate"><span class="pre">ModelPrediction.model_role</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.ModelPrediction.score"><code
                                                            class="docutils literal notranslate"><span class="pre">ModelPrediction.score</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.ModelPrediction.confidence"><code
                                                            class="docutils literal notranslate"><span class="pre">ModelPrediction.confidence</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.ModelPrediction.regime"><code
                                                            class="docutils literal notranslate"><span class="pre">ModelPrediction.regime</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.ModelPrediction.timeframe"><code
                                                            class="docutils literal notranslate"><span class="pre">ModelPrediction.timeframe</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.ModelPrediction.timestamp"><code
                                                            class="docutils literal notranslate"><span class="pre">ModelPrediction.timestamp</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.congress_engine.CongressDecision"><code
                                                    class="docutils literal notranslate"><span class="pre">CongressDecision</span></code></a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressDecision.final_signal"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressDecision.final_signal</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressDecision.final_score"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressDecision.final_score</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressDecision.final_confidence"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressDecision.final_confidence</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressDecision.detected_regime"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressDecision.detected_regime</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressDecision.certainty_boost"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressDecision.certainty_boost</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressDecision.flux_boost"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressDecision.flux_boost</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressDecision.trend_certainty"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressDecision.trend_certainty</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressDecision.duration_tf5"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressDecision.duration_tf5</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressDecision.threshold"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressDecision.threshold</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressDecision.model_predictions"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressDecision.model_predictions</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressDecision.flux_details"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressDecision.flux_details</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressDecision.weights_applied"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressDecision.weights_applied</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressDecision.timestamp"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressDecision.timestamp</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressDecision.override_type"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressDecision.override_type</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressDecision.to_dict"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressDecision.to_dict()</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.congress_engine.CongressEngine"><code
                                                    class="docutils literal notranslate"><span class="pre">CongressEngine</span></code></a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressEngine.CONGRESS_WEIGHTS"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressEngine.CONGRESS_WEIGHTS</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressEngine.DEFAULT_WEIGHTS"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressEngine.DEFAULT_WEIGHTS</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressEngine.BASE_THRESHOLD"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressEngine.BASE_THRESHOLD</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressEngine.LAMBDA"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressEngine.LAMBDA</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressEngine.KPI_GAMMA"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressEngine.KPI_GAMMA</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressEngine.CERTAINTY_BONUS"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressEngine.CERTAINTY_BONUS</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressEngine.__init__"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressEngine.__init__()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressEngine.detect_market_regime"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressEngine.detect_market_regime()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressEngine.calculate_adaptive_threshold"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressEngine.calculate_adaptive_threshold()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressEngine.get_weights"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressEngine.get_weights()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressEngine.aggregate"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressEngine.aggregate()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressEngine.get_decision_history"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressEngine.get_decision_history()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressEngine.simple_aggregate"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressEngine.simple_aggregate()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressEngine.make_decision_batch"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressEngine.make_decision_batch()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressEngine.aggregate_with_regime"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressEngine.aggregate_with_regime()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressEngine.full_aggregate"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressEngine.full_aggregate()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressEngine.save_prediction_json"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressEngine.save_prediction_json()</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.congress_engine.get_congress_engine"><code
                                                    class="docutils literal notranslate"><span class="pre">get_congress_engine()</span></code></a>
                                        </li>
                                    </ul>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../api/core.html#module-core.model_scorer">Model Scorer</a>
                                    <ul>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.model_scorer.PredictionOutcome"><code
                                                    class="docutils literal notranslate"><span class="pre">PredictionOutcome</span></code></a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.model_scorer.PredictionOutcome.model_name"><code
                                                            class="docutils literal notranslate"><span class="pre">PredictionOutcome.model_name</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.model_scorer.PredictionOutcome.timeframe"><code
                                                            class="docutils literal notranslate"><span class="pre">PredictionOutcome.timeframe</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.model_scorer.PredictionOutcome.predicted_signal"><code
                                                            class="docutils literal notranslate"><span class="pre">PredictionOutcome.predicted_signal</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.model_scorer.PredictionOutcome.actual_outcome"><code
                                                            class="docutils literal notranslate"><span class="pre">PredictionOutcome.actual_outcome</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.model_scorer.PredictionOutcome.confidence"><code
                                                            class="docutils literal notranslate"><span class="pre">PredictionOutcome.confidence</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.model_scorer.PredictionOutcome.timestamp"><code
                                                            class="docutils literal notranslate"><span class="pre">PredictionOutcome.timestamp</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.model_scorer.ModelScorer"><code
                                                    class="docutils literal notranslate"><span class="pre">ModelScorer</span></code></a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.model_scorer.ModelScorer.HISTORY_SIZE"><code
                                                            class="docutils literal notranslate"><span class="pre">ModelScorer.HISTORY_SIZE</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.model_scorer.ModelScorer.MIN_SAMPLES"><code
                                                            class="docutils literal notranslate"><span class="pre">ModelScorer.MIN_SAMPLES</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.model_scorer.ModelScorer.DYNAMIC_WEIGHT"><code
                                                            class="docutils literal notranslate"><span class="pre">ModelScorer.DYNAMIC_WEIGHT</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.model_scorer.ModelScorer.EMA_ALPHA"><code
                                                            class="docutils literal notranslate"><span class="pre">ModelScorer.EMA_ALPHA</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.model_scorer.ModelScorer.record_outcome"><code
                                                            class="docutils literal notranslate"><span class="pre">ModelScorer.record_outcome()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.model_scorer.ModelScorer.get_dynamic_weights"><code
                                                            class="docutils literal notranslate"><span class="pre">ModelScorer.get_dynamic_weights()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.model_scorer.ModelScorer.get_model_stats"><code
                                                            class="docutils literal notranslate"><span class="pre">ModelScorer.get_model_stats()</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.model_scorer.get_model_scorer"><code
                                                    class="docutils literal notranslate"><span class="pre">get_model_scorer()</span></code></a>
                                        </li>
                                    </ul>
                                </li>
                            </ul>
                        </li>
                        <li class="toctree-l1"><a class="reference internal" href="../../api/models.html">Models
                                Reference</a>
                            <ul>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../api/models.html#module-models.xgboost_model">XGBoost Model</a>
                                    <ul>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/models.html#models.xgboost_model.XGBoostModel"><code
                                                    class="docutils literal notranslate"><span class="pre">XGBoostModel</span></code></a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/models.html#models.xgboost_model.XGBoostModel.name"><code
                                                            class="docutils literal notranslate"><span class="pre">XGBoostModel.name</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/models.html#models.xgboost_model.XGBoostModel.train"><code
                                                            class="docutils literal notranslate"><span class="pre">XGBoostModel.train()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/models.html#models.xgboost_model.XGBoostModel.predict"><code
                                                            class="docutils literal notranslate"><span class="pre">XGBoostModel.predict()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/models.html#models.xgboost_model.XGBoostModel.load"><code
                                                            class="docutils literal notranslate"><span class="pre">XGBoostModel.load()</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                    </ul>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../api/models.html#module-models.lightgbm_model">LightGBM Model</a>
                                    <ul>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/models.html#models.lightgbm_model.LightGBMModel"><code
                                                    class="docutils literal notranslate"><span class="pre">LightGBMModel</span></code></a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/models.html#models.lightgbm_model.LightGBMModel.name"><code
                                                            class="docutils literal notranslate"><span class="pre">LightGBMModel.name</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/models.html#models.lightgbm_model.LightGBMModel.train"><code
                                                            class="docutils literal notranslate"><span class="pre">LightGBMModel.train()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/models.html#models.lightgbm_model.LightGBMModel.predict"><code
                                                            class="docutils literal notranslate"><span class="pre">LightGBMModel.predict()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/models.html#models.lightgbm_model.LightGBMModel.load"><code
                                                            class="docutils literal notranslate"><span class="pre">LightGBMModel.load()</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                    </ul>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../api/models.html#module-models.randomforest_model">RandomForest
                                        Model</a>
                                    <ul>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/models.html#models.randomforest_model.RandomForestModel"><code
                                                    class="docutils literal notranslate"><span class="pre">RandomForestModel</span></code></a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/models.html#models.randomforest_model.RandomForestModel.name"><code
                                                            class="docutils literal notranslate"><span class="pre">RandomForestModel.name</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/models.html#models.randomforest_model.RandomForestModel.train"><code
                                                            class="docutils literal notranslate"><span class="pre">RandomForestModel.train()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/models.html#models.randomforest_model.RandomForestModel.predict"><code
                                                            class="docutils literal notranslate"><span class="pre">RandomForestModel.predict()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/models.html#models.randomforest_model.RandomForestModel.load"><code
                                                            class="docutils literal notranslate"><span class="pre">RandomForestModel.load()</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                    </ul>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../api/models.html#module-models.stacking_model">Stacking Model</a>
                                    <ul>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/models.html#models.stacking_model.StackingModel"><code
                                                    class="docutils literal notranslate"><span class="pre">StackingModel</span></code></a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/models.html#models.stacking_model.StackingModel.name"><code
                                                            class="docutils literal notranslate"><span class="pre">StackingModel.name</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/models.html#models.stacking_model.StackingModel.train"><code
                                                            class="docutils literal notranslate"><span class="pre">StackingModel.train()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/models.html#models.stacking_model.StackingModel.predict"><code
                                                            class="docutils literal notranslate"><span class="pre">StackingModel.predict()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/models.html#models.stacking_model.StackingModel.load"><code
                                                            class="docutils literal notranslate"><span class="pre">StackingModel.load()</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                    </ul>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../api/models.html#module-models.meta_model">Meta Model</a>
                                    <ul>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/models.html#models.meta_model.MetaModel"><code
                                                    class="docutils literal notranslate"><span class="pre">MetaModel</span></code></a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/models.html#models.meta_model.MetaModel.prepare_meta_features"><code
                                                            class="docutils literal notranslate"><span class="pre">MetaModel.prepare_meta_features()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/models.html#models.meta_model.MetaModel.train"><code
                                                            class="docutils literal notranslate"><span class="pre">MetaModel.train()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/models.html#models.meta_model.MetaModel.predict_viability"><code
                                                            class="docutils literal notranslate"><span class="pre">MetaModel.predict_viability()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/models.html#models.meta_model.MetaModel.save"><code
                                                            class="docutils literal notranslate"><span class="pre">MetaModel.save()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/models.html#models.meta_model.MetaModel.load"><code
                                                            class="docutils literal notranslate"><span class="pre">MetaModel.load()</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                    </ul>
                                </li>
                            </ul>
                        </li>
                        <li class="toctree-l1"><a class="reference internal" href="../../api/gui.html">GUI Reference</a>
                            <ul>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../api/gui.html#module-gui.main_window">Main Window</a>
                                    <ul>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/gui.html#gui.main_window.MainWindow"><code
                                                    class="docutils literal notranslate"><span class="pre">MainWindow</span></code></a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/gui.html#gui.main_window.MainWindow.status_changed"><code
                                                            class="docutils literal notranslate"><span class="pre">MainWindow.status_changed</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/gui.html#gui.main_window.MainWindow.update_signal_display"><code
                                                            class="docutils literal notranslate"><span class="pre">MainWindow.update_signal_display()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/gui.html#gui.main_window.MainWindow.closeEvent"><code
                                                            class="docutils literal notranslate"><span class="pre">MainWindow.closeEvent()</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                    </ul>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../api/gui.html#panels">Panels</a>
                                    <ul>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/gui.html#module-gui.panels.dashboard_panel">Dashboard
                                                Panel</a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/gui.html#gui.panels.dashboard_panel.PredictionWorker"><code
                                                            class="docutils literal notranslate"><span class="pre">PredictionWorker</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/gui.html#gui.panels.dashboard_panel.DashboardPanel"><code
                                                            class="docutils literal notranslate"><span class="pre">DashboardPanel</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/gui.html#module-gui.panels.extraction_panel">Extraction
                                                Panel</a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/gui.html#gui.panels.extraction_panel.ExtractionPanel"><code
                                                            class="docutils literal notranslate"><span class="pre">ExtractionPanel</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/gui.html#module-gui.panels.training_panel">Training
                                                Panel</a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/gui.html#gui.panels.training_panel.TrainingSignals"><code
                                                            class="docutils literal notranslate"><span class="pre">TrainingSignals</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/gui.html#gui.panels.training_panel.PhaseCard"><code
                                                            class="docutils literal notranslate"><span class="pre">PhaseCard</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/gui.html#gui.panels.training_panel.TrainingPanel"><code
                                                            class="docutils literal notranslate"><span class="pre">TrainingPanel</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/gui.html#gui.panels.training_panel.SchedulerDialog"><code
                                                            class="docutils literal notranslate"><span class="pre">SchedulerDialog</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/gui.html#module-gui.panels.prediction_panel">Prediction
                                                Panel</a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/gui.html#gui.panels.prediction_panel.PredictionPanel"><code
                                                            class="docutils literal notranslate"><span class="pre">PredictionPanel</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/gui.html#module-gui.panels.settings_panel">Settings
                                                Panel</a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/gui.html#gui.panels.settings_panel.SettingsPanel"><code
                                                            class="docutils literal notranslate"><span class="pre">SettingsPanel</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                    </ul>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../api/gui.html#workers">Workers</a>
                                    <ul>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/gui.html#module-gui.workers.prediction_worker">Prediction
                                                Worker</a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/gui.html#gui.workers.prediction_worker.PredictionWorker"><code
                                                            class="docutils literal notranslate"><span class="pre">PredictionWorker</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                    </ul>
                                </li>
                            </ul>
                        </li>
                    </ul>
                    <p class="caption" role="heading"><span class="caption-text">Resources</span></p>
                    <ul>
                        <li class="toctree-l1"><a class="reference internal" href="../../changelog.html">Changelog</a>
                            <ul>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../changelog.html#version-1-0-0-january-2026">Version 1.0.0 (January
                                        2026)</a>
                                    <ul>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../changelog.html#new-features">New Features</a></li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../changelog.html#improvements">Improvements</a></li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../changelog.html#bug-fixes">Bug Fixes</a></li>
                                    </ul>
                                </li>
                            </ul>
                        </li>
                        <li class="toctree-l1"><a class="reference internal"
                                href="../../contributing.html">Contributing</a>
                            <ul>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../contributing.html#how-to-contribute">How to Contribute</a></li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../contributing.html#code-style">Code Style</a></li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../contributing.html#reporting-bugs">Reporting Bugs</a></li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../contributing.html#contact">Contact</a></li>
                            </ul>
                        </li>
                        <li class="toctree-l1"><a class="reference internal" href="../../sphinx_tech.html">Sphinx
                                Documentation System</a>
                            <ul>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../sphinx_tech.html#sphinx-engine">⚙️ Sphinx Engine</a></li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../sphinx_tech.html#parsing">🔍 Parsing</a></li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../sphinx_tech.html#reference-resolution">🔗 Reference Resolution</a>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../sphinx_tech.html#tree-generation-rtd-theme">🌳 Tree Generation (RTD
                                        Theme)</a></li>
                            </ul>
                        </li>
                    </ul>

                </div>
            </div>
        </nav>

        <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
            <nav class="wy-nav-top" aria-label="Mobile navigation menu" style="background: #1e293b">
                <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
                <a href="../../index.html">Cerebrum Forex</a>
            </nav>

            <div class="wy-nav-content">
                <div class="rst-content">
                    <div role="navigation" aria-label="Page navigation">
                        <ul class="wy-breadcrumbs">
                            <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
                            <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
                            <li class="breadcrumb-item active">core.mt5_connector</li>
                            <li class="wy-breadcrumbs-aside">
                            </li>
                        </ul>
                        <hr />
                    </div>
                    <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
                        <div itemprop="articleBody">

                            <h1>Source code for core.mt5_connector</h1>
                            <div class="highlight">
                                <pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Cerebrum Forex - MT5 Connector</span>
<span class="sd">Handles connection to MetaTrader 5 and OHLC data extraction.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">threading</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">MetaTrader5</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mt5</span>
    <span class="n">MT5_AVAILABLE</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">MT5_AVAILABLE</span> <span class="o">=</span> <span class="kc">False</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">config.settings</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">TIMEFRAMES</span><span class="p">,</span> 
    <span class="n">OHLC_DIR</span><span class="p">,</span> 
    <span class="n">get_timeframe_by_name</span><span class="p">,</span>
    <span class="n">TimeframeConfig</span><span class="p">,</span>
    <span class="n">default_settings</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">database</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_database</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">core.debug_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_debug_manager</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">core.sentinel</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_sentinel</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="MT5Connector">
<a class="viewcode-back" href="../../api/core.html#core.mt5_connector.MT5Connector">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">MT5Connector</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;MetaTrader 5 connector for OHLC data extraction&quot;&quot;&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;EURUSD&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">symbol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connected</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_callbacks</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Locks for thread safety</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">RLock</span><span class="p">()</span>  <span class="c1"># For MT5 connection/API</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>  <span class="c1"># For file I/O (CSV)</span>
        
        <span class="c1"># Paths (Populated on connect)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">terminal_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="c1"># Ensure OHLC directory exists</span>
        <span class="n">OHLC_DIR</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
<div class="viewcode-block" id="MT5Connector.add_callback">
<a class="viewcode-back" href="../../api/core.html#core.mt5_connector.MT5Connector.add_callback">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add callback for status updates&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_callbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span></div>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">_notify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Notify all callbacks&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_callbacks</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">callback</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Callback error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    
<div class="viewcode-block" id="MT5Connector.close_all_positions">
<a class="viewcode-back" href="../../api/core.html#core.mt5_connector.MT5Connector.close_all_positions">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">close_all_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        PANIC BUTTON: Close all open positions immediately.</span>
<span class="sd">        Returns: (closed_count, error_count)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">closed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">():</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Cannot close positions: MT5 disonnected&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
                
            <span class="n">positions</span> <span class="o">=</span> <span class="n">mt5</span><span class="o">.</span><span class="n">positions_get</span><span class="p">(</span><span class="n">symbol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">positions</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No open positions to close.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
                
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🚨 PANIC CLOSE INITIATED: Closing </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span><span class="si">}</span><span class="s2"> positions...&quot;</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">positions</span><span class="p">:</span>
                <span class="c1"># Close Logic: Send opposite order</span>
                <span class="n">order_type</span> <span class="o">=</span> <span class="n">mt5</span><span class="o">.</span><span class="n">ORDER_TYPE_SELL</span> <span class="k">if</span> <span class="n">pos</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">mt5</span><span class="o">.</span><span class="n">ORDER_TYPE_BUY</span> <span class="k">else</span> <span class="n">mt5</span><span class="o">.</span><span class="n">ORDER_TYPE_BUY</span>
                <span class="n">price</span> <span class="o">=</span> <span class="n">mt5</span><span class="o">.</span><span class="n">symbol_info_tick</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span><span class="o">.</span><span class="n">bid</span> <span class="k">if</span> <span class="n">order_type</span> <span class="o">==</span> <span class="n">mt5</span><span class="o">.</span><span class="n">ORDER_TYPE_SELL</span> <span class="k">else</span> <span class="n">mt5</span><span class="o">.</span><span class="n">symbol_info_tick</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span><span class="o">.</span><span class="n">ask</span>
                
                <span class="n">request</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">mt5</span><span class="o">.</span><span class="n">TRADE_ACTION_DEAL</span><span class="p">,</span>
                    <span class="s2">&quot;symbol&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span>
                    <span class="s2">&quot;volume&quot;</span><span class="p">:</span> <span class="n">pos</span><span class="o">.</span><span class="n">volume</span><span class="p">,</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">order_type</span><span class="p">,</span>
                    <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="n">pos</span><span class="o">.</span><span class="n">ticket</span><span class="p">,</span>
                    <span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="n">price</span><span class="p">,</span>
                    <span class="s2">&quot;deviation&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
                    <span class="s2">&quot;magic&quot;</span><span class="p">:</span> <span class="mi">234000</span><span class="p">,</span>
                    <span class="s2">&quot;comment&quot;</span><span class="p">:</span> <span class="s2">&quot;panic_close&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;type_time&quot;</span><span class="p">:</span> <span class="n">mt5</span><span class="o">.</span><span class="n">ORDER_TIME_GTC</span><span class="p">,</span>
                    <span class="s2">&quot;type_filling&quot;</span><span class="p">:</span> <span class="n">mt5</span><span class="o">.</span><span class="n">ORDER_FILLING_IOC</span><span class="p">,</span>
                <span class="p">}</span>
                
                <span class="n">result</span> <span class="o">=</span> <span class="n">mt5</span><span class="o">.</span><span class="n">order_send</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">retcode</span> <span class="o">!=</span> <span class="n">mt5</span><span class="o">.</span><span class="n">TRADE_RETCODE_DONE</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to close ticket </span><span class="si">{</span><span class="n">pos</span><span class="o">.</span><span class="n">ticket</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">comment</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">errors</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Closed ticket </span><span class="si">{</span><span class="n">pos</span><span class="o">.</span><span class="n">ticket</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">pos</span><span class="o">.</span><span class="n">profit</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                    <span class="n">closed</span> <span class="o">+=</span> <span class="mi">1</span>
                    
        <span class="k">return</span> <span class="n">closed</span><span class="p">,</span> <span class="n">errors</span></div>


<div class="viewcode-block" id="MT5Connector.connect">
<a class="viewcode-back" href="../../api/core.html#core.mt5_connector.MT5Connector.connect">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Connect to MT5 terminal with timeout protection&quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">concurrent.futures</span><span class="w"> </span><span class="kn">import</span> <span class="n">ThreadPoolExecutor</span><span class="p">,</span> <span class="ne">TimeoutError</span> <span class="k">as</span> <span class="n">FuturesTimeout</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
            
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">MT5_AVAILABLE</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;MetaTrader5 package not installed&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
            
            <span class="c1"># Use timeout to prevent infinite blocking</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">_init_mt5</span><span class="p">():</span>
                <span class="n">path</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">default_settings</span><span class="p">,</span> <span class="s1">&#39;mt5_path&#39;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">terminal_path</span> <span class="o">=</span> <span class="n">path</span>
                    <span class="k">return</span> <span class="n">mt5</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">)</span>
                
                <span class="n">success</span> <span class="o">=</span> <span class="n">mt5</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                    <span class="n">info</span> <span class="o">=</span> <span class="n">mt5</span><span class="o">.</span><span class="n">terminal_info</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">info</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">terminal_path</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">path</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">data_path</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">data_path</span>
                <span class="k">return</span> <span class="n">success</span>
            
            <span class="k">def</span><span class="w"> </span><span class="nf">_resolve_symbol</span><span class="p">(</span><span class="n">target</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
                <span class="c1"># 1. Direct check</span>
                <span class="k">if</span> <span class="n">mt5</span><span class="o">.</span><span class="n">symbol_info</span><span class="p">(</span><span class="n">target</span><span class="p">):</span> <span class="k">return</span> <span class="n">target</span>
                
                <span class="c1"># 2. Search for matches (e.g. EURUSD.m, EURUSD+, EURUSDpro)</span>
                <span class="n">symbols</span> <span class="o">=</span> <span class="n">mt5</span><span class="o">.</span><span class="n">symbols_get</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">symbols</span><span class="p">:</span> 
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to get symbols from MT5: </span><span class="si">{</span><span class="n">mt5</span><span class="o">.</span><span class="n">last_error</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">target</span>
                
                <span class="c1"># Filter for base match</span>
                <span class="n">matches</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">symbols</span> <span class="k">if</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="ow">and</span> <span class="s2">&quot;EUR&quot;</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="ow">and</span> <span class="s2">&quot;USD&quot;</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Candidate symbols for </span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">matches</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">matches</span><span class="p">:</span>
                    <span class="c1"># Sort by length (prefer EURUSD over EURUSD.pro)</span>
                    <span class="n">matches</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="nb">len</span><span class="p">)</span>
                    <span class="c1"># If multiple, prefer the ones with suffixes commonly used by brokers</span>
                    <span class="c1"># But for now shortest is usually safest UNLESS it&#39;s empty.</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Symbol </span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2"> resolved to </span><span class="si">{</span><span class="n">matches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">matches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    
                <span class="k">return</span> <span class="n">target</span>
            
            <span class="k">try</span><span class="p">:</span>
                <span class="n">executor</span> <span class="o">=</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">future</span> <span class="o">=</span> <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">_init_mt5</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
                    
                <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Connected to MT5&quot;</span><span class="p">)</span>
                    <span class="c1"># Capture terminal info for diagnostics</span>
                    <span class="n">info</span> <span class="o">=</span> <span class="n">mt5</span><span class="o">.</span><span class="n">terminal_info</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">info</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">terminal_path</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">path</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">data_path</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">data_path</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MT5 Terminal Path: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">terminal_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MT5 Data Path: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    
                    <span class="n">get_debug_manager</span><span class="p">()</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;EXTRACTION&quot;</span><span class="p">,</span> <span class="s2">&quot;✅ MT5 CONNECT SUCCESS&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;symbol&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">})</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">err</span> <span class="o">=</span> <span class="n">mt5</span><span class="o">.</span><span class="n">last_error</span><span class="p">()</span>
                    <span class="c1"># AUTO-RECOVERY: If path not set, try to find it</span>
                    <span class="n">current_path</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">default_settings</span><span class="p">,</span> <span class="s1">&#39;mt5_path&#39;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">current_path</span><span class="p">:</span>
                         <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Standard MT5 init failed. Attempting deep search for terminal64.exe...&quot;</span><span class="p">)</span>
                         <span class="n">found_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auto_discover_terminal</span><span class="p">()</span>
                         <span class="k">if</span> <span class="n">found_path</span><span class="p">:</span>
                             <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Auto-discovered MT5 at: </span><span class="si">{</span><span class="n">found_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                             <span class="k">if</span> <span class="n">mt5</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">found_path</span><span class="p">):</span>
                                 <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Connected to MT5 via auto-discovery&quot;</span><span class="p">)</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">terminal_path</span> <span class="o">=</span> <span class="n">found_path</span>
                                 <span class="k">return</span> <span class="kc">True</span>
                                 
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MT5 initialization failed: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">get_debug_manager</span><span class="p">()</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;EXTRACTION&quot;</span><span class="p">,</span> <span class="s2">&quot;❌ MT5 CONNECT FAILED&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
                    <span class="k">return</span> <span class="kc">False</span>
                
                <span class="c1"># Resolve symbol DYNAMICALLY</span>
                <span class="n">resolved</span> <span class="o">=</span> <span class="n">_resolve_symbol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">resolved</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Symbol auto-resolved: &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="s2">&#39; -&gt; &#39;</span><span class="si">{</span><span class="n">resolved</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">resolved</span>
                    <span class="c1"># Update settings to persist this? Maybe just runtime for now.</span>
                        
            <span class="k">except</span> <span class="n">FuturesTimeout</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MT5 connection timed out after </span><span class="si">{</span><span class="n">timeout</span><span class="si">}</span><span class="s2">s (MT5 may be unresponsive)&quot;</span><span class="p">)</span>
                <span class="c1"># Index DX-100: Connection Recovery</span>
                <span class="n">get_sentinel</span><span class="p">(</span><span class="n">mt5</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">repair</span><span class="p">(</span><span class="s2">&quot;DX-100&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MT5 connection error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">get_sentinel</span><span class="p">(</span><span class="n">mt5</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">repair</span><span class="p">(</span><span class="s2">&quot;DX-100&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="c1"># Use wait=False to prevent hanging the main thread if mt5.initialize is stuck in C-code</span>
                <span class="n">executor</span><span class="o">.</span><span class="n">shutdown</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">connected</span> <span class="o">=</span> <span class="kc">True</span>
            
            <span class="c1"># Ensure symbol is selected in Market Watch</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">mt5</span><span class="o">.</span><span class="n">symbol_select</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to select symbol </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="s2">, trying to proceed anyway...&quot;</span><span class="p">)</span>
            
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Connected to MT5&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_notify</span><span class="p">(</span><span class="s2">&quot;connected&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
            <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="MT5Connector.check_health">
<a class="viewcode-back" href="../../api/core.html#core.mt5_connector.MT5Connector.check_health">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">check_health</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Detailed connection diagnostic&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">MT5_AVAILABLE</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;MetaTrader5 package not installed. Try: pip install MetaTrader5&quot;</span>
            
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="c1"># 1. Try standard connect</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">():</span>
                 <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;Successfully connected to MetaTrader 5.&quot;</span>
            
            <span class="c1"># 2. Get last error</span>
            <span class="n">err</span> <span class="o">=</span> <span class="n">mt5</span><span class="o">.</span><span class="n">last_error</span><span class="p">()</span>
            
            <span class="c1"># 3. Specific diagnostics</span>
            <span class="k">if</span> <span class="n">err</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                 <span class="c1"># Search for terminal</span>
                 <span class="n">t_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auto_discover_terminal</span><span class="p">()</span>
                 <span class="k">if</span> <span class="ow">not</span> <span class="n">t_path</span><span class="p">:</span>
                      <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;MT5 Terminal NOT FOUND. Please ensure MetaTrader 5 is installed or set the path in Settings.&quot;</span>
                 <span class="k">else</span><span class="p">:</span>
                      <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;MT5 found at </span><span class="si">{</span><span class="n">t_path</span><span class="si">}</span><span class="s2">, but failed to initialize. Try running MT5 as Administrator.&quot;</span>
            
            <span class="k">if</span> <span class="n">err</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">10004</span><span class="p">:</span>
                 <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;MT5 connection failed: IPC (Inter-Process Communication) error. Restart your terminal.&quot;</span>
                 
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;MT5 Connection Failed: </span><span class="si">{</span><span class="n">err</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> (Code: </span><span class="si">{</span><span class="n">err</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_auto_discover_terminal</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Deep search for MT5 terminal executable&quot;&quot;&quot;</span>
        <span class="n">common_paths</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;C:/Program Files/MetaTrader 5/terminal64.exe&quot;</span><span class="p">),</span>
            <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;C:/Program Files (x86)/MetaTrader 5/terminal64.exe&quot;</span><span class="p">),</span>
        <span class="p">]</span>
        
        <span class="c1"># Check standard paths first</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">common_paths</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span> <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            
        <span class="c1"># Search in Program Files for ANY MT5 terminal</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">pf</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;C:/Program Files&quot;</span><span class="p">),</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;C:/Program Files (x86)&quot;</span><span class="p">)]:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">pf</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span> <span class="k">continue</span>
                <span class="c1"># Look for terminal64.exe in any subfolder containing &#39;MetaTrader&#39;</span>
                <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="n">pf</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*MetaTrader*&quot;</span><span class="p">):</span>
                    <span class="n">t_app</span> <span class="o">=</span> <span class="n">folder</span> <span class="o">/</span> <span class="s2">&quot;terminal64.exe&quot;</span>
                    <span class="k">if</span> <span class="n">t_app</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span> <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">t_app</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
             <span class="k">pass</span>
             
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_terminal_data_path</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Robustly get the MT5 Data Path (for MQL5/Files)&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_path</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_path</span>
        
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="c1"># We assume connect() or similar already initialized mt5</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">info</span> <span class="o">=</span> <span class="n">mt5</span><span class="o">.</span><span class="n">terminal_info</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">info</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data_path</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">data_path</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_path</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="kc">None</span>
    
<div class="viewcode-block" id="MT5Connector.disconnect">
<a class="viewcode-back" href="../../api/core.html#core.mt5_connector.MT5Connector.disconnect">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Disconnect from MT5&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">MT5_AVAILABLE</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
                <span class="n">mt5</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">connected</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Disconnected from MT5&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_notify</span><span class="p">(</span><span class="s2">&quot;disconnected&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span></div>

    
<div class="viewcode-block" id="MT5Connector.test_connection">
<a class="viewcode-back" href="../../api/core.html#core.mt5_connector.MT5Connector.test_connection">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test MT5 connection&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">():</span>
                <span class="k">return</span> <span class="kc">False</span>
            
            <span class="c1"># Try to get symbol info</span>
            <span class="k">if</span> <span class="n">MT5_AVAILABLE</span><span class="p">:</span>
                <span class="n">info</span> <span class="o">=</span> <span class="n">mt5</span><span class="o">.</span><span class="n">symbol_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Symbol </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="s2"> not found&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
                    <span class="k">return</span> <span class="kc">False</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">True</span></div>

    
<div class="viewcode-block" id="MT5Connector.preload_history">
<a class="viewcode-back" href="../../api/core.html#core.mt5_connector.MT5Connector.preload_history">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">preload_history</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Force MT5 to download maximum available history for timeframes.</span>
<span class="sd">        This triggers the broker server to send all cached historical data.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            timeframe: Specific timeframe to preload, or None for all</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            dict with preload results per timeframe</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">MT5_AVAILABLE</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;MT5 not available&quot;</span><span class="p">}</span>
        
        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">():</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Failed to connect to MT5&quot;</span><span class="p">}</span>
            
            <span class="c1"># Ensure symbol is selected in Market Watch (triggers data sync)</span>
            <span class="n">mt5</span><span class="o">.</span><span class="n">symbol_select</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            
            <span class="c1"># Get timeframes to preload</span>
            <span class="k">if</span> <span class="n">timeframe</span><span class="p">:</span>
                <span class="n">timeframes</span> <span class="o">=</span> <span class="p">[</span><span class="n">timeframe</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># All timeframes from config</span>
                <span class="n">timeframes</span> <span class="o">=</span> <span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">tf</span> <span class="ow">in</span> <span class="n">TIMEFRAMES</span><span class="p">]</span>
            
            <span class="k">for</span> <span class="n">tf_name</span> <span class="ow">in</span> <span class="n">timeframes</span><span class="p">:</span>
                <span class="n">tf_config</span> <span class="o">=</span> <span class="n">get_timeframe_by_name</span><span class="p">(</span><span class="n">tf_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">tf_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>
                
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Request maximum bars (500,000) to force full history download</span>
                    <span class="c1"># MT5 will return what the broker allows</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[PRELOAD] Requesting max history for </span><span class="si">{</span><span class="n">tf_name</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
                    
                    <span class="c1"># copy_rates_from_pos with very large count forces download</span>
                    <span class="n">rates</span> <span class="o">=</span> <span class="n">mt5</span><span class="o">.</span><span class="n">copy_rates_from_pos</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span>
                        <span class="n">tf_config</span><span class="o">.</span><span class="n">mt5_timeframe</span><span class="p">,</span>
                        <span class="mi">0</span><span class="p">,</span>  <span class="c1"># Start from most recent</span>
                        <span class="mi">500000</span>  <span class="c1"># Request 500k bars (MT5 will cap to available)</span>
                    <span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">rates</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">rates</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># Convert to get date range</span>
                        <span class="n">first_date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;time&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">)</span>
                        <span class="n">last_date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">rates</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;time&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">)</span>
                        
                        <span class="n">results</span><span class="p">[</span><span class="n">tf_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                            <span class="s2">&quot;bars&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">rates</span><span class="p">),</span>
                            <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="n">first_date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">),</span>
                            <span class="s2">&quot;to&quot;</span><span class="p">:</span> <span class="n">last_date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="p">}</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[PRELOAD] </span><span class="si">{</span><span class="n">tf_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">rates</span><span class="p">)</span><span class="si">}</span><span class="s2"> bars (</span><span class="si">{</span><span class="n">first_date</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">last_date</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">error</span> <span class="o">=</span> <span class="n">mt5</span><span class="o">.</span><span class="n">last_error</span><span class="p">()</span>
                        <span class="n">results</span><span class="p">[</span><span class="n">tf_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">)}</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[PRELOAD] </span><span class="si">{</span><span class="n">tf_name</span><span class="si">}</span><span class="s2">: Failed - </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">results</span><span class="p">[</span><span class="n">tf_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[PRELOAD] </span><span class="si">{</span><span class="n">tf_name</span><span class="si">}</span><span class="s2">: Exception - </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[PRELOAD] History preload complete: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">results</span><span class="o">.</span><span class="n">values</span><span class="p">()</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;success&#39;</span><span class="p">))</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="si">}</span><span class="s2"> timeframes loaded&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">results</span></div>

            
<div class="viewcode-block" id="MT5Connector.get_terminal_data_path">
<a class="viewcode-back" href="../../api/core.html#core.mt5_connector.MT5Connector.get_terminal_data_path">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_terminal_data_path</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get MT5 terminal data path (AppData directory)&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">():</span>
                <span class="k">return</span> <span class="kc">None</span>
            
            <span class="k">if</span> <span class="n">MT5_AVAILABLE</span><span class="p">:</span>
                <span class="n">info</span> <span class="o">=</span> <span class="n">mt5</span><span class="o">.</span><span class="n">terminal_info</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">info</span><span class="p">:</span>
                    <span class="c1"># Attempt re-init</span>
                    <span class="n">mt5</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
                    <span class="n">info</span> <span class="o">=</span> <span class="n">mt5</span><span class="o">.</span><span class="n">terminal_info</span><span class="p">()</span>
                
                <span class="k">if</span> <span class="n">info</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">info</span><span class="o">.</span><span class="n">data_path</span>
            <span class="k">return</span> <span class="kc">None</span></div>

    
<div class="viewcode-block" id="MT5Connector.get_current_server_time">
<a class="viewcode-back" href="../../api/core.html#core.mt5_connector.MT5Connector.get_current_server_time">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_current_server_time</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">datetime</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the ABSOLUTE LATEST server time from the last tick/quote.</span>
<span class="sd">        This represents &#39;NOW&#39; on the server.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">():</span>
             <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="c1"># Fallback</span>

        <span class="k">try</span><span class="p">:</span>
             <span class="c1"># Fast check via symbol tick</span>
             <span class="n">tick</span> <span class="o">=</span> <span class="n">mt5</span><span class="o">.</span><span class="n">symbol_info_tick</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span>
             <span class="k">if</span> <span class="n">tick</span><span class="p">:</span>
                 <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">tick</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
             
             <span class="c1"># Slower check via symbol info</span>
             <span class="n">info</span> <span class="o">=</span> <span class="n">mt5</span><span class="o">.</span><span class="n">symbol_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span>
             <span class="k">if</span> <span class="n">info</span><span class="p">:</span>
                 <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
             <span class="k">pass</span>
             
        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="c1"># Absolute fallback</span></div>


<div class="viewcode-block" id="MT5Connector.get_server_time">
<a class="viewcode-back" href="../../api/core.html#core.mt5_connector.MT5Connector.get_server_time">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_server_time</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get current server time (Legacy/Optional Wrapper)&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_server_time</span><span class="p">()</span></div>


<div class="viewcode-block" id="MT5Connector.get_time_offset">
<a class="viewcode-back" href="../../api/core.html#core.mt5_connector.MT5Connector.get_time_offset">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_time_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate seconds offset between Local Time and Server Time.</span>
<span class="sd">        Positive = Local is ahead of Server.</span>
<span class="sd">        Negative = Local is behind Server.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">server_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_server_time</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">server_time</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>
            
        <span class="n">local_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="c1"># Round to minutes to avoid seconds-level jitter</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="p">(</span><span class="n">local_time</span> <span class="o">-</span> <span class="n">server_time</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">delta</span></div>


<div class="viewcode-block" id="MT5Connector.get_account_info">
<a class="viewcode-back" href="../../api/core.html#core.mt5_connector.MT5Connector.get_account_info">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_account_info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get MT5 account information (Non-blocking for UI)&quot;&quot;&quot;</span>
        <span class="c1"># Try to acquire lock with short timeout to prevent UI freeze</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>
            
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">MT5_AVAILABLE</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            
            <span class="n">info</span> <span class="o">=</span> <span class="n">mt5</span><span class="o">.</span><span class="n">account_info</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
                
            <span class="c1"># Fetch Open Positions</span>
            <span class="n">positions</span> <span class="o">=</span> <span class="n">mt5</span><span class="o">.</span><span class="n">positions_get</span><span class="p">()</span>
            <span class="n">pos_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">positions</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">positions</span><span class="p">:</span>
                    <span class="n">pos_list</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s2">&quot;ticket&quot;</span><span class="p">:</span> <span class="n">pos</span><span class="o">.</span><span class="n">ticket</span><span class="p">,</span>
                        <span class="s2">&quot;symbol&quot;</span><span class="p">:</span> <span class="n">pos</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">pos</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="c1"># 0=Buy, 1=Sell</span>
                        <span class="s2">&quot;volume&quot;</span><span class="p">:</span> <span class="n">pos</span><span class="o">.</span><span class="n">volume</span><span class="p">,</span>
                        <span class="s2">&quot;price_open&quot;</span><span class="p">:</span> <span class="n">pos</span><span class="o">.</span><span class="n">price_open</span><span class="p">,</span>
                        <span class="s2">&quot;profit&quot;</span><span class="p">:</span> <span class="n">pos</span><span class="o">.</span><span class="n">profit</span><span class="p">,</span>
                        <span class="s2">&quot;comment&quot;</span><span class="p">:</span> <span class="n">pos</span><span class="o">.</span><span class="n">comment</span>
                    <span class="p">})</span>

            <span class="c1"># Return Dictionary compatible with UI</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;login&quot;</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">login</span><span class="p">,</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="s2">&quot;server&quot;</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">server</span><span class="p">,</span>
                <span class="s2">&quot;currency&quot;</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">currency</span><span class="p">,</span>
                <span class="s2">&quot;company&quot;</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">company</span><span class="p">,</span>
                <span class="s2">&quot;leverage&quot;</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">leverage</span><span class="p">,</span>
                <span class="s2">&quot;balance&quot;</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">balance</span><span class="p">,</span>
                <span class="s2">&quot;equity&quot;</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">equity</span><span class="p">,</span>
                <span class="s2">&quot;profit&quot;</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">profit</span><span class="p">,</span>
                <span class="s2">&quot;margin&quot;</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">margin</span><span class="p">,</span>
                <span class="s2">&quot;margin_free&quot;</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">margin_free</span><span class="p">,</span>
                <span class="s2">&quot;margin_level&quot;</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">margin_level</span><span class="p">,</span>
                <span class="s2">&quot;trade_mode&quot;</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">trade_mode</span><span class="p">,</span>
                <span class="s2">&quot;positions&quot;</span><span class="p">:</span> <span class="n">pos_list</span>
            <span class="p">}</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span></div>

    
<div class="viewcode-block" id="MT5Connector.get_market_status">
<a class="viewcode-back" href="../../api/core.html#core.mt5_connector.MT5Connector.get_market_status">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_market_status</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check real-time market status for the current symbol via MT5.</span>
<span class="sd">        Returns a dict with &#39;status&#39;, &#39;description&#39;, and &#39;is_open&#39; boolean.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Try to acquire lock with short timeout to prevent UI freeze</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;CHECKING&quot;</span><span class="p">,</span> <span class="s2">&quot;is_open&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Terminal Busy&quot;</span><span class="p">}</span>
            
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">MT5_AVAILABLE</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;OFFLINE&quot;</span><span class="p">,</span> <span class="s2">&quot;is_open&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;MT5 Not Connected&quot;</span><span class="p">}</span>
            
            <span class="c1"># 1. Get Symbol Info</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">mt5</span><span class="o">.</span><span class="n">symbol_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;ERROR&quot;</span><span class="p">,</span> <span class="s2">&quot;is_open&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Symbol Not Found&quot;</span><span class="p">}</span>
            
            <span class="c1"># 2. Check Trade Mode</span>
            <span class="c1"># trade_mode: 0=Disabled, 1=LongOnly, 2=ShortOnly, 3=CloseOnly, 4=Full</span>
            <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">trade_mode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;CLOSED&quot;</span><span class="p">,</span> <span class="s2">&quot;is_open&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Trading Disabled&quot;</span><span class="p">}</span>
            
            <span class="c1"># 3. Check Session Status</span>
            <span class="c1"># Check for holiday/weekend via session gaps</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timezone</span>
            <span class="n">now_utc</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
            <span class="n">day_of_week</span> <span class="o">=</span> <span class="n">now_utc</span><span class="o">.</span><span class="n">weekday</span><span class="p">()</span> <span class="c1"># 0-6</span>
            
            <span class="c1"># Market check (Sunday 22:00 UTC to Friday 22:00 UTC)</span>
            <span class="k">if</span> <span class="n">day_of_week</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span> <span class="c1"># Saturday</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;CLOSED&quot;</span><span class="p">,</span> <span class="s2">&quot;is_open&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Weekend (Saturday)&quot;</span><span class="p">}</span>
            <span class="k">if</span> <span class="n">day_of_week</span> <span class="o">==</span> <span class="mi">6</span> <span class="ow">and</span> <span class="n">now_utc</span><span class="o">.</span><span class="n">hour</span> <span class="o">&lt;</span> <span class="mi">22</span><span class="p">:</span> <span class="c1"># Sunday before 22:00</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;CLOSED&quot;</span><span class="p">,</span> <span class="s2">&quot;is_open&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Weekend (Sunday)&quot;</span><span class="p">}</span>
            <span class="k">if</span> <span class="n">day_of_week</span> <span class="o">==</span> <span class="mi">4</span> <span class="ow">and</span> <span class="n">now_utc</span><span class="o">.</span><span class="n">hour</span> <span class="o">&gt;=</span> <span class="mi">22</span><span class="p">:</span> <span class="c1"># Friday after 22:00</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;CLOSED&quot;</span><span class="p">,</span> <span class="s2">&quot;is_open&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Market Closed (Friday)&quot;</span><span class="p">}</span>
            
            <span class="c1"># 4. Check quote freshness (Active Ticks)</span>
            <span class="n">tick</span> <span class="o">=</span> <span class="n">mt5</span><span class="o">.</span><span class="n">symbol_info_tick</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tick</span><span class="p">:</span>
                <span class="n">tick_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">tick</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
                <span class="n">server_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_server_time</span><span class="p">()</span>
                <span class="n">age_seconds</span> <span class="o">=</span> <span class="p">(</span><span class="n">server_time</span> <span class="o">-</span> <span class="n">tick_time</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
                
                <span class="c1"># If ticks are very old during a weekday, it&#39;s likely a bank holiday where MT5 is up but symbol is paused</span>
                <span class="k">if</span> <span class="n">age_seconds</span> <span class="o">&gt;</span> <span class="mi">3600</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;HOLIDAY&quot;</span><span class="p">,</span> <span class="s2">&quot;is_open&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Market Inactive (Holiday?)&quot;</span><span class="p">}</span>
                
                <span class="k">return</span> <span class="p">{</span>
                    <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;OPEN&quot;</span><span class="p">,</span> 
                    <span class="s2">&quot;is_open&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> 
                    <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Trading Active&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;server_time&quot;</span><span class="p">:</span> <span class="n">server_time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%H:%M:%S&quot;</span><span class="p">)</span>
                <span class="p">}</span>
            
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;CLOSED&quot;</span><span class="p">,</span> <span class="s2">&quot;is_open&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;No Quote Signal&quot;</span><span class="p">}</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;ERROR&quot;</span><span class="p">,</span> <span class="s2">&quot;is_open&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span></div>

    
<div class="viewcode-block" id="MT5Connector.get_ohlc_path">
<a class="viewcode-back" href="../../api/core.html#core.mt5_connector.MT5Connector.get_ohlc_path">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_ohlc_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get path for OHLC CSV file&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">OHLC_DIR</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;ohlc_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">.csv&quot;</span></div>

    
<div class="viewcode-block" id="MT5Connector.extract_ohlc">
<a class="viewcode-back" href="../../api/core.html#core.mt5_connector.MT5Connector.extract_ohlc">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">extract_ohlc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">from_date</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                     <span class="n">to_date</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">is_update</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract OHLC data for a timeframe.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">MT5_AVAILABLE</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;MT5 not available&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="n">tf_config</span> <span class="o">=</span> <span class="n">get_timeframe_by_name</span><span class="p">(</span><span class="n">timeframe</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tf_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown timeframe: </span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="n">db</span> <span class="o">=</span> <span class="n">get_database</span><span class="p">()</span>
        <span class="n">log_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">log_extraction_start</span><span class="p">(</span><span class="n">timeframe</span><span class="p">,</span> <span class="n">is_update</span><span class="p">)</span>
        
        <span class="c1"># --- PHASE 1: MT5 INTERACTION (NEEDS LOCK) ---</span>
        <span class="n">rates</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>  <span class="c1"># Only lock for MT5 calls</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Failed to connect to MT5&quot;</span><span class="p">)</span>
                
                <span class="c1"># --- AUTO-PRELOAD for fresh extractions ---</span>
                <span class="c1"># Force MT5 to download maximum available history before extraction</span>
                <span class="c1"># Note: Preload is called WITHOUT releasing the lock to avoid race conditions</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_update</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] Running history preload to maximize data...&quot;</span><span class="p">)</span>
                    <span class="c1"># Preload uses copy_rates_from_pos which doesn&#39;t need separate lock</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">rates_preload</span> <span class="o">=</span> <span class="n">mt5</span><span class="o">.</span><span class="n">copy_rates_from_pos</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span>
                            <span class="n">tf_config</span><span class="o">.</span><span class="n">mt5_timeframe</span><span class="p">,</span>
                            <span class="mi">0</span><span class="p">,</span>
                            <span class="mi">100000</span>  <span class="c1"># Request max bars to trigger history download</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="n">rates_preload</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] Preload successful: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">rates_preload</span><span class="p">)</span><span class="si">}</span><span class="s2"> bars available&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">pe</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] Preload failed (non-critical): </span><span class="si">{</span><span class="n">pe</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="c1"># Determine date range</span>
                <span class="k">if</span> <span class="n">is_update</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># Use file lock for peeking, avoid race with save</span>
                        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_lock</span><span class="p">:</span>
                            <span class="n">existing_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_ohlc_path</span><span class="p">(</span><span class="n">timeframe</span><span class="p">))</span>
                            <span class="k">if</span> <span class="n">existing_df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">existing_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                                <span class="k">if</span> <span class="s1">&#39;time&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">existing_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                                    <span class="c1"># Handle malformed CSV</span>
                                    <span class="n">from_date</span> <span class="o">=</span> <span class="kc">None</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="c1"># Use max time</span>
                                    <span class="n">existing_df</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">existing_df</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">])</span>
                                    <span class="n">from_date</span> <span class="o">=</span> <span class="n">existing_df</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">from_date</span> <span class="o">=</span> <span class="kc">None</span>
                
                <span class="k">if</span> <span class="n">from_date</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Apply Turbo Extraction: Force smart history at the source level</span>
                    <span class="c1"># if timeframe == &#39;1m&#39;:</span>
                    <span class="c1">#    months = getattr(default_settings, &#39;history_1m_months&#39;, 6)</span>
                    <span class="c1">#    from_date = datetime.now() - pd.DateOffset(months=months)</span>
                    <span class="c1">#    logger.info(f&quot;[{timeframe}] Turbo Extraction Active: Capped at {months} months.&quot;)</span>
                    <span class="c1"># else:</span>
                        <span class="c1"># Default: Start from user-configured setting</span>
                        <span class="n">from_year</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">default_settings</span><span class="p">,</span> <span class="s1">&#39;extract_from_year&#39;</span><span class="p">,</span> <span class="mi">2015</span><span class="p">)</span>
                        
                        <span class="c1"># Respect user&#39;s choice - no profile override</span>
                        <span class="c1"># The user sets their preferred from_year in Settings</span>
                        <span class="n">from_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="n">from_year</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] Using user-configured from_year: </span><span class="si">{</span><span class="n">from_year</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">to_date</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># STRICT SERVER TIME</span>
                    <span class="c1"># We want all available data up to &#39;Server Now&#39; + 1 Day (to catch forming candle)</span>
                    <span class="n">server_now</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_server_time</span><span class="p">()</span>
                    <span class="n">to_date</span> <span class="o">=</span> <span class="n">server_now</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] Server Time: </span><span class="si">{</span><span class="n">server_now</span><span class="si">}</span><span class="s2"> -&gt; Extracting until: </span><span class="si">{</span><span class="n">to_date</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="c1"># Ensure from_date is native datetime (fix pandas Timestamp issues)</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">from_date</span><span class="p">,</span> <span class="s1">&#39;to_pydatetime&#39;</span><span class="p">):</span>
                    <span class="n">from_date</span> <span class="o">=</span> <span class="n">from_date</span><span class="o">.</span><span class="n">to_pydatetime</span><span class="p">()</span>
                
                <span class="c1"># Ensure to_date is native datetime (fix pandas Timestamp issues)  </span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">to_date</span><span class="p">,</span> <span class="s1">&#39;to_pydatetime&#39;</span><span class="p">):</span>
                    <span class="n">to_date</span> <span class="o">=</span> <span class="n">to_date</span><span class="o">.</span><span class="n">to_pydatetime</span><span class="p">()</span>
                
                <span class="c1"># Check for NaT just in case</span>
                <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">from_date</span><span class="p">):</span>
                     <span class="n">from_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2010</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] Extracting from </span><span class="si">{</span><span class="n">from_date</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">to_date</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">_notify</span><span class="p">(</span><span class="s2">&quot;extraction_start&quot;</span><span class="p">,</span> <span class="p">{</span>
                    <span class="s2">&quot;timeframe&quot;</span><span class="p">:</span> <span class="n">timeframe</span><span class="p">,</span>
                    <span class="s2">&quot;from_date&quot;</span><span class="p">:</span> <span class="n">from_date</span><span class="p">,</span>
                    <span class="s2">&quot;to_date&quot;</span><span class="p">:</span> <span class="n">to_date</span><span class="p">,</span>
                    <span class="s2">&quot;is_update&quot;</span><span class="p">:</span> <span class="n">is_update</span><span class="p">,</span>
                <span class="p">})</span>
                
                <span class="c1"># Extract from MT5 WITH TIMEOUT</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">concurrent.futures</span><span class="w"> </span><span class="kn">import</span> <span class="n">ThreadPoolExecutor</span><span class="p">,</span> <span class="ne">TimeoutError</span> <span class="k">as</span> <span class="n">FuturesTimeout</span>
                
                <span class="k">def</span><span class="w"> </span><span class="nf">_fetch</span><span class="p">():</span>
                    <span class="c1"># Retry loop inside thread</span>
                    <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="c1"># 1. Range Fetch (History)</span>
                            <span class="n">rates_range</span> <span class="o">=</span> <span class="n">mt5</span><span class="o">.</span><span class="n">copy_rates_range</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span> 
                                <span class="n">tf_config</span><span class="o">.</span><span class="n">mt5_timeframe</span><span class="p">,</span> 
                                <span class="n">from_date</span><span class="p">,</span> 
                                <span class="n">to_date</span>
                            <span class="p">)</span>
                            
                            <span class="c1"># 2. Latest Fetch (Freshness Guarantee)</span>
                            <span class="n">rates_latest</span> <span class="o">=</span> <span class="n">mt5</span><span class="o">.</span><span class="n">copy_rates_from_pos</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span>
                                <span class="n">tf_config</span><span class="o">.</span><span class="n">mt5_timeframe</span><span class="p">,</span>
                                <span class="mi">0</span><span class="p">,</span>
                                <span class="mi">1000</span> 
                            <span class="p">)</span>
                            
                            <span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
                            <span class="c1"># Check success</span>
                            <span class="k">if</span> <span class="n">rates_range</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">rates_latest</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">err</span> <span class="o">=</span> <span class="n">mt5</span><span class="o">.</span><span class="n">last_error</span><span class="p">()</span>
                                <span class="c1"># RECOVERY: If connection lost, try to re-initialize</span>
                                <span class="k">if</span> <span class="n">err</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">10004</span><span class="p">:</span> <span class="c1"># No IPC connection</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;IPC lost for </span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">, attempting re-init...&quot;</span><span class="p">)</span>
                                    <span class="n">path</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">default_settings</span><span class="p">,</span> <span class="s1">&#39;mt5_path&#39;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">path</span><span class="p">:</span> <span class="n">mt5</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">)</span>
                                    <span class="k">else</span><span class="p">:</span> <span class="n">mt5</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
                                
                                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Attempt </span><span class="si">{</span><span class="n">attempt</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> failed for </span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MT5 error: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                            <span class="c1"># Merge logic</span>
                            <span class="k">if</span> <span class="n">rates_range</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">rates_latest</span>
                            <span class="k">if</span> <span class="n">rates_latest</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">rates_range</span>
                                
                            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">rates_range</span><span class="p">,</span> <span class="n">rates_latest</span><span class="p">))</span>
                            
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">attempt</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> <span class="k">raise</span> <span class="n">e</span>
                            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># Wait before retry</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
                        <span class="n">future</span> <span class="o">=</span> <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">_fetch</span><span class="p">)</span>
                        <span class="c1"># Dynamic timeout: 120s for 1m (large data), 60s for others</span>
                        <span class="n">timeout_s</span> <span class="o">=</span> <span class="mi">120</span> <span class="k">if</span> <span class="n">timeframe</span> <span class="o">==</span> <span class="s1">&#39;1m&#39;</span> <span class="k">else</span> <span class="mi">60</span>
                        <span class="n">rates</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">timeout_s</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">FuturesTimeout</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MT5 Extraction timed out for </span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">timeout_s</span><span class="si">}</span><span class="s2">s limit)&quot;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;MT5 Extraction Timed Out&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MT5 Extraction failed for </span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">log_extraction_failed</span><span class="p">(</span><span class="n">log_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="c1"># Index DX-110: OHLC Data Recovery</span>
            <span class="n">get_sentinel</span><span class="p">(</span><span class="n">mt5</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">repair</span><span class="p">(</span><span class="s2">&quot;DX-110&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;timeframe&quot;</span><span class="p">:</span> <span class="n">timeframe</span><span class="p">})</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># --- PHASE 2: PROCESSING (NO LOCK) ---</span>
        <span class="c1"># Release lock so UI updates (get_account_info) can proceed</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">rates</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">rates</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">is_update</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No new data for </span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2"> (already up to date)&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No data extracted for </span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">log_extraction_complete</span><span class="p">(</span><span class="n">log_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
            
            <span class="c1"># Convert to DataFrame (Heavy CPU)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rates</span><span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">)</span>
            
            <span class="c1"># --- DEDUPLICATION (Fix merged duplicates) ---</span>
            <span class="n">original_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">],</span> <span class="n">keep</span><span class="o">=</span><span class="s1">&#39;last&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">original_len</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] Removed </span><span class="si">{</span><span class="n">original_len</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2"> duplicate rows&quot;</span><span class="p">)</span>
            
            <span class="c1"># Rename columns</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="s1">&#39;time&#39;</span><span class="p">,</span>
                <span class="s1">&#39;open&#39;</span><span class="p">:</span> <span class="s1">&#39;open&#39;</span><span class="p">,</span>
                <span class="s1">&#39;high&#39;</span><span class="p">:</span> <span class="s1">&#39;high&#39;</span><span class="p">,</span>
                <span class="s1">&#39;low&#39;</span><span class="p">:</span> <span class="s1">&#39;low&#39;</span><span class="p">,</span>
                <span class="s1">&#39;close&#39;</span><span class="p">:</span> <span class="s1">&#39;close&#39;</span><span class="p">,</span>
                <span class="s1">&#39;tick_volume&#39;</span><span class="p">:</span> <span class="s1">&#39;volume&#39;</span><span class="p">,</span>
            <span class="p">})</span>
            
            <span class="c1"># Keep only required columns</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">,</span> <span class="s1">&#39;low&#39;</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="s1">&#39;volume&#39;</span><span class="p">,</span> <span class="s1">&#39;spread&#39;</span><span class="p">]]</span>
            
            <span class="c1"># --- DATA VALIDATION ---</span>
            <span class="c1"># Remove rows with invalid OHLC values</span>
            <span class="n">invalid_mask</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> 
                <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
                <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">])</span> <span class="o">|</span>  <span class="c1"># High must be &gt;= Low</span>
                <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;spread&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># Spread cannot be negative</span>
            <span class="p">)</span>
            <span class="n">invalid_count</span> <span class="o">=</span> <span class="n">invalid_mask</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">invalid_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] Removed </span><span class="si">{</span><span class="n">invalid_count</span><span class="si">}</span><span class="s2"> invalid OHLC rows&quot;</span><span class="p">)</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">invalid_mask</span><span class="p">]</span>
            
            <span class="c1"># Sort by time to ensure chronological order</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
            <span class="c1"># Save to CSV (Protected by file lock inside _save_ohlc)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_save_ohlc</span><span class="p">(</span><span class="n">timeframe</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">is_update</span><span class="p">)</span>
            
            <span class="n">db</span><span class="o">.</span><span class="n">log_extraction_complete</span><span class="p">(</span><span class="n">log_id</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">_notify</span><span class="p">(</span><span class="s2">&quot;extraction_complete&quot;</span><span class="p">,</span> <span class="p">{</span>
                <span class="s2">&quot;timeframe&quot;</span><span class="p">:</span> <span class="n">timeframe</span><span class="p">,</span>
                <span class="s2">&quot;candles&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">),</span>
                <span class="s2">&quot;is_update&quot;</span><span class="p">:</span> <span class="n">is_update</span><span class="p">,</span>
            <span class="p">})</span>
            
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extracted </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2"> candles for </span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="s2">&quot;open&quot;</span><span class="p">,</span> <span class="s2">&quot;high&quot;</span><span class="p">,</span> <span class="s2">&quot;low&quot;</span><span class="p">,</span> <span class="s2">&quot;close&quot;</span><span class="p">,</span> <span class="s2">&quot;volume&quot;</span><span class="p">,</span> <span class="s2">&quot;spread&quot;</span><span class="p">]]</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing failed for </span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">log_extraction_failed</span><span class="p">(</span><span class="n">log_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_notify</span><span class="p">(</span><span class="s2">&quot;extraction_error&quot;</span><span class="p">,</span> <span class="p">{</span>
                <span class="s2">&quot;timeframe&quot;</span><span class="p">:</span> <span class="n">timeframe</span><span class="p">,</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
            <span class="p">})</span>
            <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="MT5Connector.update_all_ohlc">
<a class="viewcode-back" href="../../api/core.html#core.mt5_connector.MT5Connector.update_all_ohlc">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_all_ohlc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeframes</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">callback</span><span class="p">:</span> <span class="nb">callable</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Bulk update OHLC for all (or specified) timeframes.</span>
<span class="sd">        </span>
<span class="sd">        This is a DEDICATED extraction phase that should be called BEFORE training,</span>
<span class="sd">        so that training threads never need to wait for MT5 IPC.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            timeframes: List of TF names to update. Defaults to all standard TFs.</span>
<span class="sd">            callback: Optional callback(tf, status, msg) for progress updates.</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Dict with {timeframe: candle_count or error}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">config.settings</span><span class="w"> </span><span class="kn">import</span> <span class="n">TIMEFRAME_NAMES</span>
        
        <span class="k">if</span> <span class="n">timeframes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">timeframes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">TIMEFRAME_NAMES</span><span class="p">)</span>
        
        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;📥 [Bulk OHLC] Starting extraction for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">timeframes</span><span class="p">)</span><span class="si">}</span><span class="s2"> timeframes...&quot;</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">tf</span> <span class="ow">in</span> <span class="n">timeframes</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">callback</span><span class="p">:</span>
                    <span class="n">callback</span><span class="p">(</span><span class="n">tf</span><span class="p">,</span> <span class="s2">&quot;active&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Updating </span><span class="si">{</span><span class="n">tf</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
                
                <span class="c1"># Check if update is needed (fast file check)</span>
                <span class="n">ohlc_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ohlc_path</span><span class="p">(</span><span class="n">tf</span><span class="p">)</span>
                <span class="n">needs_update</span> <span class="o">=</span> <span class="kc">True</span>
                
                <span class="k">if</span> <span class="n">ohlc_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                    <span class="c1"># Check file modification time vs server time</span>
                    <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
                    <span class="n">file_mtime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="n">ohlc_path</span><span class="p">))</span>
                    <span class="n">server_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_server_time</span><span class="p">()</span>
                    
                    <span class="c1"># Freshness thresholds (in minutes)</span>
                    <span class="n">freshness</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;1m&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;5m&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;15m&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;30m&quot;</span><span class="p">:</span> <span class="mi">40</span><span class="p">,</span> <span class="s2">&quot;1h&quot;</span><span class="p">:</span> <span class="mi">70</span><span class="p">,</span> <span class="s2">&quot;4h&quot;</span><span class="p">:</span> <span class="mi">250</span><span class="p">}</span>
                    <span class="n">limit_mins</span> <span class="o">=</span> <span class="n">freshness</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tf</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
                    
                    <span class="n">age_mins</span> <span class="o">=</span> <span class="p">(</span><span class="n">server_time</span> <span class="o">-</span> <span class="n">file_mtime</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mi">60</span>
                    
                    <span class="c1"># Default: Fresh</span>
                    <span class="n">is_fresh</span> <span class="o">=</span> <span class="n">age_mins</span> <span class="o">&lt;</span> <span class="n">limit_mins</span>
                    
                    <span class="c1"># CHECK PROFILE CONSISTENCY (Force update if data is too old/wrong for profile)</span>
                    <span class="k">if</span> <span class="n">is_fresh</span><span class="p">:</span>
                         <span class="k">try</span><span class="p">:</span>
                             <span class="c1"># Read first line to check start date</span>
                             <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ohlc_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                                 <span class="n">header</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span> <span class="c1"># Header</span>
                                 <span class="n">first</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>  <span class="c1"># First row</span>
                                 <span class="k">if</span> <span class="n">first</span><span class="p">:</span>
                                     <span class="n">date_str</span> <span class="o">=</span> <span class="n">first</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                                     <span class="n">first_date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">date_str</span><span class="p">)</span>
                                     
                                     <span class="c1"># Get limit</span>
                                     <span class="n">profile</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">default_settings</span><span class="p">,</span> <span class="s1">&#39;performance_profile&#39;</span><span class="p">,</span> <span class="s1">&#39;PRO&#39;</span><span class="p">)</span>
                                     <span class="n">required_year</span> <span class="o">=</span> <span class="mi">2015</span>
                                     <span class="k">if</span> <span class="n">profile</span> <span class="o">==</span> <span class="s1">&#39;BALANCED&#39;</span><span class="p">:</span> <span class="n">required_year</span> <span class="o">=</span> <span class="mi">2020</span>
                                     <span class="k">elif</span> <span class="n">profile</span> <span class="o">==</span> <span class="s1">&#39;ECO&#39;</span><span class="p">:</span> <span class="n">required_year</span> <span class="o">=</span> <span class="mi">2023</span>
                                     
                                     <span class="c1"># If file starts BEFORE required year (e.g. 2015 &lt; 2020), we must update/trim</span>
                                     <span class="c1"># If file starts significantly AFTER required year (e.g. 2026 &gt; 2020), we must update/fetch more</span>
                                     <span class="k">if</span> <span class="n">first_date</span><span class="o">.</span><span class="n">year</span> <span class="o">&lt;</span> <span class="n">required_year</span><span class="p">:</span>
                                         <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">tf</span><span class="si">}</span><span class="s2">] File trimming required (</span><span class="si">{</span><span class="n">first_date</span><span class="o">.</span><span class="n">year</span><span class="si">}</span><span class="s2"> &lt; </span><span class="si">{</span><span class="n">required_year</span><span class="si">}</span><span class="s2">). Forcing update.&quot;</span><span class="p">)</span>
                                         <span class="n">is_fresh</span> <span class="o">=</span> <span class="kc">False</span>
                                     <span class="k">elif</span> <span class="n">first_date</span><span class="o">.</span><span class="n">year</span> <span class="o">&gt;</span> <span class="n">required_year</span> <span class="ow">and</span> <span class="n">required_year</span> <span class="o">&lt;</span> <span class="mi">2024</span><span class="p">:</span>
                                          <span class="c1"># Only complain if gap is large (&gt;1 year)? </span>
                                          <span class="c1"># No, let&#39;s keep it simple. If we want 2020 and have 2026, we fetch.</span>
                                          <span class="c1"># But avoid spamming if broker limit (1m).</span>
                                          <span class="k">if</span> <span class="n">tf</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;1m&#39;</span><span class="p">,</span> <span class="s1">&#39;5m&#39;</span><span class="p">,</span> <span class="s1">&#39;15m&#39;</span><span class="p">]:</span> <span class="c1"># Ignore low TFs broker limits</span>
                                               <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">tf</span><span class="si">}</span><span class="s2">] Missing history (</span><span class="si">{</span><span class="n">first_date</span><span class="o">.</span><span class="n">year</span><span class="si">}</span><span class="s2"> &gt; </span><span class="si">{</span><span class="n">required_year</span><span class="si">}</span><span class="s2">). Forcing update.&quot;</span><span class="p">)</span>
                                               <span class="n">is_fresh</span> <span class="o">=</span> <span class="kc">False</span>
                         <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                             <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not verify file content for </span><span class="si">{</span><span class="n">tf</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                             <span class="n">is_fresh</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="k">if</span> <span class="n">is_fresh</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">tf</span><span class="si">}</span><span class="s2">] OHLC is fresh (</span><span class="si">{</span><span class="n">age_mins</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">m &lt; </span><span class="si">{</span><span class="n">limit_mins</span><span class="si">}</span><span class="s2">m), skipping extraction.&quot;</span><span class="p">)</span>
                        <span class="n">results</span><span class="p">[</span><span class="n">tf</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;fresh&quot;</span>
                        <span class="k">if</span> <span class="n">callback</span><span class="p">:</span>
                            <span class="n">callback</span><span class="p">(</span><span class="n">tf</span><span class="p">,</span> <span class="s2">&quot;complete&quot;</span><span class="p">,</span> <span class="s2">&quot;Fresh&quot;</span><span class="p">)</span>
                        <span class="n">needs_update</span> <span class="o">=</span> <span class="kc">False</span>
                
                <span class="k">if</span> <span class="n">needs_update</span><span class="p">:</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_ohlc</span><span class="p">(</span><span class="n">tf</span><span class="p">,</span> <span class="n">is_update</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">results</span><span class="p">[</span><span class="n">tf</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">tf</span><span class="si">}</span><span class="s2">] OHLC updated: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2"> candles.&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">callback</span><span class="p">:</span>
                            <span class="n">callback</span><span class="p">(</span><span class="n">tf</span><span class="p">,</span> <span class="s2">&quot;complete&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">results</span><span class="p">[</span><span class="n">tf</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;no_new_data&quot;</span>
                        <span class="k">if</span> <span class="n">callback</span><span class="p">:</span>
                            <span class="n">callback</span><span class="p">(</span><span class="n">tf</span><span class="p">,</span> <span class="s2">&quot;complete&quot;</span><span class="p">,</span> <span class="s2">&quot;Up-to-date&quot;</span><span class="p">)</span>
                            
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">tf</span><span class="si">}</span><span class="s2">] Bulk OHLC update failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">results</span><span class="p">[</span><span class="n">tf</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="n">callback</span><span class="p">:</span>
                    <span class="n">callback</span><span class="p">(</span><span class="n">tf</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;📥 [Bulk OHLC] Complete. Results: </span><span class="si">{</span><span class="n">results</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">results</span></div>


<div class="viewcode-block" id="MT5Connector.get_buffer">
<a class="viewcode-back" href="../../api/core.html#core.mt5_connector.MT5Connector.get_buffer">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2000</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get latest N candles directly for In-Memory prediction (FAST BUFFER).</span>
<span class="sd">        </span>
<span class="sd">        NOTE: This is NOT for training. It fetches a small buffer (e.g. 2000 candles)</span>
<span class="sd">        to allow rapid indicator calculation for real-time signals.</span>
<span class="sd">        </span>
<span class="sd">        CRITICAL OPTIMIZATION: save_to_disk=False</span>
<span class="sd">        We do NOT update the massive CSV on every tick. </span>
<span class="sd">        TrainingManager handles historical updates (&quot;Smart Update&quot;).</span>
<span class="sd">        Prediction only needs the in-memory data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_latest_candles</span><span class="p">(</span><span class="n">timeframe</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">save_to_disk</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="MT5Connector.get_latest_candles">
<a class="viewcode-back" href="../../api/core.html#core.mt5_connector.MT5Connector.get_latest_candles">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_latest_candles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">save_to_disk</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get latest N candles from MT5 (lightweight)&quot;&quot;&quot;</span>
        <span class="c1"># Phase 1: MT5 Interaction (Protected)</span>
        <span class="n">rates</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">():</span>
                    <span class="k">return</span> <span class="kc">None</span>
                
                <span class="n">tf_config</span> <span class="o">=</span> <span class="n">get_timeframe_by_name</span><span class="p">(</span><span class="n">timeframe</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">tf_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
                
                <span class="c1"># TIMEOUT WRAPPER</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">concurrent.futures</span><span class="w"> </span><span class="kn">import</span> <span class="n">ThreadPoolExecutor</span><span class="p">,</span> <span class="ne">TimeoutError</span> <span class="k">as</span> <span class="n">FuturesTimeout</span>
                
                <span class="k">def</span><span class="w"> </span><span class="nf">_fetch_pos</span><span class="p">():</span>
                    <span class="k">return</span> <span class="n">mt5</span><span class="o">.</span><span class="n">copy_rates_from_pos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span> <span class="n">tf_config</span><span class="o">.</span><span class="n">mt5_timeframe</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
                
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">t0</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
                    <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
                        <span class="n">future</span> <span class="o">=</span> <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">_fetch_pos</span><span class="p">)</span>
                        <span class="n">rates</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span> <span class="c1"># 2s max timeout for live buffer</span>
                    <span class="n">dt</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span>
                    <span class="k">if</span> <span class="n">dt</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SLOW MT5 FETCH [</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">]: </span><span class="si">{</span><span class="n">dt</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">ms&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MT5 fetch [</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">]: </span><span class="si">{</span><span class="n">dt</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">ms&quot;</span><span class="p">)</span>

                <span class="k">except</span> <span class="n">FuturesTimeout</span><span class="p">:</span>
                     <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MT5 get_latest_candles timed out for </span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2"> (10s)&quot;</span><span class="p">)</span>
                     <span class="k">return</span> <span class="kc">None</span>
                     
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in get_latest_candles: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Phase 2: Processing &amp; IO (Unprotected by MT5 lock)</span>
        <span class="k">if</span> <span class="n">rates</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">rates</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rates</span><span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;tick_volume&#39;</span><span class="p">:</span> <span class="s1">&#39;volume&#39;</span><span class="p">})</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="s2">&quot;open&quot;</span><span class="p">,</span> <span class="s2">&quot;high&quot;</span><span class="p">,</span> <span class="s2">&quot;low&quot;</span><span class="p">,</span> <span class="s2">&quot;close&quot;</span><span class="p">,</span> <span class="s2">&quot;volume&quot;</span><span class="p">,</span> <span class="s2">&quot;spread&quot;</span><span class="p">]]</span>
            
            <span class="c1"># Save to CSV (Protected by File Lock internally)</span>
            <span class="k">if</span> <span class="n">save_to_disk</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_save_ohlc</span><span class="p">(</span><span class="n">timeframe</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">is_update</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span> <span class="c1"># Skipping disk I/O for speed</span>
            
            <span class="c1"># === DEBUG: EXTRACTION PROBE ===</span>
            <span class="k">if</span> <span class="n">get_debug_manager</span><span class="p">()</span><span class="o">.</span><span class="n">is_enabled</span><span class="p">(</span><span class="s2">&quot;EXTRACTION&quot;</span><span class="p">):</span>
                 <span class="n">get_debug_manager</span><span class="p">()</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;EXTRACTION&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] Fetched Buffer&quot;</span><span class="p">,</span> <span class="p">{</span>
                     <span class="s2">&quot;Rows&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">),</span>
                     <span class="s2">&quot;Start&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                     <span class="s2">&quot;End&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                 <span class="p">})</span>

            <span class="k">return</span> <span class="n">df</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing latest candles for </span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span></div>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">_save_ohlc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">is_update</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save OHLC data to CSV with optimization for updates&quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">core.data_validator</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_validator</span>
        
        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ohlc_path</span><span class="p">(</span><span class="n">timeframe</span><span class="p">)</span>
        <span class="n">validator</span> <span class="o">=</span> <span class="n">get_validator</span><span class="p">()</span>
        
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_lock</span><span class="p">:</span>
            <span class="c1"># OPTIMIZED APPEND PATH - DISABLED for stability (issues with freshness)</span>
            <span class="k">if</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">is_update</span> <span class="ow">and</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># 1. Read ONLY the last timestamp (fast)</span>
                    <span class="c1"># We assume time is sorted.</span>
                    <span class="c1"># Standard pandas read_csv is slow for large files.</span>
                    <span class="c1"># For massive files, we should use &#39;seek&#39; but let&#39;s try reading just tail first.</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># Logic: Read last 5 lines to be safe</span>
                        <span class="c1"># Use engine=&#39;c&#39; for speed, skip lines? No, skipfooter/skiprows logic is messy.</span>
                        <span class="c1"># Simple approach: Read generic. If massive, this line is the bottleneck.</span>
                        <span class="c1"># BUT, appending implies we trust the file structure.</span>
                        
                        <span class="c1"># Better: use partial read if supported, or just trust the append logic?</span>
                        <span class="c1"># We must prevent duplicates.</span>
                        <span class="c1"># Let&#39;s read the full file ONLY if we can&#39;t determine the last time easily.</span>
                        <span class="c1"># Actually, for 1m data (1M rows), read_csv takes ~200ms. Writing takes longer.</span>
                        <span class="c1"># We want to Avoid reading everything if possible.</span>
                        
                        <span class="c1"># Peak efficiency: Read existing last timestamp.</span>
                        <span class="kn">import</span><span class="w"> </span><span class="nn">csv</span>
                        <span class="n">last_time</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                            <span class="c1"># Seek to end</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="c1"># End</span>
                                <span class="n">f_len</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
                                <span class="c1"># Backtrack a bit to find last line</span>
                                <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">2000</span><span class="p">,</span> <span class="mi">100</span><span class="p">):</span> <span class="c1"># Dynamic backtrack</span>
                                    <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">f_len</span><span class="p">:</span> <span class="n">i</span> <span class="o">=</span> <span class="n">f_len</span>
                                    <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">f_len</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span>
                                    <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
                                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span> <span class="c1"># Header + at least one line (or just data)</span>
                                        <span class="n">last_line</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                                        <span class="k">if</span> <span class="n">last_line</span><span class="p">:</span>
                                            <span class="c1"># Parse last line (Time,Open,High,Low,Close,Volume,Spread)</span>
                                            <span class="n">parts</span> <span class="o">=</span> <span class="n">last_line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                                                <span class="n">last_time</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                                <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                                                <span class="k">break</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span> 
                                    <span class="k">pass</span> <span class="c1"># Fallback</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="k">pass</span> <span class="c1"># formatting error, fallback</span>
                        
                        <span class="k">if</span> <span class="n">last_time</span><span class="p">:</span>
                             <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] File last_time: </span><span class="si">{</span><span class="n">last_time</span><span class="si">}</span><span class="s2">. New data range: </span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                             <span class="c1"># Filter NEW data only</span>
                             <span class="n">df_new</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">last_time</span><span class="p">]</span>
                             
                             <span class="k">if</span> <span class="n">df_new</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                                 <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] No new data after filtering (File up to </span><span class="si">{</span><span class="n">last_time</span><span class="si">}</span><span class="s2">, Fetched up to </span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                                 <span class="k">return</span> <span class="c1"># Nothing to append</span>
                             
                             <span class="n">df</span> <span class="o">=</span> <span class="n">df_new</span>
                             
                        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                            <span class="k">return</span> <span class="c1"># Nothing to append</span>
                            
                        <span class="c1"># Validate ONLY the new chunk</span>
                        <span class="n">df</span><span class="p">,</span> <span class="n">report</span> <span class="o">=</span> <span class="n">validator</span><span class="o">.</span><span class="n">validate_and_clean</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">)</span>
                        
                        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                            <span class="k">return</span>
                            
                        <span class="c1"># Append</span>
                        <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                        
                        <span class="c1"># Metadata update</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="c1"># Incremental metadata update in DB (Requires custom logic or full re-calc?)</span>
                            <span class="c1"># DB expects full candle count. We might need to estimate or just skip count update to save time?</span>
                            <span class="c1"># Let&#39;s Skip DB update on fast path to avoid overhead, or just update last_date.</span>
                            <span class="k">pass</span> 
                        <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>
                        
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Appended </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2"> candles to </span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">return</span>

                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fast append failed for </span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">, falling back to full rewrite: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="c1"># Fallback to slow path below</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>

            <span class="c1"># SLOW PATH (Full Write / Initial)</span>
            <span class="k">if</span> <span class="n">is_update</span> <span class="ow">and</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">existing_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">])</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">existing_df</span><span class="p">,</span> <span class="n">df</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">],</span> <span class="n">keep</span><span class="o">=</span><span class="s1">&#39;last&#39;</span><span class="p">)</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error reading existing OHLC for append: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            

            
            <span class="c1"># Validate full dataset</span>
            <span class="n">df</span><span class="p">,</span> <span class="n">report</span> <span class="o">=</span> <span class="n">validator</span><span class="o">.</span><span class="n">validate_and_clean</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">)</span>
            
            <span class="c1"># --- ENFORCE PROFILE LIMITS (TRIMMING) ---</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_enforce_profile_limits</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">report</span><span class="p">[</span><span class="s1">&#39;rows_removed&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">report</span><span class="p">[</span><span class="s1">&#39;rows_cleaned&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] Cleaned: removed </span><span class="si">{</span><span class="n">report</span><span class="p">[</span><span class="s1">&#39;rows_removed&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> rows, fixed </span><span class="si">{</span><span class="n">report</span><span class="p">[</span><span class="s1">&#39;rows_cleaned&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> values&quot;</span><span class="p">)</span>
            
            <span class="k">try</span><span class="p">:</span>
                <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved OHLC to </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2"> (Range: </span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error saving OHLC to </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span>
        
        <span class="c1"># Save metadata (Slow path only or lightweight update)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">db</span> <span class="o">=</span> <span class="n">get_database</span><span class="p">()</span>
            <span class="n">file_size_kb</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_size</span> <span class="o">/</span> <span class="mi">1024</span>
            <span class="n">db</span><span class="o">.</span><span class="n">update_ohlc_metadata</span><span class="p">(</span>
                <span class="n">timeframe</span><span class="o">=</span><span class="n">timeframe</span><span class="p">,</span>
                <span class="n">first_date</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
                <span class="n">last_date</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
                <span class="n">candle_count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">),</span>
                <span class="n">file_size_kb</span><span class="o">=</span><span class="n">file_size_kb</span><span class="p">,</span>
                <span class="n">file_path</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">),</span>
                <span class="n">source</span><span class="o">=</span><span class="s2">&quot;MT5&quot;</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span> <span class="k">pass</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_enforce_profile_limits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Trim DataFrame according to active Performance Profile&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span> <span class="k">return</span> <span class="n">df</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">profile</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">default_settings</span><span class="p">,</span> <span class="s1">&#39;performance_profile&#39;</span><span class="p">,</span> <span class="s1">&#39;PRO&#39;</span><span class="p">)</span>
            <span class="n">limit_year</span> <span class="o">=</span> <span class="mi">2015</span> <span class="c1"># Default</span>
            
            <span class="k">if</span> <span class="n">profile</span> <span class="o">==</span> <span class="s1">&#39;BALANCED&#39;</span><span class="p">:</span> <span class="n">limit_year</span> <span class="o">=</span> <span class="mi">2020</span>
            <span class="k">elif</span> <span class="n">profile</span> <span class="o">==</span> <span class="s1">&#39;ECO&#39;</span><span class="p">:</span> <span class="n">limit_year</span> <span class="o">=</span> <span class="mi">2023</span>
            
            <span class="n">limit_date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">limit_year</span><span class="si">}</span><span class="s2">-01-01&quot;</span><span class="p">)</span>
            
            <span class="c1"># Check if trimming needed</span>
            <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">limit_date</span><span class="p">:</span>
                <span class="n">original_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">limit_date</span><span class="p">]</span>
                <span class="n">new_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">original_len</span> <span class="o">!=</span> <span class="n">new_len</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">] Trimmed data for </span><span class="si">{</span><span class="n">profile</span><span class="si">}</span><span class="s2"> profile: </span><span class="si">{</span><span class="n">original_len</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">new_len</span><span class="si">}</span><span class="s2"> candles (&gt;= </span><span class="si">{</span><span class="n">limit_year</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                    
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to enforce profile limits: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
        <span class="k">return</span> <span class="n">df</span>

<div class="viewcode-block" id="MT5Connector.load_ohlc">
<a class="viewcode-back" href="../../api/core.html#core.mt5_connector.MT5Connector.load_ohlc">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_ohlc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load OHLC data from CSV&quot;&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ohlc_path</span><span class="p">(</span><span class="n">timeframe</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_lock</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">])</span>
                <span class="k">return</span> <span class="n">df</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load OHLC for </span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span></div>

                
<div class="viewcode-block" id="MT5Connector.load_ohlc_buffer">
<a class="viewcode-back" href="../../api/core.html#core.mt5_connector.MT5Connector.load_ohlc_buffer">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_ohlc_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fast disk load: reads only the last N rows of the CSV.</span>
<span class="sd">        Crucial for large 1m files (200MB+) to prevent real-time stalls.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ohlc_path</span><span class="p">(</span><span class="n">timeframe</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span> 
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;OHLC path does not exist: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_lock</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># ROBUST TAIL READ STRATEGY (O(1) Speed)</span>
                <span class="c1"># Instead of guessing row counts, we read the last X bytes of the file.</span>
                
                <span class="c1"># 1. Estimate bytes needed: 2000 rows * ~100 bytes = 200KB</span>
                <span class="c1"># Let&#39;s read 500KB to be safe.</span>
                <span class="n">bytes_to_read</span> <span class="o">=</span> <span class="n">n</span> <span class="o">*</span> <span class="mi">150</span> <span class="c1"># 150 bytes avg row size safety margin</span>
                
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="c1"># Move to end</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="n">size</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
                    
                    <span class="k">if</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="n">bytes_to_read</span><span class="p">:</span>
                        <span class="c1"># File smaller than buffer, read all</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Move back</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="o">-</span><span class="n">bytes_to_read</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                        <span class="c1"># Read to end</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                        
                        <span class="c1"># Discard the first partial line</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="c1"># Try to find first newline</span>
                            <span class="n">first_cal</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">first_cal</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">first_cal</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
                        <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>
                
                <span class="kn">from</span><span class="w"> </span><span class="nn">io</span><span class="w"> </span><span class="kn">import</span> <span class="n">BytesIO</span>
                <span class="c1"># We need header names since we skipped the real header</span>
                <span class="n">header</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                
                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
                    <span class="n">BytesIO</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> 
                    <span class="n">names</span><span class="o">=</span><span class="n">header</span><span class="p">,</span> 
                    <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                    <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="n">df</span>
                
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exception in load_ohlc_buffer: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load OHLC buffer for </span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1"># Fallback to full load if optimized fails</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_ohlc</span><span class="p">(</span><span class="n">timeframe</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="MT5Connector.get_ohlc_status">
<a class="viewcode-back" href="../../api/core.html#core.mt5_connector.MT5Connector.get_ohlc_status">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_ohlc_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get status of OHLC file for a timeframe&quot;&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ohlc_path</span><span class="p">(</span><span class="n">timeframe</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;exists&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">),</span>
                <span class="s2">&quot;candles&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;from_date&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;to_date&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">}</span>
        
        <span class="c1"># We reuse load_ohlc which has the lock</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_ohlc</span><span class="p">(</span><span class="n">timeframe</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;exists&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">),</span>
                <span class="s2">&quot;candles&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;from_date&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;to_date&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">}</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;exists&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">),</span>
            <span class="s2">&quot;candles&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">),</span>
            <span class="s2">&quot;from_date&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
            <span class="s2">&quot;to_date&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
        <span class="p">}</span></div>

    
<div class="viewcode-block" id="MT5Connector.extract_all">
<a class="viewcode-back" href="../../api/core.html#core.mt5_connector.MT5Connector.extract_all">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">extract_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_update</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">from_year</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract OHLC for all timeframes&quot;&quot;&quot;</span>
        <span class="n">from_date</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">from_year</span><span class="p">:</span>
            <span class="n">from_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="n">from_year</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            
        <span class="k">for</span> <span class="n">tf</span> <span class="ow">in</span> <span class="n">TIMEFRAMES</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">extract_ohlc</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">is_update</span><span class="o">=</span><span class="n">is_update</span><span class="p">,</span> <span class="n">from_date</span><span class="o">=</span><span class="n">from_date</span><span class="p">)</span></div>

    
    <span class="k">def</span><span class="w"> </span><span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span>
    
    <span class="k">def</span><span class="w"> </span><span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span></div>



<span class="c1"># ─────────────────────────────────────────────────────────────────────────────</span>
<span class="c1"># SINGLETON ACCESSOR (for use by chart_widget and other modules)</span>
<span class="c1"># ─────────────────────────────────────────────────────────────────────────────</span>
<span class="n">_global_connector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">MT5Connector</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>


<div class="viewcode-block" id="get_mt5_connector">
<a class="viewcode-back" href="../../api/core.html#core.mt5_connector.get_mt5_connector">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_mt5_connector</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">MT5Connector</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get or create the global MT5Connector instance.&quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">_global_connector</span>
    <span class="k">if</span> <span class="n">_global_connector</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_global_connector</span> <span class="o">=</span> <span class="n">MT5Connector</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">_global_connector</span></div>

</pre>
                            </div>

                        </div>
                    </div>
                    <footer>

                        <hr />

                        <div role="contentinfo">
                            <p>&#169; Copyright 2026, BMZ Business, LLC.</p>
                        </div>

                        Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
                        <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
                        provided by <a href="https://readthedocs.org">Read the Docs</a>.


                    </footer>
                </div>
            </div>
        </section>
    </div>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>

</html>