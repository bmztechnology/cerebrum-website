<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>core.congress_engine &mdash; Cerebrum Forex Documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=9edc463e" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />


    <link rel="shortcut icon" href="../../_static/icon.ico" />
    <script src="../../_static/jquery.js?v=5d32c60e"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
    <script src="../../_static/documentation_options.js?v=8d563738"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
</head>

<body class="wy-body-for-nav">
    <div class="wy-grid-for-nav">
        <nav data-toggle="wy-nav-shift" class="wy-nav-side">
            <div class="wy-side-scroll">
                <div class="wy-side-nav-search" style="background: #1e293b">



                    <a href="../../index.html" class="icon icon-home">
                        Cerebrum Forex
                        <img src="../../_static/icon.ico" class="logo" alt="Logo" />
                    </a>
                    <div role="search">
                        <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
                            <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
                            <input type="hidden" name="check_keywords" value="yes" />
                            <input type="hidden" name="area" value="default" />
                        </form>
                    </div>
                </div>
                <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
                    <p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
                    <ul>
                        <li class="toctree-l1"><a class="reference internal"
                                href="../../installation.html">Installation</a>
                            <ul>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../installation.html#prerequisites">Prerequisites</a></li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../installation.html#installation-via-setup">Installation via Setup</a>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../installation.html#developer-installation">Developer Installation</a>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../installation.html#metatrader-5-configuration">MetaTrader 5
                                        Configuration</a></li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../installation.html#verifying-the-installation">Verifying the
                                        Installation</a></li>
                            </ul>
                        </li>
                        <li class="toctree-l1"><a class="reference internal" href="../../quickstart.html">Quick
                                Start</a>
                            <ul>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../quickstart.html#step-1-connect-to-mt5">Step 1: Connect to MT5</a>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../quickstart.html#step-2-data-extraction">Step 2: Data Extraction</a>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../quickstart.html#step-3-model-training">Step 3: Model Training</a>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../quickstart.html#step-4-predictions">Step 4: Predictions</a></li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../quickstart.html#signal-interpretation">Signal Interpretation</a>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../quickstart.html#next-steps">Next Steps</a></li>
                            </ul>
                        </li>
                    </ul>
                    <p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
                    <ul>
                        <li class="toctree-l1"><a class="reference internal" href="../../api/core.html">Core Module
                                Reference</a>
                            <ul>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../api/core.html#module-core.mt5_connector">MT5 Connector</a>
                                    <ul>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.mt5_connector.MT5Connector"><code
                                                    class="docutils literal notranslate"><span class="pre">MT5Connector</span></code></a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.mt5_connector.MT5Connector.add_callback"><code
                                                            class="docutils literal notranslate"><span class="pre">MT5Connector.add_callback()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.mt5_connector.MT5Connector.close_all_positions"><code
                                                            class="docutils literal notranslate"><span class="pre">MT5Connector.close_all_positions()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.mt5_connector.MT5Connector.connect"><code
                                                            class="docutils literal notranslate"><span class="pre">MT5Connector.connect()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.mt5_connector.MT5Connector.check_health"><code
                                                            class="docutils literal notranslate"><span class="pre">MT5Connector.check_health()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.mt5_connector.MT5Connector.disconnect"><code
                                                            class="docutils literal notranslate"><span class="pre">MT5Connector.disconnect()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.mt5_connector.MT5Connector.test_connection"><code
                                                            class="docutils literal notranslate"><span class="pre">MT5Connector.test_connection()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.mt5_connector.MT5Connector.get_terminal_data_path"><code
                                                            class="docutils literal notranslate"><span class="pre">MT5Connector.get_terminal_data_path()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.mt5_connector.MT5Connector.get_current_server_time"><code
                                                            class="docutils literal notranslate"><span class="pre">MT5Connector.get_current_server_time()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.mt5_connector.MT5Connector.get_server_time"><code
                                                            class="docutils literal notranslate"><span class="pre">MT5Connector.get_server_time()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.mt5_connector.MT5Connector.get_time_offset"><code
                                                            class="docutils literal notranslate"><span class="pre">MT5Connector.get_time_offset()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.mt5_connector.MT5Connector.get_account_info"><code
                                                            class="docutils literal notranslate"><span class="pre">MT5Connector.get_account_info()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.mt5_connector.MT5Connector.get_market_status"><code
                                                            class="docutils literal notranslate"><span class="pre">MT5Connector.get_market_status()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.mt5_connector.MT5Connector.get_ohlc_path"><code
                                                            class="docutils literal notranslate"><span class="pre">MT5Connector.get_ohlc_path()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.mt5_connector.MT5Connector.extract_ohlc"><code
                                                            class="docutils literal notranslate"><span class="pre">MT5Connector.extract_ohlc()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.mt5_connector.MT5Connector.update_all_ohlc"><code
                                                            class="docutils literal notranslate"><span class="pre">MT5Connector.update_all_ohlc()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.mt5_connector.MT5Connector.get_buffer"><code
                                                            class="docutils literal notranslate"><span class="pre">MT5Connector.get_buffer()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.mt5_connector.MT5Connector.get_latest_candles"><code
                                                            class="docutils literal notranslate"><span class="pre">MT5Connector.get_latest_candles()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.mt5_connector.MT5Connector.load_ohlc"><code
                                                            class="docutils literal notranslate"><span class="pre">MT5Connector.load_ohlc()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.mt5_connector.MT5Connector.load_ohlc_buffer"><code
                                                            class="docutils literal notranslate"><span class="pre">MT5Connector.load_ohlc_buffer()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.mt5_connector.MT5Connector.get_ohlc_status"><code
                                                            class="docutils literal notranslate"><span class="pre">MT5Connector.get_ohlc_status()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.mt5_connector.MT5Connector.extract_all"><code
                                                            class="docutils literal notranslate"><span class="pre">MT5Connector.extract_all()</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.mt5_connector.get_mt5_connector"><code
                                                    class="docutils literal notranslate"><span class="pre">get_mt5_connector()</span></code></a>
                                        </li>
                                    </ul>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../api/core.html#module-core.prediction_engine">Prediction Engine</a>
                                    <ul>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.prediction_engine.PredictionEngine"><code
                                                    class="docutils literal notranslate"><span class="pre">PredictionEngine</span></code></a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.prediction_engine.PredictionEngine.add_callback"><code
                                                            class="docutils literal notranslate"><span class="pre">PredictionEngine.add_callback()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.prediction_engine.PredictionEngine.remove_callback"><code
                                                            class="docutils literal notranslate"><span class="pre">PredictionEngine.remove_callback()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.prediction_engine.PredictionEngine.get_signal_path"><code
                                                            class="docutils literal notranslate"><span class="pre">PredictionEngine.get_signal_path()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.prediction_engine.PredictionEngine.predict_timeframe"><code
                                                            class="docutils literal notranslate"><span class="pre">PredictionEngine.predict_timeframe()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.prediction_engine.PredictionEngine.load_signal"><code
                                                            class="docutils literal notranslate"><span class="pre">PredictionEngine.load_signal()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.prediction_engine.PredictionEngine.reset_engine"><code
                                                            class="docutils literal notranslate"><span class="pre">PredictionEngine.reset_engine()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.prediction_engine.PredictionEngine.predict_all"><code
                                                            class="docutils literal notranslate"><span class="pre">PredictionEngine.predict_all()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.prediction_engine.PredictionEngine.get_prediction_status"><code
                                                            class="docutils literal notranslate"><span class="pre">PredictionEngine.get_prediction_status()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.prediction_engine.PredictionEngine.get_combined_signal"><code
                                                            class="docutils literal notranslate"><span class="pre">PredictionEngine.get_combined_signal()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.prediction_engine.PredictionEngine.get_congress_history"><code
                                                            class="docutils literal notranslate"><span class="pre">PredictionEngine.get_congress_history()</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                    </ul>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../api/core.html#module-core.training_manager">Training Manager</a>
                                    <ul>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.training_manager.TrainingLogBridge"><code
                                                    class="docutils literal notranslate"><span class="pre">TrainingLogBridge</span></code></a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.training_manager.TrainingLogBridge.emit"><code
                                                            class="docutils literal notranslate"><span class="pre">TrainingLogBridge.emit()</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.training_manager.RecoveryRequired"><code
                                                    class="docutils literal notranslate"><span class="pre">RecoveryRequired</span></code></a>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.training_manager.TrainingManager"><code
                                                    class="docutils literal notranslate"><span class="pre">TrainingManager</span></code></a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.training_manager.TrainingManager.add_callback"><code
                                                            class="docutils literal notranslate"><span class="pre">TrainingManager.add_callback()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.training_manager.TrainingManager.get_model"><code
                                                            class="docutils literal notranslate"><span class="pre">TrainingManager.get_model()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.training_manager.TrainingManager.get_normalizer"><code
                                                            class="docutils literal notranslate"><span class="pre">TrainingManager.get_normalizer()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.training_manager.TrainingManager.get_training_status"><code
                                                            class="docutils literal notranslate"><span class="pre">TrainingManager.get_training_status()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.training_manager.TrainingManager.should_train_incremental"><code
                                                            class="docutils literal notranslate"><span class="pre">TrainingManager.should_train_incremental()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.training_manager.TrainingManager.prepare_training_data"><code
                                                            class="docutils literal notranslate"><span class="pre">TrainingManager.prepare_training_data()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.training_manager.TrainingManager.train_timeframe"><code
                                                            class="docutils literal notranslate"><span class="pre">TrainingManager.train_timeframe()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.training_manager.TrainingManager.train_all"><code
                                                            class="docutils literal notranslate"><span class="pre">TrainingManager.train_all()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.training_manager.TrainingManager.train_with_drift_check"><code
                                                            class="docutils literal notranslate"><span class="pre">TrainingManager.train_with_drift_check()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.training_manager.TrainingManager.start_scheduled_training"><code
                                                            class="docutils literal notranslate"><span class="pre">TrainingManager.start_scheduled_training()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.training_manager.TrainingManager.stop_scheduled_training"><code
                                                            class="docutils literal notranslate"><span class="pre">TrainingManager.stop_scheduled_training()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.training_manager.TrainingManager.load_all_models"><code
                                                            class="docutils literal notranslate"><span class="pre">TrainingManager.load_all_models()</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                    </ul>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../api/core.html#module-core.feature_engine">Feature Engine</a>
                                    <ul>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.feature_engine.FeatureEngine"><code
                                                    class="docutils literal notranslate"><span class="pre">FeatureEngine</span></code></a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.feature_engine.FeatureEngine.calculate_all_features"><code
                                                            class="docutils literal notranslate"><span class="pre">FeatureEngine.calculate_all_features()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.feature_engine.FeatureEngine.get_feature_columns"><code
                                                            class="docutils literal notranslate"><span class="pre">FeatureEngine.get_feature_columns()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.feature_engine.FeatureEngine.select_best_features"><code
                                                            class="docutils literal notranslate"><span class="pre">FeatureEngine.select_best_features()</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                    </ul>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../api/core.html#module-core.app_controller">App Controller</a>
                                    <ul>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.app_controller.AppController"><code
                                                    class="docutils literal notranslate"><span class="pre">AppController</span></code></a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.app_controller.AppController.mt5"><code
                                                            class="docutils literal notranslate"><span class="pre">AppController.mt5</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.app_controller.AppController.training_manager"><code
                                                            class="docutils literal notranslate"><span class="pre">AppController.training_manager</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.app_controller.AppController.prediction_engine"><code
                                                            class="docutils literal notranslate"><span class="pre">AppController.prediction_engine</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.app_controller.AppController.scheduler"><code
                                                            class="docutils literal notranslate"><span class="pre">AppController.scheduler</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.app_controller.AppController.start"><code
                                                            class="docutils literal notranslate"><span class="pre">AppController.start()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.app_controller.AppController.stop"><code
                                                            class="docutils literal notranslate"><span class="pre">AppController.stop()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.app_controller.AppController.extract_all"><code
                                                            class="docutils literal notranslate"><span class="pre">AppController.extract_all()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.app_controller.AppController.predict_manual"><code
                                                            class="docutils literal notranslate"><span class="pre">AppController.predict_manual()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.app_controller.AppController.train_all"><code
                                                            class="docutils literal notranslate"><span class="pre">AppController.train_all()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.app_controller.AppController.predict_all"><code
                                                            class="docutils literal notranslate"><span class="pre">AppController.predict_all()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.app_controller.AppController.get_signal"><code
                                                            class="docutils literal notranslate"><span class="pre">AppController.get_signal()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.app_controller.AppController.get_combined_signal"><code
                                                            class="docutils literal notranslate"><span class="pre">AppController.get_combined_signal()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.app_controller.AppController.get_ohlc_status"><code
                                                            class="docutils literal notranslate"><span class="pre">AppController.get_ohlc_status()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.app_controller.AppController.get_training_status"><code
                                                            class="docutils literal notranslate"><span class="pre">AppController.get_training_status()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.app_controller.AppController.get_model"><code
                                                            class="docutils literal notranslate"><span class="pre">AppController.get_model()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.app_controller.AppController.get_settings"><code
                                                            class="docutils literal notranslate"><span class="pre">AppController.get_settings()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.app_controller.AppController.get_cached_account_info"><code
                                                            class="docutils literal notranslate"><span class="pre">AppController.get_cached_account_info()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.app_controller.AppController.save_settings"><code
                                                            class="docutils literal notranslate"><span class="pre">AppController.save_settings()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.app_controller.AppController.get_congress_config"><code
                                                            class="docutils literal notranslate"><span class="pre">AppController.get_congress_config()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.app_controller.AppController.save_congress_config"><code
                                                            class="docutils literal notranslate"><span class="pre">AppController.save_congress_config()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.app_controller.AppController.update_scheduler_config"><code
                                                            class="docutils literal notranslate"><span class="pre">AppController.update_scheduler_config()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.app_controller.AppController.sync_ea_config"><code
                                                            class="docutils literal notranslate"><span class="pre">AppController.sync_ea_config()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.app_controller.AppController.log_training_event"><code
                                                            class="docutils literal notranslate"><span class="pre">AppController.log_training_event()</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                    </ul>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../api/core.html#module-core.noble_kpi">Noble KPI</a>
                                    <ul>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#noble-safe-range-kpi-core-module">Noble Safe
                                                Range KPI - Core Module</a></li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.noble_kpi.MarketRegime"><code
                                                    class="docutils literal notranslate"><span class="pre">MarketRegime</span></code></a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.noble_kpi.MarketRegime.NORMAL"><code
                                                            class="docutils literal notranslate"><span class="pre">MarketRegime.NORMAL</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.noble_kpi.MarketRegime.LOW_VOL"><code
                                                            class="docutils literal notranslate"><span class="pre">MarketRegime.LOW_VOL</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.noble_kpi.MarketRegime.HIGH_VOL"><code
                                                            class="docutils literal notranslate"><span class="pre">MarketRegime.HIGH_VOL</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.noble_kpi.MarketRegime.CRISIS"><code
                                                            class="docutils literal notranslate"><span class="pre">MarketRegime.CRISIS</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.noble_kpi.calculate_atr_series"><code
                                                    class="docutils literal notranslate"><span class="pre">calculate_atr_series()</span></code></a>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.noble_kpi.detect_regime_series"><code
                                                    class="docutils literal notranslate"><span class="pre">detect_regime_series()</span></code></a>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.noble_kpi.calculate_atr"><code
                                                    class="docutils literal notranslate"><span class="pre">calculate_atr()</span></code></a>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.noble_kpi.detect_regime"><code
                                                    class="docutils literal notranslate"><span class="pre">detect_regime()</span></code></a>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.noble_kpi.noble_safe_range"><code
                                                    class="docutils literal notranslate"><span class="pre">noble_safe_range()</span></code></a>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.noble_kpi.calculate_position"><code
                                                    class="docutils literal notranslate"><span class="pre">calculate_position()</span></code></a>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.noble_kpi.get_recommendation"><code
                                                    class="docutils literal notranslate"><span class="pre">get_recommendation()</span></code></a>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.noble_kpi.analyze_timeframe"><code
                                                    class="docutils literal notranslate"><span class="pre">analyze_timeframe()</span></code></a>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.noble_kpi.validate_kpi"><code
                                                    class="docutils literal notranslate"><span class="pre">validate_kpi()</span></code></a>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.noble_kpi.calculate_noble_bias"><code
                                                    class="docutils literal notranslate"><span class="pre">calculate_noble_bias()</span></code></a>
                                        </li>
                                    </ul>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../api/core.html#module-core.congress_engine">Congress Engine</a>
                                    <ul>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.congress_engine.AladdinPersona"><code
                                                    class="docutils literal notranslate"><span class="pre">AladdinPersona</span></code></a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.AladdinPersona.QUANT"><code
                                                            class="docutils literal notranslate"><span class="pre">AladdinPersona.QUANT</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.AladdinPersona.ARCHIVIST"><code
                                                            class="docutils literal notranslate"><span class="pre">AladdinPersona.ARCHIVIST</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.AladdinPersona.FUTURIST"><code
                                                            class="docutils literal notranslate"><span class="pre">AladdinPersona.FUTURIST</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.AladdinPersona.GUARDIAN"><code
                                                            class="docutils literal notranslate"><span class="pre">AladdinPersona.GUARDIAN</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.AladdinPersona.LEADER"><code
                                                            class="docutils literal notranslate"><span class="pre">AladdinPersona.LEADER</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.AladdinPersona.SENTINEL"><code
                                                            class="docutils literal notranslate"><span class="pre">AladdinPersona.SENTINEL</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.congress_engine.ModelPrediction"><code
                                                    class="docutils literal notranslate"><span class="pre">ModelPrediction</span></code></a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.ModelPrediction.model_name"><code
                                                            class="docutils literal notranslate"><span class="pre">ModelPrediction.model_name</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.ModelPrediction.model_role"><code
                                                            class="docutils literal notranslate"><span class="pre">ModelPrediction.model_role</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.ModelPrediction.score"><code
                                                            class="docutils literal notranslate"><span class="pre">ModelPrediction.score</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.ModelPrediction.confidence"><code
                                                            class="docutils literal notranslate"><span class="pre">ModelPrediction.confidence</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.ModelPrediction.regime"><code
                                                            class="docutils literal notranslate"><span class="pre">ModelPrediction.regime</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.ModelPrediction.timeframe"><code
                                                            class="docutils literal notranslate"><span class="pre">ModelPrediction.timeframe</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.ModelPrediction.timestamp"><code
                                                            class="docutils literal notranslate"><span class="pre">ModelPrediction.timestamp</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.congress_engine.CongressDecision"><code
                                                    class="docutils literal notranslate"><span class="pre">CongressDecision</span></code></a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressDecision.final_signal"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressDecision.final_signal</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressDecision.final_score"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressDecision.final_score</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressDecision.final_confidence"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressDecision.final_confidence</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressDecision.detected_regime"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressDecision.detected_regime</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressDecision.certainty_boost"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressDecision.certainty_boost</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressDecision.flux_boost"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressDecision.flux_boost</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressDecision.trend_certainty"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressDecision.trend_certainty</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressDecision.duration_tf5"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressDecision.duration_tf5</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressDecision.threshold"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressDecision.threshold</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressDecision.model_predictions"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressDecision.model_predictions</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressDecision.flux_details"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressDecision.flux_details</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressDecision.weights_applied"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressDecision.weights_applied</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressDecision.timestamp"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressDecision.timestamp</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressDecision.override_type"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressDecision.override_type</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressDecision.to_dict"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressDecision.to_dict()</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.congress_engine.CongressEngine"><code
                                                    class="docutils literal notranslate"><span class="pre">CongressEngine</span></code></a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressEngine.CONGRESS_WEIGHTS"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressEngine.CONGRESS_WEIGHTS</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressEngine.DEFAULT_WEIGHTS"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressEngine.DEFAULT_WEIGHTS</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressEngine.BASE_THRESHOLD"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressEngine.BASE_THRESHOLD</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressEngine.LAMBDA"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressEngine.LAMBDA</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressEngine.KPI_GAMMA"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressEngine.KPI_GAMMA</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressEngine.CERTAINTY_BONUS"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressEngine.CERTAINTY_BONUS</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressEngine.__init__"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressEngine.__init__()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressEngine.detect_market_regime"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressEngine.detect_market_regime()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressEngine.calculate_adaptive_threshold"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressEngine.calculate_adaptive_threshold()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressEngine.get_weights"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressEngine.get_weights()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressEngine.aggregate"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressEngine.aggregate()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressEngine.get_decision_history"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressEngine.get_decision_history()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressEngine.simple_aggregate"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressEngine.simple_aggregate()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressEngine.make_decision_batch"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressEngine.make_decision_batch()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressEngine.aggregate_with_regime"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressEngine.aggregate_with_regime()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressEngine.full_aggregate"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressEngine.full_aggregate()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.congress_engine.CongressEngine.save_prediction_json"><code
                                                            class="docutils literal notranslate"><span class="pre">CongressEngine.save_prediction_json()</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.congress_engine.get_congress_engine"><code
                                                    class="docutils literal notranslate"><span class="pre">get_congress_engine()</span></code></a>
                                        </li>
                                    </ul>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../api/core.html#module-core.model_scorer">Model Scorer</a>
                                    <ul>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.model_scorer.PredictionOutcome"><code
                                                    class="docutils literal notranslate"><span class="pre">PredictionOutcome</span></code></a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.model_scorer.PredictionOutcome.model_name"><code
                                                            class="docutils literal notranslate"><span class="pre">PredictionOutcome.model_name</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.model_scorer.PredictionOutcome.timeframe"><code
                                                            class="docutils literal notranslate"><span class="pre">PredictionOutcome.timeframe</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.model_scorer.PredictionOutcome.predicted_signal"><code
                                                            class="docutils literal notranslate"><span class="pre">PredictionOutcome.predicted_signal</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.model_scorer.PredictionOutcome.actual_outcome"><code
                                                            class="docutils literal notranslate"><span class="pre">PredictionOutcome.actual_outcome</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.model_scorer.PredictionOutcome.confidence"><code
                                                            class="docutils literal notranslate"><span class="pre">PredictionOutcome.confidence</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.model_scorer.PredictionOutcome.timestamp"><code
                                                            class="docutils literal notranslate"><span class="pre">PredictionOutcome.timestamp</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.model_scorer.ModelScorer"><code
                                                    class="docutils literal notranslate"><span class="pre">ModelScorer</span></code></a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.model_scorer.ModelScorer.HISTORY_SIZE"><code
                                                            class="docutils literal notranslate"><span class="pre">ModelScorer.HISTORY_SIZE</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.model_scorer.ModelScorer.MIN_SAMPLES"><code
                                                            class="docutils literal notranslate"><span class="pre">ModelScorer.MIN_SAMPLES</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.model_scorer.ModelScorer.DYNAMIC_WEIGHT"><code
                                                            class="docutils literal notranslate"><span class="pre">ModelScorer.DYNAMIC_WEIGHT</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.model_scorer.ModelScorer.EMA_ALPHA"><code
                                                            class="docutils literal notranslate"><span class="pre">ModelScorer.EMA_ALPHA</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.model_scorer.ModelScorer.record_outcome"><code
                                                            class="docutils literal notranslate"><span class="pre">ModelScorer.record_outcome()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.model_scorer.ModelScorer.get_dynamic_weights"><code
                                                            class="docutils literal notranslate"><span class="pre">ModelScorer.get_dynamic_weights()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/core.html#core.model_scorer.ModelScorer.get_model_stats"><code
                                                            class="docutils literal notranslate"><span class="pre">ModelScorer.get_model_stats()</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/core.html#core.model_scorer.get_model_scorer"><code
                                                    class="docutils literal notranslate"><span class="pre">get_model_scorer()</span></code></a>
                                        </li>
                                    </ul>
                                </li>
                            </ul>
                        </li>
                        <li class="toctree-l1"><a class="reference internal" href="../../api/models.html">Models
                                Reference</a>
                            <ul>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../api/models.html#module-models.xgboost_model">XGBoost Model</a>
                                    <ul>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/models.html#models.xgboost_model.XGBoostModel"><code
                                                    class="docutils literal notranslate"><span class="pre">XGBoostModel</span></code></a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/models.html#models.xgboost_model.XGBoostModel.name"><code
                                                            class="docutils literal notranslate"><span class="pre">XGBoostModel.name</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/models.html#models.xgboost_model.XGBoostModel.train"><code
                                                            class="docutils literal notranslate"><span class="pre">XGBoostModel.train()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/models.html#models.xgboost_model.XGBoostModel.predict"><code
                                                            class="docutils literal notranslate"><span class="pre">XGBoostModel.predict()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/models.html#models.xgboost_model.XGBoostModel.load"><code
                                                            class="docutils literal notranslate"><span class="pre">XGBoostModel.load()</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                    </ul>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../api/models.html#module-models.lightgbm_model">LightGBM Model</a>
                                    <ul>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/models.html#models.lightgbm_model.LightGBMModel"><code
                                                    class="docutils literal notranslate"><span class="pre">LightGBMModel</span></code></a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/models.html#models.lightgbm_model.LightGBMModel.name"><code
                                                            class="docutils literal notranslate"><span class="pre">LightGBMModel.name</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/models.html#models.lightgbm_model.LightGBMModel.train"><code
                                                            class="docutils literal notranslate"><span class="pre">LightGBMModel.train()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/models.html#models.lightgbm_model.LightGBMModel.predict"><code
                                                            class="docutils literal notranslate"><span class="pre">LightGBMModel.predict()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/models.html#models.lightgbm_model.LightGBMModel.load"><code
                                                            class="docutils literal notranslate"><span class="pre">LightGBMModel.load()</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                    </ul>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../api/models.html#module-models.randomforest_model">RandomForest
                                        Model</a>
                                    <ul>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/models.html#models.randomforest_model.RandomForestModel"><code
                                                    class="docutils literal notranslate"><span class="pre">RandomForestModel</span></code></a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/models.html#models.randomforest_model.RandomForestModel.name"><code
                                                            class="docutils literal notranslate"><span class="pre">RandomForestModel.name</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/models.html#models.randomforest_model.RandomForestModel.train"><code
                                                            class="docutils literal notranslate"><span class="pre">RandomForestModel.train()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/models.html#models.randomforest_model.RandomForestModel.predict"><code
                                                            class="docutils literal notranslate"><span class="pre">RandomForestModel.predict()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/models.html#models.randomforest_model.RandomForestModel.load"><code
                                                            class="docutils literal notranslate"><span class="pre">RandomForestModel.load()</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                    </ul>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../api/models.html#module-models.stacking_model">Stacking Model</a>
                                    <ul>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/models.html#models.stacking_model.StackingModel"><code
                                                    class="docutils literal notranslate"><span class="pre">StackingModel</span></code></a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/models.html#models.stacking_model.StackingModel.name"><code
                                                            class="docutils literal notranslate"><span class="pre">StackingModel.name</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/models.html#models.stacking_model.StackingModel.train"><code
                                                            class="docutils literal notranslate"><span class="pre">StackingModel.train()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/models.html#models.stacking_model.StackingModel.predict"><code
                                                            class="docutils literal notranslate"><span class="pre">StackingModel.predict()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/models.html#models.stacking_model.StackingModel.load"><code
                                                            class="docutils literal notranslate"><span class="pre">StackingModel.load()</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                    </ul>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../api/models.html#module-models.meta_model">Meta Model</a>
                                    <ul>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/models.html#models.meta_model.MetaModel"><code
                                                    class="docutils literal notranslate"><span class="pre">MetaModel</span></code></a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/models.html#models.meta_model.MetaModel.prepare_meta_features"><code
                                                            class="docutils literal notranslate"><span class="pre">MetaModel.prepare_meta_features()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/models.html#models.meta_model.MetaModel.train"><code
                                                            class="docutils literal notranslate"><span class="pre">MetaModel.train()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/models.html#models.meta_model.MetaModel.predict_viability"><code
                                                            class="docutils literal notranslate"><span class="pre">MetaModel.predict_viability()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/models.html#models.meta_model.MetaModel.save"><code
                                                            class="docutils literal notranslate"><span class="pre">MetaModel.save()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/models.html#models.meta_model.MetaModel.load"><code
                                                            class="docutils literal notranslate"><span class="pre">MetaModel.load()</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                    </ul>
                                </li>
                            </ul>
                        </li>
                        <li class="toctree-l1"><a class="reference internal" href="../../api/gui.html">GUI Reference</a>
                            <ul>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../api/gui.html#module-gui.main_window">Main Window</a>
                                    <ul>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/gui.html#gui.main_window.MainWindow"><code
                                                    class="docutils literal notranslate"><span class="pre">MainWindow</span></code></a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/gui.html#gui.main_window.MainWindow.status_changed"><code
                                                            class="docutils literal notranslate"><span class="pre">MainWindow.status_changed</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/gui.html#gui.main_window.MainWindow.update_signal_display"><code
                                                            class="docutils literal notranslate"><span class="pre">MainWindow.update_signal_display()</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/gui.html#gui.main_window.MainWindow.closeEvent"><code
                                                            class="docutils literal notranslate"><span class="pre">MainWindow.closeEvent()</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                    </ul>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../api/gui.html#panels">Panels</a>
                                    <ul>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/gui.html#module-gui.panels.dashboard_panel">Dashboard
                                                Panel</a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/gui.html#gui.panels.dashboard_panel.PredictionWorker"><code
                                                            class="docutils literal notranslate"><span class="pre">PredictionWorker</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/gui.html#gui.panels.dashboard_panel.DashboardPanel"><code
                                                            class="docutils literal notranslate"><span class="pre">DashboardPanel</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/gui.html#module-gui.panels.extraction_panel">Extraction
                                                Panel</a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/gui.html#gui.panels.extraction_panel.ExtractionPanel"><code
                                                            class="docutils literal notranslate"><span class="pre">ExtractionPanel</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/gui.html#module-gui.panels.training_panel">Training
                                                Panel</a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/gui.html#gui.panels.training_panel.TrainingSignals"><code
                                                            class="docutils literal notranslate"><span class="pre">TrainingSignals</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/gui.html#gui.panels.training_panel.PhaseCard"><code
                                                            class="docutils literal notranslate"><span class="pre">PhaseCard</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/gui.html#gui.panels.training_panel.TrainingPanel"><code
                                                            class="docutils literal notranslate"><span class="pre">TrainingPanel</span></code></a>
                                                </li>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/gui.html#gui.panels.training_panel.SchedulerDialog"><code
                                                            class="docutils literal notranslate"><span class="pre">SchedulerDialog</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/gui.html#module-gui.panels.prediction_panel">Prediction
                                                Panel</a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/gui.html#gui.panels.prediction_panel.PredictionPanel"><code
                                                            class="docutils literal notranslate"><span class="pre">PredictionPanel</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/gui.html#module-gui.panels.settings_panel">Settings
                                                Panel</a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/gui.html#gui.panels.settings_panel.SettingsPanel"><code
                                                            class="docutils literal notranslate"><span class="pre">SettingsPanel</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                    </ul>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../api/gui.html#workers">Workers</a>
                                    <ul>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../api/gui.html#module-gui.workers.prediction_worker">Prediction
                                                Worker</a>
                                            <ul>
                                                <li class="toctree-l4"><a class="reference internal"
                                                        href="../../api/gui.html#gui.workers.prediction_worker.PredictionWorker"><code
                                                            class="docutils literal notranslate"><span class="pre">PredictionWorker</span></code></a>
                                                </li>
                                            </ul>
                                        </li>
                                    </ul>
                                </li>
                            </ul>
                        </li>
                    </ul>
                    <p class="caption" role="heading"><span class="caption-text">Resources</span></p>
                    <ul>
                        <li class="toctree-l1"><a class="reference internal" href="../../changelog.html">Changelog</a>
                            <ul>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../changelog.html#version-1-0-0-january-2026">Version 1.0.0 (January
                                        2026)</a>
                                    <ul>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../changelog.html#new-features">New Features</a></li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../changelog.html#improvements">Improvements</a></li>
                                        <li class="toctree-l3"><a class="reference internal"
                                                href="../../changelog.html#bug-fixes">Bug Fixes</a></li>
                                    </ul>
                                </li>
                            </ul>
                        </li>
                        <li class="toctree-l1"><a class="reference internal"
                                href="../../contributing.html">Contributing</a>
                            <ul>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../contributing.html#how-to-contribute">How to Contribute</a></li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../contributing.html#code-style">Code Style</a></li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../contributing.html#reporting-bugs">Reporting Bugs</a></li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../contributing.html#contact">Contact</a></li>
                            </ul>
                        </li>
                        <li class="toctree-l1"><a class="reference internal" href="../../sphinx_tech.html">Sphinx
                                Documentation System</a>
                            <ul>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../sphinx_tech.html#sphinx-engine"> Sphinx Engine</a></li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../sphinx_tech.html#parsing"> Parsing</a></li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../sphinx_tech.html#reference-resolution"> Reference Resolution</a>
                                </li>
                                <li class="toctree-l2"><a class="reference internal"
                                        href="../../sphinx_tech.html#tree-generation-rtd-theme"> Tree Generation (RTD
                                        Theme)</a></li>
                            </ul>
                        </li>
                    </ul>

                </div>
            </div>
        </nav>

        <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
            <nav class="wy-nav-top" aria-label="Mobile navigation menu" style="background: #1e293b">
                <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
                <a href="../../index.html">Cerebrum Forex</a>
            </nav>

            <div class="wy-nav-content">
                <div class="rst-content">
                    <div role="navigation" aria-label="Page navigation">
                        <ul class="wy-breadcrumbs">
                            <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
                            <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
                            <li class="breadcrumb-item active">core.congress_engine</li>
                            <li class="wy-breadcrumbs-aside">
                            </li>
                        </ul>
                        <hr />
                    </div>
                    <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
                        <div itemprop="articleBody">

                            <h1>Source code for core.congress_engine</h1>
                            <div class="highlight">
                                <pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Cerebrum Forex - Congress Engine</span>
<span class="sd">Weighted ensemble aggregation with regime detection.</span>

<span class="sd">The Congress Engine combines predictions from multiple specialized models</span>
<span class="sd">using adaptive weights based on market regime and timeframe.</span>

<span class="sd">Key features:</span>
<span class="sd">- Weighted aggregation with adaptive threshold</span>
<span class="sd">- Regime detection (trend vs range)</span>
<span class="sd">- Full audit trail for explainability</span>
<span class="sd">- Dynamic weight adjustment based on model performance</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">core.noble_kpi</span><span class="w"> </span><span class="kn">import</span> <span class="n">calculate_atr</span><span class="p">,</span> <span class="n">detect_regime</span><span class="p">,</span> <span class="n">MarketRegime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">core.model_scorer</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_model_scorer</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="AladdinPersona">
<a class="viewcode-back" href="../../api/core.html#core.congress_engine.AladdinPersona">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">AladdinPersona</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Aladdin &#39;Council of Experts&#39; Personas&quot;&quot;&quot;</span>
    <span class="n">QUANT</span> <span class="o">=</span> <span class="s2">&quot;quant&quot;</span>              <span class="c1"># The Mathematician (Microstructure/Timing)</span>
    <span class="n">ARCHIVIST</span> <span class="o">=</span> <span class="s2">&quot;archivist&quot;</span>      <span class="c1"># The Financial Historian (Technical Indicators)</span>
    <span class="n">FUTURIST</span> <span class="o">=</span> <span class="s2">&quot;futurist&quot;</span>        <span class="c1"># The Pattern Recognizer (Context/Macro)</span>
    <span class="n">GUARDIAN</span> <span class="o">=</span> <span class="s2">&quot;guardian&quot;</span>        <span class="c1"># The Risk Manager (Volatility/Regime)</span>
    <span class="n">LEADER</span> <span class="o">=</span> <span class="s2">&quot;leader&quot;</span>             <span class="c1"># The Ensemble Leader (Stacking)</span>
    <span class="n">SENTINEL</span> <span class="o">=</span> <span class="s2">&quot;sentinel&quot;</span>        <span class="c1"># The Watcher (CatBoost/Robustness)</span></div>



<div class="viewcode-block" id="ModelPrediction">
<a class="viewcode-back" href="../../api/core.html#core.congress_engine.ModelPrediction">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ModelPrediction</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Standardized model output&quot;&quot;&quot;</span>
    <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">model_role</span><span class="p">:</span> <span class="n">AladdinPersona</span>
    <span class="n">score</span><span class="p">:</span> <span class="nb">float</span>           <span class="c1"># [-1, +1] directional score</span>
    <span class="n">confidence</span><span class="p">:</span> <span class="nb">float</span>      <span class="c1"># [0, 1] prediction confidence</span>
    <span class="n">regime</span><span class="p">:</span> <span class="nb">str</span>            <span class="c1"># &#39;trend&#39; or &#39;range&#39;</span>
    <span class="n">timeframe</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">timestamp</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">)</span></div>



<div class="viewcode-block" id="CongressDecision">
<a class="viewcode-back" href="../../api/core.html#core.congress_engine.CongressDecision">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">CongressDecision</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Final decision with full audit trail&quot;&quot;&quot;</span>
    <span class="n">final_signal</span><span class="p">:</span> <span class="nb">str</span>          <span class="c1"># BUY, SELL, NEUTRAL</span>
    <span class="n">final_score</span><span class="p">:</span> <span class="nb">float</span>         <span class="c1"># [-1, +1] weighted aggregate</span>
    <span class="n">final_confidence</span><span class="p">:</span> <span class="nb">float</span>    <span class="c1"># [0, 1] aggregate confidence</span>
    <span class="n">detected_regime</span><span class="p">:</span> <span class="nb">str</span>       <span class="c1"># Market regime used</span>
    <span class="n">certainty_boost</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="c1"># Added certainty bonus</span>
    <span class="n">flux_boost</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>      <span class="c1"># Physics-based acceleration boost</span>
    <span class="n">trend_certainty</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="c1"># TF/5 Trend Certainty [0, 1]</span>
    <span class="n">duration_tf5</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>        <span class="c1"># Validity window in minutes (TF/5)</span>
    <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>       <span class="c1"># Threshold used for this decision</span>
    
    <span class="c1"># Audit trail</span>
    <span class="n">model_predictions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ModelPrediction</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">flux_details</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span> <span class="c1"># Physics metrics</span>
    <span class="n">weights_applied</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">timestamp</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
    <span class="n">override_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># e.g. &#39;majority_buy&#39;</span>
    
<div class="viewcode-block" id="CongressDecision.to_dict">
<a class="viewcode-back" href="../../api/core.html#core.congress_engine.CongressDecision.to_dict">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert to dictionary for storage&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;final_signal&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_signal</span><span class="p">,</span>
            <span class="s1">&#39;final_score&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_score</span><span class="p">,</span>
            <span class="s1">&#39;final_confidence&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_confidence</span><span class="p">,</span>
            <span class="s1">&#39;detected_regime&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">detected_regime</span><span class="p">,</span>
            <span class="s1">&#39;threshold&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">,</span>
            <span class="s1">&#39;certainty_boost&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">certainty_boost</span><span class="p">,</span>
            <span class="s1">&#39;trend_certainty&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">trend_certainty</span><span class="p">,</span>
            <span class="s1">&#39;duration_tf5&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">duration_tf5</span><span class="p">,</span>
            <span class="s1">&#39;model_predictions&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s1">&#39;model_name&#39;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">model_name</span><span class="p">,</span>
                    <span class="s1">&#39;model_role&#39;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">model_role</span><span class="o">.</span><span class="n">value</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">model_role</span><span class="p">,</span> <span class="n">AladdinPersona</span><span class="p">)</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">model_role</span><span class="p">),</span>
                    <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">score</span><span class="p">,</span>
                    <span class="s1">&#39;confidence&#39;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">confidence</span><span class="p">,</span>
                    <span class="s1">&#39;regime&#39;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">regime</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_predictions</span>
            <span class="p">],</span>
            <span class="s1">&#39;weights_applied&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights_applied</span><span class="p">,</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="s1">&#39;override_type&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">override_type</span><span class="p">,</span>
            <span class="s1">&#39;details&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">flux_details</span><span class="p">,</span> <span class="c1"># Expose details including Veto info</span>
        <span class="p">}</span></div>
</div>



<div class="viewcode-block" id="CongressEngine">
<a class="viewcode-back" href="../../api/core.html#core.congress_engine.CongressEngine">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CongressEngine</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Weighted ensemble aggregation with Aladdin &#39;Council of Experts&#39;.</span>
<span class="sd">    </span>
<span class="sd">    The Congress Engine combines model predictions using:</span>
<span class="sd">    FinalScore = (wi(regime, TF)  score_i  confidence_i) + CertaintyBoost</span>
<span class="sd">    </span>
<span class="sd">    Weights are adaptive based on:</span>
<span class="sd">    - Market regime (trend vs range)</span>
<span class="sd">    - Aladdin Persona (Expert Specialization)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># Default weights loaded from config</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">config.settings</span><span class="w"> </span><span class="kn">import</span> <span class="n">CONGRESS_WEIGHTS</span>
        <span class="n">DEFAULT_WEIGHTS</span> <span class="o">=</span> <span class="n">CONGRESS_WEIGHTS</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="c1"># Aladdin Weighted Mix (LEADER has highest weight, SENTINEL is robust backup)</span>
        <span class="n">DEFAULT_WEIGHTS</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;trend&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;quant&#39;</span><span class="p">:</span> <span class="mf">0.15</span><span class="p">,</span> <span class="s1">&#39;archivist&#39;</span><span class="p">:</span> <span class="mf">0.15</span><span class="p">,</span> <span class="s1">&#39;futurist&#39;</span><span class="p">:</span> <span class="mf">0.15</span><span class="p">,</span> <span class="s1">&#39;leader&#39;</span><span class="p">:</span> <span class="mf">0.35</span><span class="p">,</span> <span class="s1">&#39;sentinel&#39;</span><span class="p">:</span> <span class="mf">0.20</span><span class="p">},</span>
            <span class="s1">&#39;range&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;quant&#39;</span><span class="p">:</span> <span class="mf">0.15</span><span class="p">,</span> <span class="s1">&#39;archivist&#39;</span><span class="p">:</span> <span class="mf">0.15</span><span class="p">,</span> <span class="s1">&#39;futurist&#39;</span><span class="p">:</span> <span class="mf">0.20</span><span class="p">,</span> <span class="s1">&#39;leader&#39;</span><span class="p">:</span> <span class="mf">0.30</span><span class="p">,</span> <span class="s1">&#39;sentinel&#39;</span><span class="p">:</span> <span class="mf">0.20</span><span class="p">},</span>
        <span class="p">}</span>
    
    <span class="c1"># Base decision threshold</span>
    <span class="n">BASE_THRESHOLD</span> <span class="o">=</span> <span class="mf">0.07</span> <span class="c1"># Stricter for &quot;Certainty&quot;</span>
    
    <span class="c1"># Bayesian Fusion Constants</span>
    <span class="n">LAMBDA</span> <span class="o">=</span> <span class="mf">1.8</span>       <span class="c1"># Higher activation slope for decisive signals</span>
    <span class="n">KPI_GAMMA</span> <span class="o">=</span> <span class="mf">0.5</span>    <span class="c1"># Stronger Noble KPI influence</span>
    <span class="n">CERTAINTY_BONUS</span> <span class="o">=</span> <span class="mf">0.15</span> <span class="c1"># Bonus if all experts agree</span>
    
    
<div class="viewcode-block" id="CongressEngine.__init__">
<a class="viewcode-back" href="../../api/core.html#core.congress_engine.CongressEngine.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">custom_weights</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize Congress Engine.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            custom_weights: Optional custom weight configuration</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">custom_weights</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_WEIGHTS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decision_history</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">CongressDecision</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_scorer</span> <span class="o">=</span> <span class="n">get_model_scorer</span><span class="p">()</span>
        
        <span class="c1"># Model to role mapping for dynamic weights</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_role_map</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;xgboost&#39;</span><span class="p">:</span> <span class="s1">&#39;quant&#39;</span><span class="p">,</span>
            <span class="s1">&#39;lightgbm&#39;</span><span class="p">:</span> <span class="s1">&#39;archivist&#39;</span><span class="p">,</span>
            <span class="s1">&#39;randomforest&#39;</span><span class="p">:</span> <span class="s1">&#39;futurist&#39;</span><span class="p">,</span>
            <span class="s1">&#39;stacking&#39;</span><span class="p">:</span> <span class="s1">&#39;leader&#39;</span><span class="p">,</span>
            <span class="s1">&#39;catboost&#39;</span><span class="p">:</span> <span class="s1">&#39;sentinel&#39;</span><span class="p">,</span>
        <span class="p">}</span></div>

    
<div class="viewcode-block" id="CongressEngine.detect_market_regime">
<a class="viewcode-back" href="../../api/core.html#core.congress_engine.CongressEngine.detect_market_regime">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">detect_market_regime</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">adx_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">20.0</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Detect market regime using ADX and volatility.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            df: DataFrame with OHLC data</span>
<span class="sd">            adx_threshold: ADX threshold for trend detection</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            &#39;trend&#39; or &#39;range&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;range&#39;</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Calculate ADX</span>
            <span class="n">high</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span>
            <span class="n">low</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">]</span>
            <span class="n">close</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span>
            
            <span class="c1"># True Range</span>
            <span class="n">tr1</span> <span class="o">=</span> <span class="n">high</span> <span class="o">-</span> <span class="n">low</span>
            <span class="n">tr2</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">high</span> <span class="o">-</span> <span class="n">close</span><span class="o">.</span><span class="n">shift</span><span class="p">())</span>
            <span class="n">tr3</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">low</span> <span class="o">-</span> <span class="n">close</span><span class="o">.</span><span class="n">shift</span><span class="p">())</span>
            <span class="n">tr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">tr1</span><span class="p">,</span> <span class="n">tr2</span><span class="p">,</span> <span class="n">tr3</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            
            <span class="c1"># +DM and -DM</span>
            <span class="n">plus_dm</span> <span class="o">=</span> <span class="n">high</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
            <span class="n">minus_dm</span> <span class="o">=</span> <span class="o">-</span><span class="n">low</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
            <span class="n">plus_dm</span><span class="p">[</span><span class="n">plus_dm</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">minus_dm</span><span class="p">[</span><span class="n">minus_dm</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">plus_dm</span><span class="p">[(</span><span class="n">plus_dm</span> <span class="o">&lt;</span> <span class="n">minus_dm</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">minus_dm</span><span class="p">[(</span><span class="n">minus_dm</span> <span class="o">&lt;</span> <span class="n">plus_dm</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
            
            <span class="c1"># Smoothed values</span>
            <span class="n">period</span> <span class="o">=</span> <span class="mi">14</span>
            <span class="n">atr</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">plus_di</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">plus_dm</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">atr</span><span class="p">)</span>
            <span class="n">minus_di</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">minus_dm</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">atr</span><span class="p">)</span>
            
            <span class="c1"># ADX</span>
            <span class="n">dx</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">plus_di</span> <span class="o">-</span> <span class="n">minus_di</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">plus_di</span> <span class="o">+</span> <span class="n">minus_di</span> <span class="o">+</span> <span class="mf">1e-10</span><span class="p">)</span>
            <span class="n">adx</span> <span class="o">=</span> <span class="n">dx</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            
            <span class="n">current_adx</span> <span class="o">=</span> <span class="n">adx</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">adx</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">else</span> <span class="mi">0</span>
            
            <span class="c1"># Also check Noble regime</span>
            <span class="n">noble_regime</span> <span class="o">=</span> <span class="n">detect_regime</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
            
            <span class="c1"># Combine ADX with volatility regime</span>
            <span class="k">if</span> <span class="n">current_adx</span> <span class="o">&gt;</span> <span class="n">adx_threshold</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;trend&#39;</span>
            <span class="k">elif</span> <span class="n">noble_regime</span> <span class="ow">in</span> <span class="p">[</span><span class="n">MarketRegime</span><span class="o">.</span><span class="n">HIGH_VOL</span><span class="p">,</span> <span class="n">MarketRegime</span><span class="o">.</span><span class="n">CRISIS</span><span class="p">]:</span>
                <span class="k">return</span> <span class="s1">&#39;trend&#39;</span>  <span class="c1"># High volatility often means trending</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;range&#39;</span>
                
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Regime detection error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;range&#39;</span></div>

    
<div class="viewcode-block" id="CongressEngine.calculate_adaptive_threshold">
<a class="viewcode-back" href="../../api/core.html#core.congress_engine.CongressEngine.calculate_adaptive_threshold">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_adaptive_threshold</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">timeframe</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate adaptive decision threshold based on volatility.</span>
<span class="sd">        </span>
<span class="sd">        Higher volatility = higher threshold (more confident signals only)</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            df: DataFrame with OHLC data</span>
<span class="sd">            timeframe: Current timeframe</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Threshold  in [0.2, 0.5]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">BASE_THRESHOLD</span>
        
        <span class="c1"># Get base threshold from config if available</span>
        <span class="n">base_threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BASE_THRESHOLD</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;congress_config&#39;</span><span class="p">):</span>
             <span class="n">base_threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">congress_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;thresholds&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;range_base&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">BASE_THRESHOLD</span><span class="p">)</span>

        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">atr</span> <span class="o">=</span> <span class="n">calculate_atr</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
            <span class="n">current_atr</span> <span class="o">=</span> <span class="n">atr</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">avg_atr</span> <span class="o">=</span> <span class="n">atr</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            
            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">current_atr</span><span class="p">)</span> <span class="ow">or</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">avg_atr</span><span class="p">)</span> <span class="ow">or</span> <span class="n">avg_atr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">base_threshold</span>
            
            <span class="c1"># Volatility ratio</span>
            <span class="n">vol_ratio</span> <span class="o">=</span> <span class="n">current_atr</span> <span class="o">/</span> <span class="n">avg_atr</span>
            
            <span class="c1"># Scale threshold: higher vol = higher threshold</span>
            <span class="n">threshold</span> <span class="o">=</span> <span class="n">base_threshold</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.8</span> <span class="o">+</span> <span class="mf">0.4</span> <span class="o">*</span> <span class="nb">min</span><span class="p">(</span><span class="n">vol_ratio</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">))</span>
            
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">threshold</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Threshold calculation error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">base_threshold</span></div>

    
<div class="viewcode-block" id="CongressEngine.get_weights">
<a class="viewcode-back" href="../../api/core.html#core.congress_engine.CongressEngine.get_weights">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_weights</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">regime</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">timeframe</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span> <span class="c1"># Return Dict[str, float] for flexibility, or Dict[AladdinPersona, float]</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get weights for current regime and timeframe.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># DYNAMIC RELOAD: Refresh weights from config/DB on every call</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">config.settings</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_congress_weights</span><span class="p">,</span> <span class="n">get_congress_config</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">get_congress_weights</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">congress_config</span> <span class="o">=</span> <span class="n">get_congress_config</span><span class="p">()</span> <span class="c1"># Cache full config for rules</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">pass</span> <span class="c1"># Use existing self.weights</span>
            
        <span class="n">base_weights_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">regime</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;range&#39;</span><span class="p">,</span> <span class="p">{}))</span>
        
        <span class="c1"># Map string keys from config to AladdinPersona enums</span>
        <span class="c1"># Default config keys: &#39;quant&#39;, &#39;archivist&#39;, &#39;futurist&#39;</span>
        <span class="n">base_weights</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="c1"># Ensure we have defaults if config is missing keys</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">AladdinPersona</span><span class="o">.</span><span class="n">QUANT</span><span class="p">:</span> <span class="mf">0.25</span><span class="p">,</span>
            <span class="n">AladdinPersona</span><span class="o">.</span><span class="n">ARCHIVIST</span><span class="p">:</span> <span class="mf">0.25</span><span class="p">,</span>
            <span class="n">AladdinPersona</span><span class="o">.</span><span class="n">FUTURIST</span><span class="p">:</span> <span class="mf">0.15</span><span class="p">,</span>
            <span class="n">AladdinPersona</span><span class="o">.</span><span class="n">LEADER</span><span class="p">:</span> <span class="mf">0.35</span>
        <span class="p">}</span>
        
        <span class="c1"># Config Map: &quot;quant&quot; -&gt; AladdinPersona.QUANT</span>
        <span class="n">config_map</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;quant&quot;</span><span class="p">:</span> <span class="n">AladdinPersona</span><span class="o">.</span><span class="n">QUANT</span><span class="p">,</span>
            <span class="s2">&quot;archivist&quot;</span><span class="p">:</span> <span class="n">AladdinPersona</span><span class="o">.</span><span class="n">ARCHIVIST</span><span class="p">,</span>
            <span class="s2">&quot;futurist&quot;</span><span class="p">:</span> <span class="n">AladdinPersona</span><span class="o">.</span><span class="n">FUTURIST</span><span class="p">,</span>
            <span class="s2">&quot;guardian&quot;</span><span class="p">:</span> <span class="n">AladdinPersona</span><span class="o">.</span><span class="n">GUARDIAN</span><span class="p">,</span>
            <span class="s2">&quot;leader&quot;</span><span class="p">:</span> <span class="n">AladdinPersona</span><span class="o">.</span><span class="n">LEADER</span>
        <span class="p">}</span>
        
        <span class="c1"># Load from config or defaults</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">persona</span> <span class="ow">in</span> <span class="n">config_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">base_weights_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">base_weights</span><span class="p">[</span><span class="n">persona</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span> <span class="c1"># Store as value (str) for easier lookup in convene</span>
            <span class="k">else</span><span class="p">:</span>
                 <span class="c1"># Fallback to old keys? &#39;microstructure&#39; etc?</span>
                 <span class="k">pass</span>
                 
        <span class="c1"># If empty (likely due to migration), use hardcoded defaults based on regime</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">base_weights</span><span class="p">:</span>
             <span class="k">if</span> <span class="n">regime</span> <span class="o">==</span> <span class="s1">&#39;trend&#39;</span><span class="p">:</span>
                 <span class="n">base_weights</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;quant&#39;</span><span class="p">:</span> <span class="mf">0.20</span><span class="p">,</span> <span class="s1">&#39;archivist&#39;</span><span class="p">:</span> <span class="mf">0.20</span><span class="p">,</span> <span class="s1">&#39;futurist&#39;</span><span class="p">:</span> <span class="mf">0.15</span><span class="p">,</span> <span class="s1">&#39;leader&#39;</span><span class="p">:</span> <span class="mf">0.45</span><span class="p">}</span>
             <span class="k">else</span><span class="p">:</span>
                 <span class="n">base_weights</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;quant&#39;</span><span class="p">:</span> <span class="mf">0.20</span><span class="p">,</span> <span class="s1">&#39;archivist&#39;</span><span class="p">:</span> <span class="mf">0.20</span><span class="p">,</span> <span class="s1">&#39;futurist&#39;</span><span class="p">:</span> <span class="mf">0.25</span><span class="p">,</span> <span class="s1">&#39;leader&#39;</span><span class="p">:</span> <span class="mf">0.35</span><span class="p">}</span>
        
        <span class="c1"># Timeframe adjustments</span>
        <span class="n">tf_adjustments</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="c1"># Short timeframes: increase QUANT (Math/Microstructure) weight</span>
        <span class="k">if</span> <span class="n">timeframe</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;1m&#39;</span><span class="p">,</span> <span class="s1">&#39;5m&#39;</span><span class="p">,</span> <span class="s1">&#39;15m&#39;</span><span class="p">]:</span>
            <span class="n">tf_adjustments</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">AladdinPersona</span><span class="o">.</span><span class="n">QUANT</span><span class="o">.</span><span class="n">value</span><span class="p">:</span> <span class="mf">1.2</span><span class="p">,</span>
                <span class="n">AladdinPersona</span><span class="o">.</span><span class="n">ARCHIVIST</span><span class="o">.</span><span class="n">value</span><span class="p">:</span> <span class="mf">0.9</span><span class="p">,</span>
                <span class="n">AladdinPersona</span><span class="o">.</span><span class="n">FUTURIST</span><span class="o">.</span><span class="n">value</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="c1"># Long timeframes: increase FUTURIST (Context/Macro) weight</span>
        <span class="k">elif</span> <span class="n">timeframe</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;1d&#39;</span><span class="p">,</span> <span class="s1">&#39;1u&#39;</span><span class="p">]:</span> <span class="c1"># 1u = 1w? Assuming 1w</span>
            <span class="n">tf_adjustments</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">AladdinPersona</span><span class="o">.</span><span class="n">QUANT</span><span class="o">.</span><span class="n">value</span><span class="p">:</span> <span class="mf">0.7</span><span class="p">,</span>
                <span class="n">AladdinPersona</span><span class="o">.</span><span class="n">ARCHIVIST</span><span class="o">.</span><span class="n">value</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
                <span class="n">AladdinPersona</span><span class="o">.</span><span class="n">FUTURIST</span><span class="o">.</span><span class="n">value</span><span class="p">:</span> <span class="mf">1.3</span><span class="p">,</span>
            <span class="p">}</span>
        
        <span class="c1"># Apply adjustments</span>
        <span class="n">adjusted</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Iterate over known personas</span>
        <span class="n">known_personas</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">AladdinPersona</span><span class="p">]</span>
        
        <span class="k">for</span> <span class="n">role</span> <span class="ow">in</span> <span class="n">known_personas</span><span class="p">:</span>
            <span class="c1"># Get base weight (default 0 if not set, but we normalized later)</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">base_weights</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">role</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> 
            <span class="k">if</span> <span class="n">w</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">role</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;quant&#39;</span><span class="p">,</span> <span class="s1">&#39;archivist&#39;</span><span class="p">,</span> <span class="s1">&#39;futurist&#39;</span><span class="p">]:</span> <span class="n">w</span> <span class="o">=</span> <span class="mf">0.33</span> <span class="c1"># Safety</span>
            
            <span class="n">adj</span> <span class="o">=</span> <span class="n">tf_adjustments</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">role</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="n">adjusted</span><span class="p">[</span><span class="n">role</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span> <span class="o">*</span> <span class="n">adj</span>
        
        <span class="c1"># Normalize to sum to 1</span>
        <span class="n">total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">adjusted</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">total</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">adjusted</span> <span class="o">=</span> <span class="p">{</span><span class="n">role</span><span class="p">:</span> <span class="n">w</span> <span class="o">/</span> <span class="n">total</span> <span class="k">for</span> <span class="n">role</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">adjusted</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        
        <span class="c1"># === DYNAMIC WEIGHT ADJUSTMENT ===</span>
        <span class="c1"># Blend static weights with performance-based dynamic weights</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dynamic_weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_scorer</span><span class="o">.</span><span class="n">get_dynamic_weights</span><span class="p">(</span>
                <span class="n">adjusted</span><span class="p">,</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">model_role_map</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">dynamic_weights</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Congress] Dynamic weights fallback: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">adjusted</span></div>

    
<div class="viewcode-block" id="CongressEngine.aggregate">
<a class="viewcode-back" href="../../api/core.html#core.congress_engine.CongressEngine.aggregate">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">aggregate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">predictions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ModelPrediction</span><span class="p">],</span>
        <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">timeframe</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">smc_signals</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">flux_boost</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">flux_details</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CongressDecision</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Aggregate model predictions into final signal.</span>
<span class="sd">        With new Flux Boost (Physics) integration.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; CONGRESS AGGREGATION: </span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">predictions</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">CongressDecision</span><span class="p">(</span>
                <span class="n">final_signal</span><span class="o">=</span><span class="s1">&#39;NEUTRAL&#39;</span><span class="p">,</span>
                <span class="n">final_score</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                <span class="n">final_confidence</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                <span class="n">detected_regime</span><span class="o">=</span><span class="s1">&#39;range&#39;</span><span class="p">,</span>
                <span class="n">threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">BASE_THRESHOLD</span><span class="p">,</span>
            <span class="p">)</span>
        
        <span class="c1"># Detect regime</span>
        <span class="n">regime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_market_regime</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        
        <span class="c1"># Get adaptive threshold</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_adaptive_threshold</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">)</span>
        
        <span class="c1"># Get weights</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_weights</span><span class="p">(</span><span class="n">regime</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">)</span>
        
        <span class="c1"># === ALADDIN FUSION ENGINE (Certainty Upgrade) ===</span>
        <span class="c1"># Equation: Psi = tanh( lambda * [ Sum(w*S*C) + gamma*K + UnanimityBonus + FluxBoost] )</span>
        
        <span class="c1"># 1. Calculate Core Weighted Signal</span>
        <span class="n">core_signal</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">weights_sum</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">confidence_sum</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">details</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">weights_applied</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="c1"># Vote tracking for Certainty</span>
        <span class="n">vote_buy</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">vote_sell</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">vote_neutral</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">for</span> <span class="n">pred</span> <span class="ow">in</span> <span class="n">predictions</span><span class="p">:</span>
            <span class="c1"># Handle string vs Enum role (Robustness)</span>
            <span class="n">role_key</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">model_role</span><span class="o">.</span><span class="n">value</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">model_role</span><span class="p">,</span> <span class="n">AladdinPersona</span><span class="p">)</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">model_role</span><span class="p">)</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">role_key</span><span class="p">,</span> <span class="mf">0.33</span><span class="p">)</span>
            
            <span class="c1"># Use confidence as uncertainty proxy (Odds-like weighting)</span>
            <span class="c1"># Higher confidence^2 gives exponential weight to sure models</span>
            <span class="n">weighted_score</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">score</span> <span class="o">*</span> <span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">confidence</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
            
            <span class="n">core_signal</span> <span class="o">+=</span> <span class="n">w</span> <span class="o">*</span> <span class="n">weighted_score</span>
            <span class="n">weights_sum</span> <span class="o">+=</span> <span class="n">w</span>
            <span class="n">confidence_sum</span> <span class="o">+=</span> <span class="n">pred</span><span class="o">.</span><span class="n">confidence</span>
            <span class="n">weights_applied</span><span class="p">[</span><span class="n">pred</span><span class="o">.</span><span class="n">model_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span>
            
            <span class="c1"># Tally Votes for Certainty Check (Strict &gt; 0.1)</span>
            <span class="k">if</span> <span class="n">pred</span><span class="o">.</span><span class="n">score</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">:</span> <span class="n">vote_buy</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">pred</span><span class="o">.</span><span class="n">score</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">:</span> <span class="n">vote_sell</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">vote_neutral</span> <span class="o">+=</span> <span class="mi">1</span>
            
        <span class="c1"># Normalize core signal</span>
        <span class="k">if</span> <span class="n">weights_sum</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">core_signal</span> <span class="o">=</span> <span class="n">core_signal</span> <span class="o">/</span> <span class="n">weights_sum</span>
            
        <span class="c1"># 2. Integrate Noble KPI Bias (The &quot;K&quot; term - Guardian Input)</span>
        <span class="n">noble_bias</span> <span class="o">=</span> <span class="mf">0.0</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span> <span class="ow">and</span> <span class="s1">&#39;kpi_safe_high&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">last_row</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">close</span> <span class="o">=</span> <span class="n">last_row</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span>
                <span class="n">safe_high</span> <span class="o">=</span> <span class="n">last_row</span><span class="p">[</span><span class="s1">&#39;kpi_safe_high&#39;</span><span class="p">]</span>
                <span class="n">safe_low</span> <span class="o">=</span> <span class="n">last_row</span><span class="p">[</span><span class="s1">&#39;kpi_safe_low&#39;</span><span class="p">]</span>
                
                <span class="k">if</span> <span class="n">close</span> <span class="o">&gt;</span> <span class="n">safe_high</span><span class="p">:</span>
                    <span class="n">noble_bias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">KPI_GAMMA</span> <span class="o">*</span> <span class="mf">1.0</span>  <span class="c1"># Breakout Up -&gt; Push UP</span>
                <span class="k">elif</span> <span class="n">close</span> <span class="o">&lt;</span> <span class="n">safe_low</span><span class="p">:</span>
                    <span class="n">noble_bias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">KPI_GAMMA</span> <span class="o">*</span> <span class="o">-</span><span class="mf">1.0</span> <span class="c1"># Breakout Down -&gt; Push DOWN</span>

            <span class="c1"># 3. MAGIC LOGIC: Smart Money Overrides (The &quot;Forbidden&quot; Boost)</span>
            <span class="n">smc_boost</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">if</span> <span class="n">smc_signals</span><span class="p">:</span>
                <span class="c1"># Bullish Context: FVG + Bullish OB -&gt; Institutional Entry</span>
                <span class="k">if</span> <span class="n">smc_signals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fvg_bull&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">and</span> <span class="n">smc_signals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ob_bull&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                    <span class="n">smc_boost</span> <span class="o">+=</span> <span class="mf">0.30</span> <span class="c1"># Massive Boost (Golden Entry)</span>
                
                <span class="c1"># Bearish Context</span>
                <span class="k">if</span> <span class="n">smc_signals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fvg_bear&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">and</span> <span class="n">smc_signals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ob_bear&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                    <span class="n">smc_boost</span> <span class="o">-=</span> <span class="mf">0.30</span> <span class="c1"># Massive Drop</span>
                
                <span class="c1"># Liquidity Sweeps</span>
                <span class="k">if</span> <span class="n">smc_signals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sweep_bear&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="n">smc_boost</span> <span class="o">-=</span> <span class="mf">0.20</span>
                <span class="k">if</span> <span class="n">smc_signals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sweep_bull&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="n">smc_boost</span> <span class="o">+=</span> <span class="mf">0.20</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1"># 3b. FLUX BOOST (Physics of Price)</span>
        <span class="c1"># Directly added to the raw input of the tanh function</span>
        
        <span class="c1"># 4. SENTINEL VETO (CatBoost Safeguard)</span>
        <span class="c1"># If Sentinel strongly disagrees with the core signal, kill it.</span>
        <span class="c1"># This enforces the &quot;No Loss&quot; objective.</span>
        <span class="n">sentinel_veto</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">sentinel_signal</span> <span class="o">=</span> <span class="s2">&quot;NEUTRAL&quot;</span>
        
        <span class="k">for</span> <span class="n">pred</span> <span class="ow">in</span> <span class="n">predictions</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">model_role</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="s2">&quot;sentinel&quot;</span> <span class="ow">in</span> <span class="n">key</span> <span class="ow">or</span> <span class="n">pred</span><span class="o">.</span><span class="n">model_name</span> <span class="o">==</span> <span class="s2">&quot;catboost&quot;</span><span class="p">:</span>
                <span class="c1"># Check for strong disagreement</span>
                <span class="c1"># Logic: If Core is BUY (&gt;0.2) and Sentinel is SELL (score &lt; -0.3) -&gt; VETO</span>
                <span class="k">if</span> <span class="n">core_signal</span> <span class="o">&gt;</span> <span class="mf">0.2</span> <span class="ow">and</span> <span class="n">pred</span><span class="o">.</span><span class="n">score</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.3</span><span class="p">:</span>
                    <span class="n">sentinel_veto</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">sentinel_signal</span> <span class="o">=</span> <span class="s2">&quot;SELL&quot;</span>
                <span class="k">elif</span> <span class="n">core_signal</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.2</span> <span class="ow">and</span> <span class="n">pred</span><span class="o">.</span><span class="n">score</span> <span class="o">&gt;</span> <span class="mf">0.3</span><span class="p">:</span>
                    <span class="n">sentinel_veto</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">sentinel_signal</span> <span class="o">=</span> <span class="s2">&quot;BUY&quot;</span>
                    
        <span class="k">if</span> <span class="n">sentinel_veto</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; SENTINEL VETO APPLIED: Core=</span><span class="si">{</span><span class="n">core_signal</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, Sentinel=</span><span class="si">{</span><span class="n">sentinel_signal</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">details</span><span class="p">[</span><span class="s1">&#39;veto&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;sentinel_disagreement&#39;</span>
            <span class="n">details</span><span class="p">[</span><span class="s1">&#39;sentinel_signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sentinel_signal</span> <span class="c1"># Store what Sentinel saw</span>
            <span class="n">details</span><span class="p">[</span><span class="s1">&#39;core_signal_val&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">core_signal</span>     <span class="c1"># Store original core signal value</span>
            <span class="n">core_signal</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="c1"># Force Neutral</span>

        <span class="c1"># 5. Calculate Certainty Boost (Unanimity)</span>
        <span class="n">certainty_boost</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">total_votes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">total_votes</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">vote_buy</span> <span class="o">==</span> <span class="n">total_votes</span><span class="p">:</span>
                <span class="n">certainty_boost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CERTAINTY_BONUS</span> <span class="c1"># All Experts Agree BUY</span>
                <span class="n">details</span><span class="p">[</span><span class="s1">&#39;consensus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;unanimous_buy&#39;</span>
            <span class="k">elif</span> <span class="n">vote_sell</span> <span class="o">==</span> <span class="n">total_votes</span><span class="p">:</span>
                <span class="n">certainty_boost</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">CERTAINTY_BONUS</span> <span class="c1"># All Experts Agree SELL</span>
                <span class="n">details</span><span class="p">[</span><span class="s1">&#39;consensus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;unanimous_sell&#39;</span>
        
        <span class="c1"># === MASTER EQUATION ===</span>
        <span class="c1"># Psi = tanh( lambda * ( weighted_sum + noble_bias + certainty_boost + flux_boost ) )</span>
        
        <span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
        
        <span class="n">raw_input</span> <span class="o">=</span> <span class="p">(</span><span class="n">core_signal</span> <span class="o">+</span> <span class="n">noble_bias</span> <span class="o">+</span> <span class="n">certainty_boost</span> <span class="o">+</span> <span class="n">smc_boost</span> <span class="o">+</span> <span class="n">flux_boost</span><span class="p">)</span>
        <span class="n">final_score</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">LAMBDA</span> <span class="o">*</span> <span class="n">raw_input</span><span class="p">)</span>
        
        <span class="n">final_confidence</span> <span class="o">=</span> <span class="n">confidence_sum</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span> <span class="k">if</span> <span class="n">predictions</span> <span class="k">else</span> <span class="mf">0.0</span>
        
        <span class="c1"># --- ROI OPTIMIZATION: ADAPTIVE THRESHOLDS ---</span>
        <span class="c1"># Stricter thresholds for &quot;Only Gain&quot; policy</span>
        <span class="c1"># TUNING: Relaxed to 0.30 (from 0.40) to catch big moves while keeping safety</span>
        <span class="n">adj_threshold</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.30</span><span class="p">,</span> <span class="n">threshold</span><span class="p">)</span> 
        
        <span class="k">if</span> <span class="n">regime</span> <span class="o">==</span> <span class="s1">&#39;trend&#39;</span><span class="p">:</span>
            <span class="n">adj_threshold</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">threshold</span> <span class="o">-</span> <span class="mf">0.05</span><span class="p">)</span> 
        <span class="k">elif</span> <span class="n">regime</span> <span class="o">==</span> <span class="s1">&#39;panic&#39;</span><span class="p">:</span>
            <span class="n">adj_threshold</span> <span class="o">=</span> <span class="mf">0.60</span> <span class="c1"># Extremely Strict</span>
            
        <span class="c1"># Decision Logic</span>
        <span class="k">if</span> <span class="n">final_score</span> <span class="o">&gt;</span> <span class="n">adj_threshold</span><span class="p">:</span>
            <span class="n">final_signal</span> <span class="o">=</span> <span class="s1">&#39;BUY&#39;</span>
        <span class="k">elif</span> <span class="n">final_score</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">adj_threshold</span><span class="p">:</span>
            <span class="n">final_signal</span> <span class="o">=</span> <span class="s1">&#39;SELL&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">final_signal</span> <span class="o">=</span> <span class="s1">&#39;NEUTRAL&#39;</span>
            
        <span class="c1"># ... (Panic Protocol &amp; Overrides omitted for brevity, logic remains same)</span>
        <span class="c1"># Re-implementing simplified override checks for safety</span>
        
        <span class="n">rules</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;congress_config&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rules&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">override_active</span> <span class="o">=</span> <span class="n">rules</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;democratic_override&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">override_active</span> <span class="ow">and</span> <span class="n">regime</span> <span class="o">==</span> <span class="s1">&#39;range&#39;</span> <span class="ow">and</span> <span class="n">final_signal</span> <span class="o">==</span> <span class="s1">&#39;NEUTRAL&#39;</span><span class="p">:</span>
             <span class="k">if</span> <span class="n">vote_buy</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">vote_sell</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">sentinel_veto</span><span class="p">:</span>
                  <span class="n">final_signal</span> <span class="o">=</span> <span class="s1">&#39;BUY&#39;</span>
                  <span class="n">final_score</span> <span class="o">=</span> <span class="n">threshold</span> <span class="o">+</span> <span class="mf">0.02</span>
                  <span class="n">details</span><span class="p">[</span><span class="s1">&#39;override&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;democratic_override_buy&#39;</span>
                  <span class="n">certainty_boost</span> <span class="o">+=</span> <span class="mf">0.1</span>
             <span class="k">elif</span> <span class="n">vote_sell</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">vote_buy</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">sentinel_veto</span><span class="p">:</span>
                  <span class="n">final_signal</span> <span class="o">=</span> <span class="s1">&#39;SELL&#39;</span>
                  <span class="n">final_score</span> <span class="o">=</span> <span class="o">-</span><span class="n">threshold</span> <span class="o">-</span> <span class="mf">0.02</span>
                  <span class="n">details</span><span class="p">[</span><span class="s1">&#39;override&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;democratic_override_sell&#39;</span>
                  <span class="n">certainty_boost</span> <span class="o">-=</span> <span class="mf">0.1</span>
        
        <span class="c1"># --- TF/5 TREND CERTAINTY CALCULATION ---</span>
        <span class="c1"># (Existing robust certainty logic here...)</span>
        
        <span class="c1"># 1. Consensus (How many agree with the final signal)</span>
        <span class="n">agreeing_votes</span> <span class="o">=</span> <span class="n">vote_buy</span> <span class="k">if</span> <span class="n">final_signal</span> <span class="o">==</span> <span class="s1">&#39;BUY&#39;</span> <span class="k">else</span> <span class="n">vote_sell</span> <span class="k">if</span> <span class="n">final_signal</span> <span class="o">==</span> <span class="s1">&#39;SELL&#39;</span> <span class="k">else</span> <span class="n">vote_neutral</span>
        <span class="n">consensus_ratio</span> <span class="o">=</span> <span class="n">agreeing_votes</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span> <span class="k">if</span> <span class="n">predictions</span> <span class="k">else</span> <span class="mf">0.0</span>
        
        <span class="c1"># 2. Stability &amp; Exhaustion (Trend Health)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># RSI Analysis (FeatureEngine name: &#39;rsi&#39; fallback)</span>
            <span class="n">rsi_val</span> <span class="o">=</span> <span class="mf">50.0</span>
            <span class="k">if</span> <span class="s1">&#39;rsi&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span> <span class="n">rsi_val</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">elif</span> <span class="s1">&#39;trend_rsi&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span> <span class="n">rsi_val</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;trend_rsi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            
            <span class="n">overbought</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">rsi_val</span> <span class="o">-</span> <span class="mi">70</span><span class="p">)</span> <span class="k">if</span> <span class="n">final_signal</span> <span class="o">==</span> <span class="s1">&#39;BUY&#39;</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">oversold</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">30</span> <span class="o">-</span> <span class="n">rsi_val</span><span class="p">)</span> <span class="k">if</span> <span class="n">final_signal</span> <span class="o">==</span> <span class="s1">&#39;SELL&#39;</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">exhaustion_penalty</span> <span class="o">=</span> <span class="p">(</span><span class="n">overbought</span> <span class="o">+</span> <span class="n">oversold</span><span class="p">)</span> <span class="o">/</span> <span class="mf">30.0</span>
            
            <span class="c1"># Volatility</span>
            <span class="n">atr_val</span> <span class="o">=</span> <span class="mf">0.0010</span>
            <span class="k">if</span> <span class="s1">&#39;atr&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span> <span class="n">atr_val</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;atr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">elif</span> <span class="s1">&#39;vol_atr&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span> <span class="n">atr_val</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;vol_atr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            
            <span class="n">close</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">open_p</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">current_bar_move</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">close</span> <span class="o">-</span> <span class="n">open_p</span><span class="p">)</span>
            <span class="n">volatility_penalty</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">current_bar_move</span> <span class="o">/</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">atr_val</span><span class="p">))</span> <span class="k">if</span> <span class="n">atr_val</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
            
            <span class="c1"># ADX</span>
            <span class="n">adx_val</span> <span class="o">=</span> <span class="mf">25.0</span>
            <span class="k">if</span> <span class="s1">&#39;adx&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span> <span class="n">adx_val</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;adx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">elif</span> <span class="s1">&#39;trend_adx&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span> <span class="n">adx_val</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;trend_adx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            
            <span class="n">stability</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">adx_val</span> <span class="o">/</span> <span class="mf">50.0</span><span class="p">)</span> 
            
            <span class="n">penalty</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.6</span> <span class="o">*</span> <span class="n">exhaustion_penalty</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.4</span> <span class="o">*</span> <span class="n">volatility_penalty</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exhaustion analysis failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">stability</span> <span class="o">=</span> <span class="mf">0.5</span>
            <span class="n">penalty</span> <span class="o">=</span> <span class="mf">0.0</span>
            
        <span class="c1"># Formula: (Consensus*0.4) + (Confidence*0.3) + (Stability*0.3) - (Penalty*0.2)</span>
        <span class="n">trend_certainty</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.4</span> <span class="o">*</span> <span class="n">consensus_ratio</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.3</span> <span class="o">*</span> <span class="n">final_confidence</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.3</span> <span class="o">*</span> <span class="n">stability</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mf">0.2</span> <span class="o">*</span> <span class="n">penalty</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">final_signal</span> <span class="o">==</span> <span class="s1">&#39;NEUTRAL&#39;</span><span class="p">:</span>
             <span class="n">trend_certainty</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">trend_certainty</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">)</span>
        <span class="n">trend_certainty</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">trend_certainty</span><span class="p">))</span>
        
        <span class="c1"># 3. Dynamic Duration: Boost if very certain</span>
        <span class="n">tf_minutes</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;1m&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;5m&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;15m&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span> <span class="s1">&#39;30m&#39;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span> 
            <span class="s1">&#39;1h&#39;</span><span class="p">:</span> <span class="mi">60</span><span class="p">,</span> <span class="s1">&#39;4h&#39;</span><span class="p">:</span> <span class="mi">240</span><span class="p">,</span> <span class="s1">&#39;1d&#39;</span><span class="p">:</span> <span class="mi">1440</span><span class="p">,</span> <span class="s1">&#39;1w&#39;</span><span class="p">:</span> <span class="mi">10080</span>
        <span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeframe</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">trend_certainty</span> <span class="o">&gt;</span> <span class="mf">0.85</span><span class="p">:</span>
            <span class="n">duration_tf5</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tf_minutes</span> <span class="o">/</span> <span class="mf">4.0</span><span class="p">)</span> <span class="c1"># TF/4 boost</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">duration_tf5</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tf_minutes</span> <span class="o">/</span> <span class="mf">5.0</span><span class="p">)</span> <span class="c1"># Standard TF/5</span>
        <span class="n">duration_tf5</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">duration_tf5</span><span class="p">)</span>
        
        <span class="n">decision</span> <span class="o">=</span> <span class="n">CongressDecision</span><span class="p">(</span>
            <span class="n">final_signal</span><span class="o">=</span><span class="n">final_signal</span><span class="p">,</span>
            <span class="n">final_score</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">final_score</span><span class="p">),</span>
            <span class="n">final_confidence</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">final_confidence</span><span class="p">),</span>
            <span class="n">detected_regime</span><span class="o">=</span><span class="n">regime</span><span class="p">,</span>
            <span class="n">threshold</span><span class="o">=</span><span class="n">adj_threshold</span><span class="p">,</span>
            <span class="n">certainty_boost</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">certainty_boost</span><span class="p">),</span>
            <span class="n">trend_certainty</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">trend_certainty</span><span class="p">),</span> <span class="mi">3</span><span class="p">),</span>
            <span class="n">duration_tf5</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">duration_tf5</span><span class="p">),</span>
            <span class="n">model_predictions</span><span class="o">=</span><span class="n">predictions</span><span class="p">,</span>
            <span class="n">weights_applied</span><span class="o">=</span><span class="n">weights_applied</span><span class="p">,</span>
            <span class="n">override_type</span><span class="o">=</span><span class="n">details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;override&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;consensus&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;veto&#39;</span><span class="p">),</span>
            <span class="n">flux_details</span><span class="o">=</span><span class="n">details</span> <span class="c1"># Pass full details dict</span>
        <span class="p">)</span>
        
        <span class="c1"># Store in history</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decision_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">decision</span><span class="p">)</span>
        
        <span class="c1"># Keep history manageable</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">decision_history</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">decision_history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decision_history</span><span class="p">[</span><span class="o">-</span><span class="mi">500</span><span class="p">:]</span>
        
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   ALADDIN DECISION: </span><span class="si">{</span><span class="n">final_signal</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Score: </span><span class="si">{</span><span class="n">final_score</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> | Conf: </span><span class="si">{</span><span class="n">final_confidence</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> | Certainty: </span><span class="si">{</span><span class="n">certainty_boost</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> | Veto: </span><span class="si">{</span><span class="n">sentinel_veto</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">decision</span></div>

    
<div class="viewcode-block" id="CongressEngine.get_decision_history">
<a class="viewcode-back" href="../../api/core.html#core.congress_engine.CongressEngine.get_decision_history">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_decision_history</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get recent decision history as dicts&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">decision_history</span><span class="p">[</span><span class="o">-</span><span class="n">limit</span><span class="p">:]]</span></div>

    
<div class="viewcode-block" id="CongressEngine.simple_aggregate">
<a class="viewcode-back" href="../../api/core.html#core.congress_engine.CongressEngine.simple_aggregate">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">simple_aggregate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">predictions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span>
        <span class="n">timeframe</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;1h&quot;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Simple weighted aggregation using config.json weights.</span>
<span class="sd">        </span>
<span class="sd">        This is a simpler interface for the prediction engine that uses</span>
<span class="sd">        model names (xgboost, lightgbm, randomforest, stacking) instead of ModelRole.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            predictions: List of {model, signal, confidence}</span>
<span class="sd">            timeframe: For timeframe-specific weight profiles</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            {signal, confidence, score, details}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">config.settings</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_model_weights</span><span class="p">,</span> <span class="n">get_signal_thresholds</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">predictions</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;signal&quot;</span><span class="p">:</span> <span class="s2">&quot;NEUTRAL&quot;</span><span class="p">,</span>
                <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                <span class="s2">&quot;score&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="p">[]</span>
            <span class="p">}</span>
        
        <span class="c1"># Get weights from config</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">get_model_weights</span><span class="p">(</span><span class="n">timeframe</span><span class="p">)</span>
        <span class="n">thresholds</span> <span class="o">=</span> <span class="n">get_signal_thresholds</span><span class="p">()</span>
        
        <span class="c1"># Signal mapping</span>
        <span class="n">signal_map</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;SELL&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;NEUTRAL&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;BUY&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
        
        <span class="n">total_score</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">total_weight</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">details</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">pred</span> <span class="ow">in</span> <span class="n">predictions</span><span class="p">:</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">)</span>
            <span class="n">signal_str</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;signal&quot;</span><span class="p">,</span> <span class="s2">&quot;NEUTRAL&quot;</span><span class="p">)</span>
            <span class="n">signal_num</span> <span class="o">=</span> <span class="n">signal_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">signal_str</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">confidence</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;confidence&quot;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
            <span class="n">weight</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="mf">0.33</span><span class="p">)</span>
            
            <span class="n">contribution</span> <span class="o">=</span> <span class="n">weight</span> <span class="o">*</span> <span class="n">signal_num</span> <span class="o">*</span> <span class="n">confidence</span>
            <span class="n">total_score</span> <span class="o">+=</span> <span class="n">contribution</span>
            <span class="n">total_weight</span> <span class="o">+=</span> <span class="n">weight</span>
            
            <span class="n">details</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span>
                <span class="s2">&quot;signal&quot;</span><span class="p">:</span> <span class="n">signal_str</span><span class="p">,</span>
                <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">confidence</span><span class="p">,</span>
                <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="n">weight</span><span class="p">,</span>
                <span class="s2">&quot;contribution&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">contribution</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
            <span class="p">})</span>
        
        <span class="c1"># Normalize score</span>
        <span class="k">if</span> <span class="n">total_weight</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">normalized_score</span> <span class="o">=</span> <span class="n">total_score</span> <span class="o">/</span> <span class="n">total_weight</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">normalized_score</span> <span class="o">=</span> <span class="mf">0.0</span>
        
        <span class="c1"># Apply thresholds</span>
        <span class="n">buy_threshold</span> <span class="o">=</span> <span class="n">thresholds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;buy&quot;</span><span class="p">,</span> <span class="mf">0.30</span><span class="p">)</span>
        <span class="n">sell_threshold</span> <span class="o">=</span> <span class="n">thresholds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sell&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.30</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">normalized_score</span> <span class="o">&gt;=</span> <span class="n">buy_threshold</span><span class="p">:</span>
            <span class="n">final_signal</span> <span class="o">=</span> <span class="s2">&quot;BUY&quot;</span>
        <span class="k">elif</span> <span class="n">normalized_score</span> <span class="o">&lt;=</span> <span class="n">sell_threshold</span><span class="p">:</span>
            <span class="n">final_signal</span> <span class="o">=</span> <span class="s2">&quot;SELL&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">final_signal</span> <span class="o">=</span> <span class="s2">&quot;NEUTRAL&quot;</span>
        
        <span class="n">final_confidence</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">normalized_score</span><span class="p">),</span> <span class="mf">1.0</span><span class="p">)</span>
        
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Congress Simple: </span><span class="si">{</span><span class="n">final_signal</span><span class="si">}</span><span class="s2"> (score=</span><span class="si">{</span><span class="n">normalized_score</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;conf=</span><span class="si">{</span><span class="n">final_confidence</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, tf=</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;signal&quot;</span><span class="p">:</span> <span class="n">final_signal</span><span class="p">,</span>
            <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">final_confidence</span><span class="p">,</span>
            <span class="s2">&quot;score&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">normalized_score</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
                <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="n">details</span><span class="p">,</span>
                <span class="s2">&quot;timeframe&quot;</span><span class="p">:</span> <span class="n">timeframe</span><span class="p">,</span>
                <span class="s2">&quot;thresholds&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;buy&quot;</span><span class="p">:</span> <span class="n">buy_threshold</span><span class="p">,</span> <span class="s2">&quot;sell&quot;</span><span class="p">:</span> <span class="n">sell_threshold</span><span class="p">}</span>
            <span class="p">}</span></div>

        
<div class="viewcode-block" id="CongressEngine.make_decision_batch">
<a class="viewcode-back" href="../../api/core.html#core.congress_engine.CongressEngine.make_decision_batch">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">make_decision_batch</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">predictions_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> 
        <span class="n">regime_series</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
        <span class="n">atr_series</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
        <span class="n">timeframe</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">noble_bias_series</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Vectorized version of make_decision for Backtesting.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            predictions_df: DataFrame where cols are model names, rows are samples</span>
<span class="sd">            regime_series: Series of &#39;trend&#39; or &#39;range&#39; strings</span>
<span class="sd">            atr_series: Series of ATR values for adaptive threshold</span>
<span class="sd">            timeframe: Timeframe string</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            (signals, scores, confidences, thresholds) as numpy arrays</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">predictions_df</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n_samples</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
            
        <span class="c1"># 1. Initialize accumulators</span>
        <span class="n">weighted_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_samples</span><span class="p">)</span>
        <span class="n">total_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_samples</span><span class="p">)</span>
        
        <span class="c1"># 2. Iterate models (Vectorized per model)</span>
        <span class="k">for</span> <span class="n">model_name</span> <span class="ow">in</span> <span class="n">predictions_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">model_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_role_map</span><span class="p">:</span>
                <span class="k">continue</span>
                
            <span class="n">persona</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_role_map</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span>
            <span class="n">raw_scores</span> <span class="o">=</span> <span class="n">predictions_df</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            
            <span class="c1"># Mask for regimes</span>
            <span class="n">mask_trend</span> <span class="o">=</span> <span class="p">(</span><span class="n">regime_series</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="s1">&#39;trend&#39;</span><span class="p">)</span>
            <span class="n">mask_range</span> <span class="o">=</span> <span class="p">(</span><span class="n">regime_series</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="s1">&#39;range&#39;</span><span class="p">)</span>
            
            <span class="c1"># Get weights for this persona</span>
            <span class="n">w_trend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;trend&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">persona</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">)</span>
            <span class="n">w_range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;range&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">persona</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">)</span>
            
            <span class="c1"># Apply weights</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_samples</span><span class="p">)</span>
            <span class="n">weights</span><span class="p">[</span><span class="n">mask_trend</span><span class="p">]</span> <span class="o">=</span> <span class="n">w_trend</span>
            <span class="n">weights</span><span class="p">[</span><span class="n">mask_range</span><span class="p">]</span> <span class="o">=</span> <span class="n">w_range</span>
            
            <span class="c1"># Confidence weighting (score^2)</span>
            <span class="n">confidences</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">raw_scores</span><span class="p">)</span>
            <span class="n">dynamic_weights</span> <span class="o">=</span> <span class="n">weights</span> <span class="o">*</span> <span class="p">(</span><span class="n">confidences</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="c1"># Penalize low confidence heavily</span>
            
            <span class="n">weighted_scores</span> <span class="o">+=</span> <span class="n">raw_scores</span> <span class="o">*</span> <span class="n">dynamic_weights</span>
            <span class="n">total_weights</span> <span class="o">+=</span> <span class="n">dynamic_weights</span>
            
        <span class="c1"># 3. Final Aggregation</span>
        <span class="n">final_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_samples</span><span class="p">)</span>
        <span class="n">mask_valid</span> <span class="o">=</span> <span class="n">total_weights</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">final_scores</span><span class="p">[</span><span class="n">mask_valid</span><span class="p">]</span> <span class="o">=</span> <span class="n">weighted_scores</span><span class="p">[</span><span class="n">mask_valid</span><span class="p">]</span> <span class="o">/</span> <span class="n">total_weights</span><span class="p">[</span><span class="n">mask_valid</span><span class="p">]</span>
        
        <span class="c1"># --- FEATURE PARITY UPGRADE ---</span>
        <span class="c1"># 3b. Apply Noble Bias (if provided)</span>
        <span class="k">if</span> <span class="n">noble_bias_series</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">final_scores</span> <span class="o">+=</span> <span class="n">noble_bias_series</span>

        <span class="c1"># 3c. Unanimity Boost (Vectorized)</span>
        <span class="c1"># If all distinct models agree on sign, add boost</span>
        <span class="c1"># Exclude sentinel from unanimity causing (it&#39;s a vetoer)</span>
        <span class="n">voting_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">predictions_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s1">&#39;sentinel&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">and</span> <span class="n">c</span> <span class="o">!=</span> <span class="s1">&#39;catboost&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">voting_cols</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">votes</span> <span class="o">=</span> <span class="n">predictions_df</span><span class="p">[</span><span class="n">voting_cols</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="c1"># Check if all &gt; 0</span>
            <span class="n">all_buy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">votes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># Check if all &lt; 0</span>
            <span class="n">all_sell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">votes</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            
            <span class="n">final_scores</span><span class="p">[</span><span class="n">all_buy</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CERTAINTY_BONUS</span>
            <span class="n">final_scores</span><span class="p">[</span><span class="n">all_sell</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CERTAINTY_BONUS</span>

        <span class="c1"># 4. Adaptive Thresholds</span>
        <span class="c1"># Calculate volatility ratio (vectorized)</span>
        <span class="n">avg_atr</span> <span class="o">=</span> <span class="n">atr_series</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">avg_atr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">vol_ratios</span> <span class="o">=</span> <span class="n">atr_series</span><span class="o">.</span><span class="n">values</span> <span class="o">/</span> <span class="n">avg_atr</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vol_ratios</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_samples</span><span class="p">)</span>
            
        <span class="n">base_threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BASE_THRESHOLD</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;congress_config&#39;</span><span class="p">):</span>
             <span class="n">base_threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">congress_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;thresholds&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;range_base&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">BASE_THRESHOLD</span><span class="p">)</span>
             
        <span class="n">thresholds</span> <span class="o">=</span> <span class="n">base_threshold</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.8</span> <span class="o">+</span> <span class="mf">0.4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">vol_ratios</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">))</span>
        <span class="c1"># STRICT MODE: Minimum 0.30 threshold for Backtest to match Live Engine (Tuned down from 0.40)</span>
        <span class="n">thresholds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">thresholds</span><span class="p">,</span> <span class="mf">0.30</span><span class="p">,</span> <span class="mf">0.60</span><span class="p">)</span>

        <span class="c1"># 5. Sentinel Veto (Vectorized)</span>
        <span class="c1"># Filter out signals where CatBoost strongly disagrees</span>
        <span class="k">if</span> <span class="s1">&#39;catboost&#39;</span> <span class="ow">in</span> <span class="n">predictions_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">cat_scores</span> <span class="o">=</span> <span class="n">predictions_df</span><span class="p">[</span><span class="s1">&#39;catboost&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            
            <span class="c1"># Veto Logic: Core BUY (&gt;0.2) + CatBoost SELL (&lt;-0.3)</span>
            <span class="c1"># OR Core SELL (&lt;-0.2) + CatBoost BUY (&gt;0.3)</span>
            <span class="n">veto_buy</span> <span class="o">=</span> <span class="p">(</span><span class="n">final_scores</span> <span class="o">&gt;</span> <span class="mf">0.2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">cat_scores</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.3</span><span class="p">)</span>
            <span class="n">veto_sell</span> <span class="o">=</span> <span class="p">(</span><span class="n">final_scores</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">cat_scores</span> <span class="o">&gt;</span> <span class="mf">0.3</span><span class="p">)</span>
            <span class="n">veto_mask</span> <span class="o">=</span> <span class="n">veto_buy</span> <span class="o">|</span> <span class="n">veto_sell</span>
            
            <span class="c1"># Apply Veto (Zero out scores)</span>
            <span class="n">final_scores</span><span class="p">[</span><span class="n">veto_mask</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="c1"># 6. Signal Generation</span>
        <span class="n">signals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="s2">&quot;NEUTRAL&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
        
        <span class="c1"># Buy Logic</span>
        <span class="n">mask_buy</span> <span class="o">=</span> <span class="n">final_scores</span> <span class="o">&gt;</span> <span class="n">thresholds</span>
        <span class="n">signals</span><span class="p">[</span><span class="n">mask_buy</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;BUY&quot;</span>
        
        <span class="c1"># Sell Logic</span>
        <span class="n">mask_sell</span> <span class="o">=</span> <span class="n">final_scores</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">thresholds</span>
        <span class="n">signals</span><span class="p">[</span><span class="n">mask_sell</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;SELL&quot;</span>
        
        <span class="c1"># --- DEMOCRATIC OVERRIDE (Features Parity) ---</span>
        <span class="c1"># If Range Regime + Neutral + 2 Votes -&gt; Force Trade</span>
        <span class="n">rules</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;congress_config&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rules&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="n">rules</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;democratic_override&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
             <span class="c1"># Identify Range Regime rows</span>
             <span class="n">is_range</span> <span class="o">=</span> <span class="p">(</span><span class="n">regime_series</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="s1">&#39;range&#39;</span><span class="p">)</span>
             <span class="n">is_neutral</span> <span class="o">=</span> <span class="p">(</span><span class="n">signals</span> <span class="o">==</span> <span class="s2">&quot;NEUTRAL&quot;</span><span class="p">)</span>
             
             <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">voting_cols</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                  <span class="c1"># Count votes &gt; 0 and &lt; 0</span>
                  <span class="n">vote_counts_buy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">votes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                  <span class="n">vote_counts_sell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">votes</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                  
                  <span class="c1"># Override Buy: Range + Neutral + 2 Buys + 0 Sells + No Veto</span>
                  <span class="n">mask_override_buy</span> <span class="o">=</span> <span class="p">(</span>
                      <span class="n">is_range</span> <span class="o">&amp;</span> <span class="n">is_neutral</span> <span class="o">&amp;</span> 
                      <span class="p">(</span><span class="n">vote_counts_buy</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">vote_counts_sell</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> 
                      <span class="p">(</span><span class="o">~</span><span class="n">veto_mask</span> <span class="k">if</span> <span class="s1">&#39;veto_mask&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span> <span class="k">else</span> <span class="kc">True</span><span class="p">)</span>
                  <span class="p">)</span>
                  <span class="n">signals</span><span class="p">[</span><span class="n">mask_override_buy</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;BUY&quot;</span>
                  <span class="c1"># Boost score slightly to reflect override</span>
                  <span class="n">final_scores</span><span class="p">[</span><span class="n">mask_override_buy</span><span class="p">]</span> <span class="o">=</span> <span class="n">thresholds</span><span class="p">[</span><span class="n">mask_override_buy</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.02</span>
                  
                  <span class="c1"># Override Sell: Range + Neutral + 2 Sells + 0 Buys + No Veto</span>
                  <span class="n">mask_override_sell</span> <span class="o">=</span> <span class="p">(</span>
                      <span class="n">is_range</span> <span class="o">&amp;</span> <span class="n">is_neutral</span> <span class="o">&amp;</span> 
                      <span class="p">(</span><span class="n">vote_counts_sell</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">vote_counts_buy</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> 
                      <span class="p">(</span><span class="o">~</span><span class="n">veto_mask</span> <span class="k">if</span> <span class="s1">&#39;veto_mask&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span> <span class="k">else</span> <span class="kc">True</span><span class="p">)</span>
                  <span class="p">)</span>
                  <span class="n">signals</span><span class="p">[</span><span class="n">mask_override_sell</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;SELL&quot;</span>
                  <span class="n">final_scores</span><span class="p">[</span><span class="n">mask_override_sell</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">thresholds</span><span class="p">[</span><span class="n">mask_override_sell</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.02</span>
        
        <span class="c1"># Calculate final confidence</span>
        <span class="n">final_confidences</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">final_scores</span><span class="p">)</span>

        <span class="c1"># 7. Certainty Boost (Bonus if strong agreement)</span>
        <span class="c1"># Vectorized boost application</span>
        <span class="c1"># If final score is strong (&gt;0.7), add boost</span>
        <span class="n">mask_boost</span> <span class="o">=</span> <span class="n">final_confidences</span> <span class="o">&gt;</span> <span class="mf">0.7</span>
        <span class="n">final_scores</span><span class="p">[</span><span class="n">mask_boost</span><span class="p">]</span> <span class="o">*=</span> <span class="mf">1.15</span> <span class="c1"># 15% boost</span>
        <span class="c1"># Re-clip to [-1, 1]</span>
        <span class="n">final_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">final_scores</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="n">final_confidences</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">final_scores</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">signals</span><span class="p">,</span> <span class="n">final_scores</span><span class="p">,</span> <span class="n">final_confidences</span><span class="p">,</span> <span class="n">thresholds</span></div>

        
<div class="viewcode-block" id="CongressEngine.aggregate_with_regime">
<a class="viewcode-back" href="../../api/core.html#core.congress_engine.CongressEngine.aggregate_with_regime">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">aggregate_with_regime</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">predictions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span>
        <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">timeframe</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;1h&quot;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Weighted aggregation with regime classification.</span>
<span class="sd">        </span>
<span class="sd">        Combines simple_aggregate with RegimeClassifier output.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            predictions: List of {model, signal, confidence}</span>
<span class="sd">            df: OHLC DataFrame for regime detection</span>
<span class="sd">            timeframe: Current timeframe</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Dict with signal, regime, and full audit trail</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">core.regime_classifier</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_regime_classifier</span>
        
        <span class="c1"># Get base aggregation</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simple_aggregate</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">)</span>
        
        <span class="c1"># Add regime classification</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">classifier</span> <span class="o">=</span> <span class="n">get_regime_classifier</span><span class="p">()</span>
            <span class="n">regime_result</span> <span class="o">=</span> <span class="n">classifier</span><span class="o">.</span><span class="n">classify</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
            
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;regime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">regime_result</span><span class="o">.</span><span class="n">regime</span><span class="o">.</span><span class="n">value</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;regime_confidence&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">regime_result</span><span class="o">.</span><span class="n">confidence</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;regime_details&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;adx&quot;</span><span class="p">:</span> <span class="n">regime_result</span><span class="o">.</span><span class="n">adx</span><span class="p">,</span>
                <span class="s2">&quot;atr_ratio&quot;</span><span class="p">:</span> <span class="n">regime_result</span><span class="o">.</span><span class="n">atr_ratio</span><span class="p">,</span>
                <span class="s2">&quot;sma_alignment&quot;</span><span class="p">:</span> <span class="n">regime_result</span><span class="o">.</span><span class="n">sma_alignment</span>
            <span class="p">}</span>
            
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Congress+Regime: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> | &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Regime=</span><span class="si">{</span><span class="n">regime_result</span><span class="o">.</span><span class="n">regime</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2"> (conf=</span><span class="si">{</span><span class="n">regime_result</span><span class="o">.</span><span class="n">confidence</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Regime classification failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;regime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;unknown&quot;</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;regime_confidence&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;regime_details&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
        
        <span class="k">return</span> <span class="n">result</span></div>

    
<div class="viewcode-block" id="CongressEngine.full_aggregate">
<a class="viewcode-back" href="../../api/core.html#core.congress_engine.CongressEngine.full_aggregate">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">full_aggregate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">predictions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span>
        <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">timeframe</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;1h&quot;</span><span class="p">,</span>
        <span class="n">current_price</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">safe_low</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">safe_high</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Complete prediction pipeline with all features.</span>
<span class="sd">        </span>
<span class="sd">        Combines:</span>
<span class="sd">        1. Weighted aggregation (configurable weights)</span>
<span class="sd">        2. Regime classification</span>
<span class="sd">        3. Risk filter validation (KPI bounds, volatility, momentum)</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            predictions: List of {model, signal, confidence}</span>
<span class="sd">            df: OHLC DataFrame</span>
<span class="sd">            timeframe: Current timeframe</span>
<span class="sd">            current_price: Current market price (for KPI check)</span>
<span class="sd">            safe_low: KPI Safe Low bound</span>
<span class="sd">            safe_high: KPI Safe High bound</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Complete prediction dict with all audit info</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Step 1: Get aggregation with regime</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregate_with_regime</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">)</span>
        
        <span class="c1"># === FUSION STEP 2: NOBLE KPI BIAS INTEGRATION ===</span>
        <span class="c1"># Psi_Final = tanh( Psi_Technical + Gamma * KPI_Bias )</span>
        
        <span class="k">if</span> <span class="n">current_price</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">safe_low</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">safe_high</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
             <span class="c1"># Calculate KPI Zone</span>
             <span class="n">kpi_bias</span> <span class="o">=</span> <span class="mf">0.0</span>
             <span class="k">if</span> <span class="n">current_price</span> <span class="o">&gt;</span> <span class="n">safe_high</span><span class="p">:</span>
                 <span class="n">kpi_bias</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span> <span class="c1"># Overbought -&gt; Bias Down</span>
             <span class="c1"># Apply Master Equation</span>
             <span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
             
             <span class="c1"># ALIGNMENT FIX: </span>
             <span class="c1"># Training maps Breakout &gt; SafeHigh as BUY (Trend Following)</span>
             <span class="c1"># Training maps Breakout &lt; SafeLow as SELL (Trend Following)</span>
             <span class="c1"># We must match this logic here. </span>
             <span class="c1"># Previously it was negative (Mean Reversion), which fought the models.</span>
             
             <span class="k">if</span> <span class="n">current_price</span> <span class="o">&gt;</span> <span class="n">safe_high</span><span class="p">:</span>
                 <span class="n">kpi_bias</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># Breakout Up -&gt; Push UP (BUY)</span>
             <span class="k">elif</span> <span class="n">current_price</span> <span class="o">&lt;</span> <span class="n">safe_low</span><span class="p">:</span>
                 <span class="n">kpi_bias</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span> <span class="c1"># Breakout Down -&gt; Push DOWN (SELL)</span>
             <span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
             <span class="n">raw_score</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="c1"># This is technically Tanh(Technical) already</span>
             <span class="c1"># We un-tanh it roughly or just add to it (since tanh(a+b) != tanh(a)+b)</span>
             <span class="c1"># Better: Recalculate Psi using the stored details if possible, </span>
             <span class="c1"># or simply apply bias to the final score in a second activation pass (ResNet style)</span>
             
             <span class="c1"># Psi_Final = tanh( arctanh(score) + Gamma * K )</span>
             <span class="c1"># Stable approximation:</span>
             <span class="n">psi_final</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KPI_GAMMA</span> <span class="o">*</span> <span class="n">kpi_bias</span><span class="p">)</span> <span class="p">)</span>
             
             <span class="n">result</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">psi_final</span>
             <span class="n">result</span><span class="p">[</span><span class="s1">&#39;noble_bias_applied&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kpi_bias</span>
             
             <span class="c1"># Re-evaluate Signal based on new Score</span>
             <span class="n">threshold</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;threshold&#39;</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">)</span>
             <span class="n">new_signal</span> <span class="o">=</span> <span class="s2">&quot;NEUTRAL&quot;</span>
             <span class="k">if</span> <span class="n">psi_final</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">:</span> <span class="n">new_signal</span> <span class="o">=</span> <span class="s2">&quot;BUY&quot;</span>
             <span class="k">elif</span> <span class="n">psi_final</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">threshold</span><span class="p">:</span> <span class="n">new_signal</span> <span class="o">=</span> <span class="s2">&quot;SELL&quot;</span>
             
             <span class="k">if</span> <span class="n">new_signal</span> <span class="o">!=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]:</span>
                 <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Noble KPI Adjusted Signal: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">new_signal</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                 <span class="n">result</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_signal</span>
        
        <span class="c1"># Step 2: Apply risk filter if we have price data</span>
        <span class="k">if</span> <span class="n">current_price</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">core.risk_filter</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_risk_filter</span>
            
            <span class="k">try</span><span class="p">:</span>
                <span class="n">risk_filter</span> <span class="o">=</span> <span class="n">get_risk_filter</span><span class="p">()</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">risk_filter</span><span class="o">.</span><span class="n">apply_to_congress_result</span><span class="p">(</span>
                    <span class="n">result</span><span class="p">,</span>
                    <span class="n">current_price</span><span class="o">=</span><span class="n">current_price</span><span class="p">,</span>
                    <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
                    <span class="n">safe_low</span><span class="o">=</span><span class="n">safe_low</span><span class="p">,</span>
                    <span class="n">safe_high</span><span class="o">=</span><span class="n">safe_high</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Risk filter failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">result</span><span class="p">[</span><span class="s2">&quot;risk_check&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
        
        <span class="c1"># Add timestamp</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Full Congress: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> | &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Score=</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> | &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Regime=</span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;regime&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> | &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Risk=</span><span class="si">{</span><span class="s1">&#39;PASS&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;risk_check&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;is_valid&#39;</span><span class="p">,</span><span class="w"> </span><span class="kc">True</span><span class="p">)</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;FAIL&#39;</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">result</span></div>

    
<div class="viewcode-block" id="CongressEngine.save_prediction_json">
<a class="viewcode-back" href="../../api/core.html#core.congress_engine.CongressEngine.save_prediction_json">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save_prediction_json</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">result</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
        <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;EURUSD&quot;</span><span class="p">,</span>
        <span class="n">output_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save prediction result to JSON file.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            result: Prediction result from full_aggregate</span>
<span class="sd">            symbol: Trading symbol</span>
<span class="sd">            output_dir: Output directory (default: data/signals)</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Path to saved file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">config.settings</span><span class="w"> </span><span class="kn">import</span> <span class="n">SIGNALS_DIR</span>
        
        <span class="c1"># Determine output path</span>
        <span class="k">if</span> <span class="n">output_dir</span><span class="p">:</span>
            <span class="n">out_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out_path</span> <span class="o">=</span> <span class="n">SIGNALS_DIR</span>
        
        <span class="n">out_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="c1"># Create filename with timestamp</span>
        <span class="n">timeframe</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;timeframe&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">)</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">_%H%M%S&quot;</span><span class="p">)</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">.json&quot;</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="n">out_path</span> <span class="o">/</span> <span class="n">filename</span>
        
        <span class="c1"># Add metadata</span>
        <span class="n">output</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;symbol&quot;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
            <span class="s2">&quot;generated_at&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;2.0&quot;</span><span class="p">,</span>
            <span class="o">**</span><span class="n">result</span>
        <span class="p">}</span>
        
        <span class="c1"># Save</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
        
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved prediction to </span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Also save a &quot;latest&quot; file for easy access</span>
        <span class="n">latest_path</span> <span class="o">=</span> <span class="n">out_path</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">_latest.json&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">latest_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span></div>
</div>



<span class="c1"># Singleton instance</span>
<span class="n">_congress_engine</span> <span class="o">=</span> <span class="kc">None</span>


<div class="viewcode-block" id="get_congress_engine">
<a class="viewcode-back" href="../../api/core.html#core.congress_engine.get_congress_engine">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_congress_engine</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">CongressEngine</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get or create Congress Engine singleton&quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">_congress_engine</span>
    <span class="k">if</span> <span class="n">_congress_engine</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_congress_engine</span> <span class="o">=</span> <span class="n">CongressEngine</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">_congress_engine</span></div>

</pre>
                            </div>

                        </div>
                    </div>
                    <footer>

                        <hr />

                        <div role="contentinfo">
                            <p>&#169; Copyright 2026, BMZ Business, LLC.</p>
                        </div>

                        Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
                        <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
                        provided by <a href="https://readthedocs.org">Read the Docs</a>.


                    </footer>
                </div>
            </div>
        </section>
    </div>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>

</html>